---
title: ä½¿ç”¨ SSE æ›¿ä»£è½®è¯¢
date: 2021-10-09 22:00:50
tags:
    - Javascript
    - NodeJs
    - HTTP
dir: http
keywords:
    - Server-sent events
    - æœåŠ¡å™¨å‘é€äº‹ä»¶
---

# ğŸ“ èƒŒæ™¯
æµè§ˆå™¨å’ŒæœåŠ¡ç«¯äº¤äº’è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰æœåŠ¡ç«¯å‘æµè§ˆå™¨é€šä¿¡çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼šæœåŠ¡ç«¯å¼‚æ­¥å¤„ç†ä¿¡æ¯ï¼Œå¤„ç†æˆåŠŸåå‘æµè§ˆå™¨æ¨é€ã€‚

ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„åå°æœåŠ¡éƒ½å»ºç«‹äº† `websocket` é€šé“ï¼Œå› æ­¤å¸¸ç”¨åšæ³•æ˜¯æµè§ˆå™¨å®šæ—¶æŸ¥è¯¢ï¼Œ`è½®è¯¢`åå°æ•°æ®ã€‚

ä»è¯·æ±‚çš„è§’åº¦æ¥çœ‹ï¼Œ`è½®è¯¢`å¤šä½™äº†æµè§ˆå™¨å‘åå°æœåŠ¡`å‘èµ·æ¡æ‰‹`ã€`å‘é€æ•°æ®åŒ…`çš„è¿‡ç¨‹ï¼Œå› æ­¤å¹¶ä¸ç®€æ´ã€ä¼˜é›…ã€‚

é‚£æœ‰æ²¡æœ‰æ—¢ä¸éœ€è¦ `websocket` é€šé“ï¼Œåˆä¸ç”¨`è½®è¯¢`è¿™ä¹ˆ â€œlowâ€ çš„æ–¹æ³•å‘¢ï¼Ÿæœ¬æ–‡ä»‹ç»çš„ `SSE` (server-site events) å°±è¶³å¤Ÿç®€æ´å’Œä¼˜é›…ã€‚

# ğŸ¤”ï¸ SSE æ˜¯å•¥

`SSE` å…¨ç§°æ˜¯ Server-sent events(æœåŠ¡å™¨å‘é€äº‹ä»¶)ï¼Œæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚

`SSE` çš„æœ¬è´¨æ˜¯é€šè¿‡ `HTTP` è¯·æ±‚ï¼Œä¸æ–­å‘é€ `æµä¿¡æ¯(streaming)`ï¼Œä½¿å¾—æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ã€‚ç±»ä¼¼äºè§†é¢‘æµã€‚

ä»–ä¸æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¼šä¸€ç›´ç­‰ç€æœåŠ¡ç«¯çš„æ¨é€ã€‚å› æ­¤å®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œç­‰ç€æœåŠ¡ç«¯çš„ä¸æ–­æ¨é€ã€‚è¿™æ ·å°±å®ç°äº†æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯çš„æ¨é€ã€‚

# ğŸ†š SSE VS Websocket
`Websocket` æ˜¯åŒå‘é€šä¿¡(å…¨åŒå·¥)ï¼Œæµè§ˆå™¨ <-> æœåŠ¡ç«¯ç›¸äº’é€šä¿¡ï¼Œæ›´å¼ºå¤§ä¹Ÿæ›´çµæ´»ã€‚

`SSE` æ˜¯å•å‘é€šä¿¡(åŠåŒå·¥)ï¼Œæµè§ˆå™¨ <- æœåŠ¡ç«¯ï¼Œæœ¬è´¨æ˜¯ä¸‹è½½ä¿¡æ¯ã€‚

| å¯¹æ¯”   | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| ---- | ----  | ---- |
| `Websocket`  | 1. å…¨åŒå·¥ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§<br/> | 1.è¾ƒä¸ºå¤æ‚ï¼ŒæœåŠ¡ç«¯éœ€è¦é‡æ–°æ”¯æŒ<br/>2.æ–­çº¿é‡è¿éœ€è¦é¢å¤–éƒ¨ç½² |
| `SSE`  | 1.åè®®è½»é‡ï¼Œæ”¯æŒ HTTP çš„æœåŠ¡ç«¯å°±æ”¯æŒ<br/>2.æ–¹ä¾¿é»˜è®¤æ”¯æŒæ–­çº¿é‡è¿<br/>3.æ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹ | 1.åŠåŒå·¥ï¼Œä¸å¤Ÿçµæ´» |

ä¸¤è€…å„æœ‰ç‰¹ç‚¹ï¼Œé€‚åˆä¸åŒåœºæ‰€

# ğŸ’¡ SSE çš„ä½¿ç”¨
æ—¢ç„¶ `SSE` ä½œç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œä¸‹é¢åˆ†ä¸º`å®¢æˆ·ç«¯`å’Œ`æœåŠ¡ç«¯`æ¥åˆ†åˆ«ä»‹ç» `API`ã€‚

## æµè§ˆå™¨çš„ä½¿ç”¨

### æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨
`SSE` åœ¨æµè§ˆå™¨ä¸­çš„APIåœ¨ `EventSource` å¯¹è±¡ä¸Šã€‚é€šè¿‡è¿™æ ·æ¥æ£€æµ‹æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼Œé€šå¸¸æ¥è®²ï¼Œé™¤äº† IE\Edgeï¼Œä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒï¼š
```js
if (Boolean(window.EventSource)) {
  // ...
}
```

### å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥
æµè§ˆå™¨å…ˆç”Ÿæˆ `EventSource` å®ä¾‹ï¼Œå†å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ã€‚

å½“ç„¶ï¼Œurl å¯ä»¥æ˜¯å½“å‰ç½‘å€åŒåŸŸï¼Œä¹Ÿå¯ä»¥è·¨åŸŸã€‚
```js
// åŒç½‘å€
let source = new EventSource(url);

// è·¨åŸŸå¸¦ä¸Š cookieã€‚ æ‰“å¼€withCredentialså±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦ä¸€èµ·å‘é€ Cookieã€‚
let source = new EventSource(url, { withCredentials: true });
```

### çŠ¶æ€å˜åŒ–
`EventSource` å®ä¾‹ä¸­ `readyState` å±æ€§è¡¨æ˜äº†å½“å‰è¿æ¥çŠ¶æ€ã€‚å¯ä»¥å–ä»¥ä¸‹å€¼ã€‚

| å–å€¼ | è§£é‡Š |
| --- | --- |
| `0` | è¡¨ç¤ºè¿æ¥è¿˜æœªå»ºç«‹ï¼Œæˆ–è€…æ–­çº¿æ­£åœ¨é‡è¿ |
| `1` | è¡¨ç¤ºè¿æ¥å·²ç»å»ºç«‹ï¼Œå¯ä»¥æ¥å—æ•°æ® |
| `2` | è¡¨ç¤ºè¿æ¥å·²æ–­ï¼Œä¸”ä¸ä¼šé‡è¿ |

### åŸºæœ¬ä½¿ç”¨
- `å»ºç«‹è¿æ¥æ—¶`ï¼Œä¼šè§¦å‘ `open` äº‹ä»¶ï¼Œå’Œ `js` å…¶ä»–äº‹ä»¶ç”¨æ³•åŸºæœ¬ä¸€è‡´
```js
// onopen å†™æ³•
source.onopen = (event) => {
    // ...
}

// addEventListener
source.addEventListener('open', (event) => {
  // ...
}, false);
```

- `æ”¶åˆ°æ¶ˆæ¯æ—¶`ï¼Œä¼šè§¦å‘ `message` äº‹ä»¶ï¼Œå’Œ `js` å…¶ä»–äº‹ä»¶ç”¨æ³•åŸºæœ¬ä¸€è‡´ã€‚
```js
// onmessage å†™æ³•
source.onmessage = (event) => {
  const data = event.data;
  // ...
};

// addEventListener
source.addEventListener('message', (event) => {
  // data æ˜¯æœåŠ¡å™¨å›ä¼ çš„æ•°æ®ï¼Œæ˜¯ æ–‡æœ¬æ ¼å¼ï¼ŒäºŒè¿›åˆ¶éœ€è¦é‡æ–°è½¬ç 
  const data = event.data;
  // ...
}, false);
```

- `å‘ç”Ÿé”™è¯¯æ—¶`(ä¾‹å¦‚ä¸­æ–­)ï¼Œä¼šè§¦å‘ `error` äº‹ä»¶ï¼Œå’Œ `js` å…¶ä»–äº‹ä»¶ç”¨æ³•åŸºæœ¬ä¸€è‡´ã€‚
```js
// onerror å†™æ³•
source.onerror = (event) => {
  // ...
};

// addEventListener
source.addEventListener('error', (event) => {
  // ...
}, false);
```

- `å…³é—­è¿æ¥`
```js
source.close();
```

- `è‡ªå®šä¹‰äº‹ä»¶`, é»˜è®¤æƒ…å†µä¸‹è§¦å‘çš„æ˜¯ `message` äº‹ä»¶ï¼Œä½†æ˜¯è¿˜èƒ½è‡ªå®šä¹‰äº‹ä»¶ï¼Œä»è€Œä¸è§¦å‘ `message` äº‹ä»¶ã€‚æœ¬ä¾‹å­å¯¹ `info` äº‹ä»¶è¿›è¡Œç›‘å¬
```js
source.addEventListener('info', (event) => {
  const data = event.data;
  // ...
}, false);
```

## æœåŠ¡ç«¯çš„ä½¿ç”¨
### è¯·æ±‚å¤´
æœåŠ¡ç«¯çš„å‘æµè§ˆå™¨å‘é€çš„æ•°æ®æ˜¯ `UTF-8` çš„ç¼–ç æ–‡æœ¬ï¼Œ`HTTP` å¤´å…·æœ‰ç‰¹å®šçš„ä¿¡æ¯ã€‚
å¿…é¡»æŒ‡å®š `Content-Type` ç±»å‹ä¸º `event-steam`ã€‚
```
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
```
![header](./sse-header.png)


### æ•°æ®æ ¼å¼
æ¯ä¸€æ¬¡å‘é€çš„ä¿¡æ¯ï¼Œç”±è‹¥å¹²ä¸ª `message` ç»„æˆï¼Œæ¯ä¸ª `message` ä¹‹é—´ç”¨\n\nåˆ†éš”ã€‚ç±»å‹å¦‚ä¸‹:
```js
// æ•°æ®æ 
data: [value]\n

// è‡ªå®šä¹‰ä¿¡æ¯ç±»å‹
event: [value]\n

// æ•°æ®æ ‡è¯†ç¬¦
id: [value]\n

// æœ€å¤§é—´éš”æ—¶é—´
retry: [value]\n

// æ³¨é‡Š
: [value]\n

```

| å¯¹æ¯”   | æè¿° | ä¾‹å­ |
| ---- | ----  | ---- |
| `data`  | æ•°æ®å†…å®¹ç”¨dataè¡¨ç¤ºï¼Œå¯ä»¥å ç”¨ä¸€è¡Œæˆ–å¤šè¡Œï¼Œä»¥â€œ\n\nâ€ç»“å°¾ | data: begin message\n<br/>data: continue message\n\n |
| `event`  | eventå¤´ä¿¡æ¯è¡¨ç¤ºè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œæ²¡æœ‰åˆ™é»˜è®¤ `message` äº‹ä»¶ | event: foo\n<br/>data: a foo event\n\n |
| `id`  | æ•°æ®æ ‡è¯†ç¬¦ç”¨idè¡¨ç¤ºï¼Œç›¸å½“äºæ¯ä¸€æ¡æ•°æ®çš„ç¼–å· | id: msg1\n <br/> data: message\n\n |
| `retry`  | æµè§ˆå™¨é»˜è®¤ä¸‰ç§’å†…æ²¡æœ‰å‘é€ä»»ä½•ä¿¡æ¯å¼€å§‹é‡è¿ã€‚æœåŠ¡å™¨ç«¯å¯ä»¥ç”¨ `retry` å¤´ä¿¡æ¯ï¼ŒæŒ‡å®šé€šä¿¡çš„æœ€å¤§é—´éš”æ—¶é—´| retry: 10000\n |
| ` `  | é€šå¸¸ï¼ŒæœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šå‘æµè§ˆå™¨å‘é€ä¸€ä¸ªæ³¨é‡Šä¿æŒè¿æ¥ä¸ä¸­æ–­ | : This is a comment |

## æœåŠ¡ç«¯å®ç°
æ¯ä¸ªæœåŠ¡ç«¯å®ç°ä¸åŒï¼Œä»¥ä¸‹æ˜¯ `NodeJS` æ–¹æ¡ˆå®ç°ã€‚

### NodeJS å®ç°
```js
// sse.js
const http = require("http");const http = require("http");

http.createServer(function (req, res) {
  res.writeHead(200, {
    "Content-Type": "text/event-stream",
    "Cache-Control": "no-cache",
    "Connection": "keep-alive",
    "Access-Control-Allow-Origin": '*',
  });

  res.write("retry: 1000\n");
  res.write("event: connecttime\n");
  res.write("data: " + (new Date()) + "\n\n");

  interval = setInterval(function () {
    res.write("data: " + (new Date()) + "\n\n");
  }, 1000);

  req.addListener("close", function () {
    clearInterval(interval);
  }, false);
}).listen(8080);
```

### å¯åŠ¨å’Œè®¿é—®
ä»…éœ€ `node sse.js` å³å¯æ‰“å¼€

```bash
node sse.js
```

å¹¶è®¿é—® [http://127.0.0.1:8080/](http://127.0.0.1:8080/) å°±èƒ½è®¿é—®åˆ° `sse` çš„é¡µé¢å•¦ï¼

# ğŸ”š ç»“è¯­
ä» `è½®è¯¢` åˆ° `SSE`ï¼Œå†åˆ° `SSE` å’Œ `Websocket` çš„æŠ€æœ¯é€‰å‹ï¼Œä¸åŒçš„åœºæ™¯ç”¨ä¸åŒæ–¹æ¡ˆã€‚åœ¨é±¼å’Œç†ŠæŒéƒ½è¦å…¼å¾—çš„é“è·¯ä¸Šï¼Œé“é˜»ä¸”é•¿ã€‚

å¼€å‘è¿‡ç¨‹å’Œæˆé•¿è¿‡ç¨‹ä¸€æ ·ã€‚å…ˆæ˜¯â€œé•¿å¤§â€å°±è¡Œï¼Œå†åˆ°â€œå¿«ç‚¹é•¿å¤§â€ï¼Œæœ€åæ˜¯â€œå¥½å¥½é•¿å¤§â€ã€‚å¼€å‘è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå­—ç¬¦ä¸²æ›¿æ¢â€œé•¿å¤§â€ æˆ â€œè¿­ä»£â€ã€‚è¿™ä¸ªè¿‡ç¨‹å¿…ä¸å¯å°‘ï¼Œç»å†ä¹Ÿå®Œå…¨ä¸åŒã€‚

å¸Œæœ›èƒ½ç»™ä½ å¸¦æ¥äº›å¸®åŠ©ï¼Œæ„Ÿè°¢ä½ çš„æ—¶é—´é˜…è¯»åˆ°è¿™é‡ŒğŸ’—ã€‚