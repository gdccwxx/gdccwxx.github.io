<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="vz1PrlmOl-C4FBrH_at-JOEneuzGOz7AfXa3QVThvy8"><meta name="baidu-site-verification" content="code-4IMpMXQpb6"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon.ico?v=5.1.4"><meta name="keywords" content="gdccwxx"><meta name="description" content="个人博客分享，热爱生活，热爱探索"><meta property="og:type" content="website"><meta property="og:title" content="gdccwxx"><meta property="og:url" content="https://blog.gdccwxx.com/index.html"><meta property="og:site_name" content="gdccwxx"><meta property="og:description" content="个人博客分享，热爱生活，热爱探索"><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="gdccwxx"><meta name="twitter:description" content="个人博客分享，热爱生活，热爱探索"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_header:"slideDownIn",post_body:"slideDownIn"}},duoshuo:{userId:"undefined",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://blog.gdccwxx.com/"><title>gdccwxx - :)</title><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="https://www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-118405225-1","auto"),ga("send","pageview")</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">gdccwxx</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">:)</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/http/what-is-sse/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/http/what-is-sse/" itemprop="url">使用 SSE 替代轮询</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-09T22:00:50+08:00">2021-10-09</time></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="🎓-背景"><a href="#🎓-背景" class="headerlink" title="🎓 背景"></a>🎓 背景</h1><p>浏览器和服务端交互过程中，会有服务端向浏览器通信的场景。例如：服务端异步处理信息，处理成功后向浏览器推送。</p><p>但并不是所有的后台服务都建立了 <code>websocket</code> 通道，因此常用做法是浏览器定时查询，<code>轮询</code>后台数据。</p><p>从请求的角度来看，<code>轮询</code>多余了浏览器向后台服务<code>发起握手</code>、<code>发送数据包</code>的过程，因此并不简洁、优雅。</p><p>那有没有既不需要 <code>websocket</code> 通道，又不用<code>轮询</code>这么 “low” 的方法呢？本文介绍的 <code>SSE</code> (server-site events) 就足够简洁和优雅。</p><h1 id="🤔️-SSE-是啥"><a href="#🤔️-SSE-是啥" class="headerlink" title="🤔️ SSE 是啥"></a>🤔️ SSE 是啥</h1><p><code>SSE</code> 全称是 Server-sent events(服务器发送事件)，是服务器向客户端推送数据的一种方式。</p><p><code>SSE</code> 的本质是通过 <code>HTTP</code> 请求，不断发送 <code>流信息(streaming)</code>，使得服务器向客户端推送信息。类似于视频流。</p><p>他不是一次性的数据包，而是会一直等着服务端的推送。因此客户端不会关闭连接，等着服务端的不断推送。这样就实现了服务端向客户端的推送。</p><h1 id="🆚-SSE-VS-Websocket"><a href="#🆚-SSE-VS-Websocket" class="headerlink" title="🆚 SSE VS Websocket"></a>🆚 SSE VS Websocket</h1><p><code>Websocket</code> 是双向通信(全双工)，浏览器 <-> 服务端相互通信，更强大也更灵活。</-></p><p><code>SSE</code> 是单向通信(半双工)，浏览器 &lt;- 服务端，本质是下载信息。</p><table><thead><tr><th>对比</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><code>Websocket</code></td><td>1. 全双工，功能更强大<br></td><td>1.较为复杂，服务端需要重新支持<br>2.断线重连需要额外部署</td></tr><tr><td><code>SSE</code></td><td>1.协议轻量，支持 HTTP 的服务端就支持<br>2.方便默认支持断线重连<br>3.支持自定义数据类型</td><td>1.半双工，不够灵活</td></tr></tbody></table><p>两者各有特点，适合不同场所</p><h1 id="💡-SSE-的使用"><a href="#💡-SSE-的使用" class="headerlink" title="💡 SSE 的使用"></a>💡 SSE 的使用</h1><p>既然 <code>SSE</code> 作用于客户端和服务端，下面分为<code>客户端</code>和<code>服务端</code>来分别介绍 <code>API</code>。</p><h2 id="浏览器的使用"><a href="#浏览器的使用" class="headerlink" title="浏览器的使用"></a>浏览器的使用</h2><h3 id="检查是否可以使用"><a href="#检查是否可以使用" class="headerlink" title="检查是否可以使用"></a>检查是否可以使用</h3><p><code>SSE</code> 在浏览器中的API在 <code>EventSource</code> 对象上。通过这样来检测是否可以使用，通常来讲，除了 IE\Edge，主流浏览器都支持：<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">Boolean</span>(<span class="built_in">window</span>.EventSource)) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="和服务器建立连接"><a href="#和服务器建立连接" class="headerlink" title="和服务器建立连接"></a>和服务器建立连接</h3><p>浏览器先生成 <code>EventSource</code> 实例，再向服务器发起连接。</p><p>当然，url 可以是当前网址同域，也可以跨域。<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同网址</span></span><br><span class="line"><span class="keyword">let</span> source = <span class="keyword">new</span> EventSource(url);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跨域带上 cookie。 打开withCredentials属性，表示是否一起发送 Cookie。</span></span><br><span class="line"><span class="keyword">let</span> source = <span class="keyword">new</span> EventSource(url, &#123; <span class="attr">withCredentials</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure><p></p><h3 id="状态变化"><a href="#状态变化" class="headerlink" title="状态变化"></a>状态变化</h3><p><code>EventSource</code> 实例中 <code>readyState</code> 属性表明了当前连接状态。可以取以下值。</p><table><thead><tr><th>取值</th><th>解释</th></tr></thead><tbody><tr><td><code>0</code></td><td>表示连接还未建立，或者断线正在重连</td></tr><tr><td><code>1</code></td><td>表示连接已经建立，可以接受数据</td></tr><tr><td><code>2</code></td><td>表示连接已断，且不会重连</td></tr></tbody></table><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><ul><li><p><code>建立连接时</code>，会触发 <code>open</code> 事件，和 <code>js</code> 其他事件用法基本一致</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onopen 写法</span></span><br><span class="line">source.onopen = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addEventListener</span></span><br><span class="line">source.addEventListener(<span class="string">'open'</span>, (event) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></li><li><p><code>收到消息时</code>，会触发 <code>message</code> 事件，和 <code>js</code> 其他事件用法基本一致。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onmessage 写法</span></span><br><span class="line">source.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = event.data;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addEventListener</span></span><br><span class="line">source.addEventListener(<span class="string">'message'</span>, (event) =&gt; &#123;</span><br><span class="line">  <span class="comment">// data 是服务器回传的数据，是 文本格式，二进制需要重新转码</span></span><br><span class="line">  <span class="keyword">const</span> data = event.data;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></li><li><p><code>发生错误时</code>(例如中断)，会触发 <code>error</code> 事件，和 <code>js</code> 其他事件用法基本一致。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onerror 写法</span></span><br><span class="line">source.onerror = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addEventListener</span></span><br><span class="line">source.addEventListener(<span class="string">'error'</span>, (event) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></li><li><p><code>关闭连接</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source.close();</span><br></pre></td></tr></table></figure></li><li><p><code>自定义事件</code>, 默认情况下触发的是 <code>message</code> 事件，但是还能自定义事件，从而不触发 <code>message</code> 事件。本例子对 <code>info</code> 事件进行监听</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source.addEventListener(<span class="string">'info'</span>, (event) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = event.data;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></li></ul><h2 id="服务端的使用"><a href="#服务端的使用" class="headerlink" title="服务端的使用"></a>服务端的使用</h2><h3 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h3><p>服务端的向浏览器发送的数据是 <code>UTF-8</code> 的编码文本，<code>HTTP</code> 头具有特定的信息。<br>必须指定 <code>Content-Type</code> 类型为 <code>event-steam</code>。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: text/event-stream</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure><p></p><p><img src="/img/loading.gif" data-original="/http/what-is-sse/sse-header.png" alt="header"></p><h3 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h3><p>每一次发送的信息，由若干个 <code>message</code> 组成，每个 <code>message</code> 之间用\n\n分隔。类型如下:<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据栏</span></span><br><span class="line">data: [value]\n</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义信息类型</span></span><br><span class="line">event: [value]\n</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据标识符</span></span><br><span class="line">id: [value]\n</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最大间隔时间</span></span><br><span class="line">retry: [value]\n</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注释</span></span><br><span class="line">: [value]\n</span><br></pre></td></tr></table></figure><p></p><table><thead><tr><th>对比</th><th>描述</th><th>例子</th></tr></thead><tbody><tr><td><code>data</code></td><td>数据内容用data表示，可以占用一行或多行，以“\n\n”结尾</td><td>data: begin message\n<br>data: continue message\n\n</td></tr><tr><td><code>event</code></td><td>event头信息表示自定义的数据类型，没有则默认 <code>message</code> 事件</td><td>event: foo\n<br>data: a foo event\n\n</td></tr><tr><td><code>id</code></td><td>数据标识符用id表示，相当于每一条数据的编号</td><td>id: msg1\n<br>data: message\n\n</td></tr><tr><td><code>retry</code></td><td>浏览器默认三秒内没有发送任何信息开始重连。服务器端可以用 <code>retry</code> 头信息，指定通信的最大间隔时间</td><td>retry: 10000\n</td></tr><tr><td><code></code></td><td>通常，服务器每隔一段时间就会向浏览器发送一个注释保持连接不中断</td><td>: This is a comment</td></tr></tbody></table><h2 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h2><p>每个服务端实现不同，以下是 <code>NodeJS</code> 方案实现。</p><h3 id="NodeJS-实现"><a href="#NodeJS-实现" class="headerlink" title="NodeJS 实现"></a>NodeJS 实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sse.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);<span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"text/event-stream"</span>,</span><br><span class="line">    <span class="string">"Cache-Control"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">    <span class="string">"Connection"</span>: <span class="string">"keep-alive"</span>,</span><br><span class="line">    <span class="string">"Access-Control-Allow-Origin"</span>: <span class="string">'*'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  res.write(<span class="string">"retry: 1000\n"</span>);</span><br><span class="line">  res.write(<span class="string">"event: connecttime\n"</span>);</span><br><span class="line">  res.write(<span class="string">"data: "</span> + (<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">"\n\n"</span>);</span><br><span class="line"></span><br><span class="line">  interval = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    res.write(<span class="string">"data: "</span> + (<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">"\n\n"</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  req.addListener(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    clearInterval(interval);</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line">&#125;).listen(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><h3 id="启动和访问"><a href="#启动和访问" class="headerlink" title="启动和访问"></a>启动和访问</h3><p>仅需 <code>node sse.js</code> 即可打开</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node sse.js</span><br></pre></td></tr></table></figure><p>并访问 <a href="http://127.0.0.1:8080/" target="_blank" rel="noopener">http://127.0.0.1:8080/</a> 就能访问到 <code>sse</code> 的页面啦！</p><h1 id="🔚-结语"><a href="#🔚-结语" class="headerlink" title="🔚 结语"></a>🔚 结语</h1><p>从 <code>轮询</code> 到 <code>SSE</code>，再到 <code>SSE</code> 和 <code>Websocket</code> 的技术选型，不同的场景用不同方案。在鱼和熊掌都要兼得的道路上，道阻且长。</p><p>开发过程和成长过程一样。先是“长大”就行，再到“快点长大”，最后是“好好长大”。开发过程也是一样，字符串替换“长大” 成 “迭代”。这个过程必不可少，经历也完全不同。</p><p>希望能给你带来些帮助，感谢你的时间阅读到这里💗。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/git/git-rebase-merge-commit/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/git/git-rebase-merge-commit/" itemprop="url">git —— 通过 rebase 合并 commit</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-08T12:41:58+08:00">2021-10-08</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在项目开发时候，经常会遇到明明是同一个修改，在一些不可抗拒因素下，导致本应该是一次提交的 commit 被多次提交。在开源社区往往对commit message 有着强迫症似的提交。</p><p>本篇的目的就是通过 rebase 合并 commit。</p><h2 id="场景再现"><a href="#场景再现" class="headerlink" title="场景再现"></a>场景再现</h2><p>分支: <code>master</code><br>提交次数: <code>2次</code><br>git log:</p><ul><li>初始化: 第二次提交 (<strong>当前最新commit</strong>)</li><li>初始化: 第一次提交(需要合并)</li><li>初始化: init（不需要合并）</li></ul><p><img src="/img/loading.gif" data-original="/git/git-rebase-merge-commit/git-log.png" alt="git-log"></p><h3 id="期望场景"><a href="#期望场景" class="headerlink" title="期望场景"></a>期望场景</h3><p>合并commit: <code>e4a5545b</code> 和 <code>1bc8133d</code><br>git log: <code>初始化文件</code></p><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="压缩-commit-命令"><a href="#压缩-commit-命令" class="headerlink" title="压缩 commit 命令"></a>压缩 commit 命令</h3><p>命令：<code>git rebase -i [start point] [end point]</code> or <code>git rebase -i HEAD~[number]</code> 可使用任意一种</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i 03dcc16f // commit号是需要合并提交的前一次提交</span><br><span class="line">// or </span><br><span class="line">git rebase -i 03dcc16f 1bc8133d</span><br><span class="line">// or</span><br><span class="line">git rebase -i HEAD~2</span><br></pre></td></tr></table></figure><p>键入命令后，commit 信息由最开始到最近提交。即：最上面是最开始的提交，最下面是最近提交。<br><img src="/img/loading.gif" data-original="/git/git-rebase-merge-commit/git-rebase-pick.png" alt="git-rebase-pick"></p><h3 id="Rebase"><a href="#Rebase" class="headerlink" title="Rebase"></a>Rebase</h3><h4 id="1-命令解析："><a href="#1-命令解析：" class="headerlink" title="1. 命令解析："></a>1. 命令解析：</h4><ul><li><code>pick</code>: 要执行这个 commit</li><li><code>squash</code> : 当前 commit 会被合并到前一个 commit</li><li>…</li></ul><h4 id="2-操作-rebase-i"><a href="#2-操作-rebase-i" class="headerlink" title="2. 操作 rebase -i"></a>2. 操作 rebase -i</h4><ul><li>将 <code>除了第一条</code> 的 <code>pick</code> 都改为 <code>squash</code> 或者 <code>s</code></li><li>vi <code>:wq</code> 保存退出</li></ul><p><img src="/img/loading.gif" data-original="/git/git-rebase-merge-commit/git-rebase-s.png" alt="git-rebase-s"></p><h4 id="3-git-rebase-基础操作-非必要无需此步"><a href="#3-git-rebase-基础操作-非必要无需此步" class="headerlink" title="3. git rebase 基础操作(非必要无需此步)"></a>3. git rebase 基础操作(非必要无需此步)</h4><p>git 会压缩提交历史，若有冲突，需要进行修改，修改的时候保留最新的历史记录。</p><ul><li><p>if 执行压缩：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git rebase --continue</span><br></pre></td></tr></table></figure></li><li><p>else 如果放弃此次压缩：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --abort</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-修改-commit-message"><a href="#4-修改-commit-message" class="headerlink" title="4. 修改 commit message"></a>4. 修改 commit message</h4><p>若无冲突 or 冲突已 fix，则会出现一个 commit message 编辑页面。</p><p>修改 commit message， vi <code>:wq</code> 保存退出。</p><p><img src="/img/loading.gif" data-original="/git/git-rebase-merge-commit/modify-commit-message.png" alt="modify-commit-message"></p><h4 id="5-查看修改后的内容"><a href="#5-查看修改后的内容" class="headerlink" title="5. 查看修改后的内容"></a>5. 查看修改后的内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span></span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-original="/git/git-rebase-merge-commit/modified-git-log.png" alt="modified-git-log"></p><p>已经将 <code>e4a5545b</code> 和 <code>1bc8133d</code> 合并成一条 <code>510bfd34</code> ✅</p><h4 id="6-同步到远端"><a href="#6-同步到远端" class="headerlink" title="6. 同步到远端"></a>6. 同步到远端</h4><p>使用 <code>git push -f</code> or <code>git push --force</code> 强制推送。</p><p>由于本地 git commit 记录被改动，与远端的记录不匹配。因此需要用 <code>force push</code> 强制远端与本地记录同步。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git push -f</span><br><span class="line">// or</span><br><span class="line">git push --force</span><br></pre></td></tr></table></figure><p>再看远端的仓库，记录已经改变～</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/nestJs/nest-js-tutorial-4/" itemprop="url">NestJs 入门教程之四：高阶用法</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-15T21:19:29+08:00">2021-09-15</time></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-4/nestjs.png" alt="nestjs"></p><a href="/nestJs/nest-js-tutorial-3/" title="上篇">上篇</a>文章，实现了 <code>数据库</code> 基础操作 和联表查询。<br><br>本篇是教程的最终篇，虽然我们实现了 NestJs 的基础功能，但是真正的服务器需要做全局的数据核查、敏感操作落库和数据转化。<br><br>拥有这些能力才能让后台能力更加丰富，本篇将主要使用 NestJs 的高级能力，来实现这些功能。<br><br>本篇概要：<br>- 使用 <code>guards</code> 和 <code>decorators</code> 实现数据校验核查<br>- 通过 <code>interceptors</code> 和 <code>decorators</code> 实现敏感操作录入<br>- 自定义 <code>pipes</code> 实现数据转化<br><p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p><h1 id="守卫-Guards"><a href="#守卫-Guards" class="headerlink" title="守卫 Guards"></a>守卫 Guards</h1><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-4/guards.png" alt="guards"><br>在 <code>请求到达业务逻辑前</code> 会经过 guard，这样在接口前可以做统一处理。</p><p>例如：检查登陆态、检查权限 …</p><p>需要在业务逻辑前 <code>统一检查</code> 的信息，都可以抽象成守卫。</p><p>在真实场景中，大多数的后台管理端会用 <code>JWT</code> 实现接口鉴权。<code>NestJs</code> 也提供了对应的<a href="https://docs.nestjs.com/security/authentication" target="_blank" rel="noopener">解决方案</a>。</p><p>由于较长且原理相通，本篇暂时用校验 <code>user</code> 字段做演示。</p><h2 id="新建守卫"><a href="#新建守卫" class="headerlink" title="新建守卫"></a>新建守卫</h2><p>新建 <code>user.guard.ts</code> 文件</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/guards/user.guard.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, CanActivate, ExecutionContext, UnauthorizedException &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserGuard <span class="keyword">implements</span> CanActivate &#123;</span><br><span class="line">  canActivate(</span><br><span class="line">    context: ExecutionContext,</span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line">    <span class="keyword">const</span> user = request.body.user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException(<span class="string">'need user field'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="单个接口使用守卫"><a href="#单个接口使用守卫" class="headerlink" title="单个接口使用守卫"></a>单个接口使用守卫</h2><p>单个接口使用需要用 <code>@UseGuards</code> 作为引用。再将定义的 <code>UserGuard</code> 作为入参。</p><p>在 <code>student.controller.ts</code> 中使用<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;  UseGuards  <span class="comment">/** ... **/</span>&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserGuard &#125; <span class="keyword">from</span> <span class="string">'../common/guards/user.guard'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UseGuards</span>(UserGuard)</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYouPost(<span class="meta">@Body</span>() student: StudentDto) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(student.name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这样当访问 <code>who-are-you</code> 和 <code>who-is-request</code> 就起作用了<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// ❌ 不使用 user</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"name": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; &#123;<span class="string">"statusCode"</span>:401,<span class="string">"message"</span>:<span class="string">"need user to distinct"</span>,<span class="string">"error"</span>:<span class="string">"Unauthorized"</span>&#125;%  </span><br><span class="line"></span><br><span class="line">// ✅ 使用 user</span><br><span class="line">// curl -X POST http://127.0.0.1:3000/students/who-are-you -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx", "name": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; Im student gdccwxx%</span><br></pre></td></tr></table></figure><p></p><h2 id="全局使用"><a href="#全局使用" class="headerlink" title="全局使用"></a>全局使用</h2><p>全局使用仅需在 <code>app.module.ts</code> 的 <code>providers</code> 中引入。这样就对全局生效了<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; APP_GUARD &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserGuard &#125; <span class="keyword">from</span> <span class="string">'./common/guards/user.guard'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  controllers: [AppController],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: APP_GUARD,</span><br><span class="line">      useClass: UserGuard,</span><br><span class="line">    &#125;,</span><br><span class="line">      AppService</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;&#125;</span><br></pre></td></tr></table></figure><p></p><p>这时再访问 <code>get</code> 请求 <code>who-are-you</code> 和 <code>post</code> 请求 <code>who-is-request</code><br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// ❌ get who-are-you</span><br><span class="line">http://localhost:3000/students/who-are-you?name=gdccwxx</span><br><span class="line">// =&gt; &#123;</span><br><span class="line">// statusCode: 401,</span><br><span class="line">// message: <span class="string">"need user field"</span>,</span><br><span class="line">// error: <span class="string">"Unauthorized"</span></span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">// ✅ post </span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-is-request -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; gdccwxx%</span><br></pre></td></tr></table></figure><p></p><h2 id="自定义装饰器过滤"><a href="#自定义装饰器过滤" class="headerlink" title="自定义装饰器过滤"></a>自定义装饰器过滤</h2><p>总有些接口我们不需要有 <code>user</code> 字段，这时自定义 <code>decorator</code> 就出马了。</p><p>基本原理是：在接口前设置 MetaData, 在服务启动时把 MetaData 写入内存，这样在请求过来时判断有无 MetaData 标签。有则通过，无则校验。</p><p>顺便也将 <code>get</code> 请求类型过滤掉。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/decorators.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoUser = <span class="function"><span class="params">()</span> =&gt;</span> SetMetadata(<span class="string">'no-user'</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p><code>user.guard.ts</code> 改造</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user.guard.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="comment">// ..</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserGuard <span class="keyword">implements</span> CanActivate &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> reflector: Reflector</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  canActivate(</span><br><span class="line">    context: ExecutionContext,</span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line">    <span class="keyword">const</span> user = request.body.user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.method !== <span class="string">'POST'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> noCheck = <span class="keyword">this</span>.reflector.get&lt;<span class="built_in">string</span>[]&gt;(<span class="string">'no-user'</span>, context.getHandler());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (noCheck) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException(<span class="string">'need user field'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NoUser</code> 使用<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; User, NoUser &#125; <span class="keyword">from</span> <span class="string">'../common/decorators'</span>;</span><br><span class="line"><span class="comment">// ..</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@NoUser</span>()</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYouPost(<span class="meta">@Body</span>() student: StudentDto) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(student.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>再调用时，就不会再校验了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"name": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; Im student gdccwxx%</span><br></pre></td></tr></table></figure><p>这样就实现了全局守卫，但是部分接口不需要守卫的情况。</p><p>特别适用于登录态的校验，只有登陆接口不需要登录态，其他接口都需要登陆态或鉴权。</p><h1 id="拦截器-Interceptors"><a href="#拦截器-Interceptors" class="headerlink" title="拦截器 Interceptors"></a>拦截器 Interceptors</h1><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-4/interceptors.png" alt="interceptors"></p><p>拦截器工作在 <code>请求前</code> 和 <code>响应后</code>。它的原理和 <code>decorator</code> 类似，不同的是能做全局级别。</p><p>它的应用场景也非常广，例如：接口请求参数和请求结果的数据保存、设计模式中的 adapter 模式 等…</p><p>我们来用它实现敏感信息的数据保存。</p><p>它的原理和 <code>guards</code> 类似, 通过 <code>decorator</code> 加载到内存，知道哪些接口需要敏感操作记录，然后在调用接口时将 入参和结果存入。</p><p>涉及到数据库操作，因此需要新增模块和数据库连接。</p><h2 id="新建敏感权限模块"><a href="#新建敏感权限模块" class="headerlink" title="新建敏感权限模块"></a>新建敏感权限模块</h2><p>新建敏感权限模块，包括 controller、module 和 service<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nest g controller sensitive</span><br><span class="line">nest g module sensitive</span><br><span class="line">nest g service sensitive</span><br></pre></td></tr></table></figure><p></p><h2 id="创建-entity-文件"><a href="#创建-entity-文件" class="headerlink" title="创建 entity 文件"></a>创建 entity 文件</h2><p>新建 <code>sensitive.entity.ts</code> 。</p><p>这里会用到 <code>transformer</code>, 原因是 <code>mysql</code> 底层并没有 <code>Object</code> 类型。需要通过 JS 把它存成 <code>string</code> 格式，在读取时用 <code>object</code> 格式。这样代码就不需要感知是啥类型了。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Entity, Column, PrimaryGeneratedColumn, CreateDateColumn &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveType &#125; <span class="keyword">from</span> <span class="string">'../constants'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to 写入数据库</span></span><br><span class="line"><span class="comment">// from 从数据库读取</span></span><br><span class="line"><span class="keyword">const</span> dataTransform = &#123;</span><br><span class="line">    to: <span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">JSON</span>.stringify(value || &#123;&#125;),</span><br><span class="line">    <span class="keyword">from</span>: <span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">JSON</span>.parse(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Sensitive &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'enum'</span>, <span class="keyword">enum</span>: SensitiveType &#125;)</span><br><span class="line">  <span class="keyword">type</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  pathname: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'text'</span>, transformer: dataTransform &#125;)</span><br><span class="line">  parameters: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'text'</span>, transformer: dataTransform &#125;)</span><br><span class="line">  results: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CreateDateColumn</span>()</span><br><span class="line">  createDate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="引用数据库"><a href="#引用数据库" class="headerlink" title="引用数据库"></a>引用数据库</h2><p>和之前介绍数据库一样，在 <code>sensitive.module.ts</code> 中引入数据库<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveController &#125; <span class="keyword">from</span> <span class="string">'./sensitive.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveService &#125; <span class="keyword">from</span> <span class="string">'./sensitive.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Sensitive &#125; <span class="keyword">from</span> <span class="string">'./entities/sensitive.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  controllers: [SensitiveController],</span><br><span class="line">  imports: [TypeOrmModule.forFeature([Sensitive])],</span><br><span class="line">  providers: [Sensitive, SensitiveService],</span><br><span class="line">  exports: [SensitiveService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SensitiveModule &#123;&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="service-核心逻辑"><a href="#service-核心逻辑" class="headerlink" title="service 核心逻辑"></a>service 核心逻辑</h2><p>敏感操作比较简单，service 仅需实现新增和查询。</p><p>先定义敏感操作类型<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/sensitive/constants.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> SensitiveType &#123;</span><br><span class="line">    Modify = <span class="string">'Modify'</span>,</span><br><span class="line">    Set = <span class="string">'Set'</span>,</span><br><span class="line">    Create = <span class="string">'Create'</span>,</span><br><span class="line">    Delete = <span class="string">'Delete'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在修改 service，引入db操作</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/sensitive/sensitive.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Sensitive &#125; <span class="keyword">from</span> <span class="string">'./entities/sensitive.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveType &#125; <span class="keyword">from</span> <span class="string">'./constants'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SensitiveService &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="meta">@InjectRepository</span>(Sensitive)</span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> readonly sensitiveRepository: Repository&lt;Sensitive&gt;,</span></span><br><span class="line"><span class="params">    </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> setSensitive(<span class="keyword">type</span>: SensitiveType, pathname: <span class="built_in">string</span>, parameters: <span class="built_in">any</span>, results: <span class="built_in">any</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.sensitiveRepository.save(&#123;</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            pathname,</span><br><span class="line">            parameters,</span><br><span class="line">            results,</span><br><span class="line">        &#125;).catch(<span class="function"><span class="params">e</span> =&gt;</span> e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> getSensitive(<span class="keyword">type</span>: SensitiveType) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.sensitiveRepository.find(&#123; </span><br><span class="line">            where: &#123;</span><br><span class="line">                <span class="keyword">type</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="controller-修改"><a href="#controller-修改" class="headerlink" title="controller 修改"></a>controller 修改</h2><p>controller 比较简单，只需要简单的查询即可。敏感信息写入则是通过 decorator + interceptor 来实现</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/sensitive/sensitive.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Query &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveService &#125; <span class="keyword">from</span> <span class="string">'./sensitive.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveType &#125; <span class="keyword">from</span> <span class="string">'./constants'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'sensitive'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SensitiveController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly sensitiveService: SensitiveService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'/get-by-type'</span>)</span><br><span class="line">    getSensitive(<span class="meta">@Query</span>(<span class="string">'type'</span>) <span class="keyword">type</span>: SensitiveType) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sensitiveService.getSensitive(<span class="keyword">type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="新增装饰器"><a href="#新增装饰器" class="headerlink" title="新增装饰器"></a>新增装饰器</h2><p>装饰器的用场来了，只需要告诉某个接口需要敏感操作记录，并指定类型即可。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/decorators</span></span><br><span class="line"><span class="keyword">import</span> &#123; SetMetadata &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveType &#125; <span class="keyword">from</span> <span class="string">'../sensitive/constants'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SensitiveOperation = <span class="function">(<span class="params"><span class="keyword">type</span>: SensitiveType</span>) =&gt;</span> SetMetadata(<span class="string">'sensitive-operation'</span>, <span class="keyword">type</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>通过传参的方式，定义敏感操作的类型。在数据库中可以分类，通过索引的方式查找修改入参和结果。</p><h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>重点来了！！</p><p>和守卫权限校验类似，通过 <code>reflector</code> 取出内存中的 sensitive-operation 类型。</p><p>新建 <code>src/common/interceptors/sensitive.interceptor.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/interceptors/sensitive.interceptor.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, NestInterceptor, ExecutionContext, CallHandler &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveService &#125; <span class="keyword">from</span> <span class="string">'../../sensitive/sensitive.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveType &#125; <span class="keyword">from</span> <span class="string">'../../sensitive/constants'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SensitiveInterceptor <span class="keyword">implements</span> NestInterceptor &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> reflector: Reflector, <span class="keyword">private</span> sensitiveService: SensitiveService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  intercept(context: ExecutionContext, next: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">type</span> = <span class="keyword">this</span>.reflector.get&lt;SensitiveType | <span class="literal">undefined</span>&gt;(<span class="string">'sensitive-operation'</span>, context.getHandler());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>  next.handle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">      .handle()</span><br><span class="line">      .pipe(</span><br><span class="line">        tap(<span class="function">(<span class="params">data</span>) =&gt;</span> <span class="keyword">this</span>.sensitiveService.setSensitive(<span class="keyword">type</span>, request.url, request.body, data)),</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并在 app.module.ts 中引入全局。<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; APP_GUARD, APP_INTERCEPTOR &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveInterceptor &#125; <span class="keyword">from</span> <span class="string">'./common/interceptors/sensitive.interceptor'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: APP_INTERCEPTOR,</span><br><span class="line">      useClass: SensitiveInterceptor,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="其他模块引用"><a href="#其他模块引用" class="headerlink" title="其他模块引用"></a>其他模块引用</h2><p>student 模块引入<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/students/students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveOperation &#125; <span class="keyword">from</span> <span class="string">'../common/decorators'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SensitiveType &#125; <span class="keyword">from</span> <span class="string">'../sensitive/constants'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@SensitiveOperation</span>(SensitiveType.Set)</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'set-student-name'</span>)</span><br><span class="line">    setStudentName(<span class="meta">@User</span>() user: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.setStudent(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>仅需要在接口前引入 <code>@SensitiveOperation(SensitiveType.Set)</code> 即可！是不是非常优美。</p><p>再来调用下！<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ✅ 使用命令行调用</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/<span class="built_in">set</span>-student-name -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx1"&#125;'</span></span><br><span class="line">// =&gt; &#123;<span class="string">"name"</span>:<span class="string">"gdccwxx1"</span>,<span class="string">"id"</span>:3,<span class="string">"updateDate"</span>:<span class="string">"2021-09-17T05:48:41.685Z"</span>,<span class="string">"createDate"</span>:<span class="string">"2021-09-17T05:48:41.685Z"</span>&#125;%</span><br><span class="line"></span><br><span class="line">// ✅ 打开浏览器</span><br><span class="line">http://localhost:3000/sensitive/get-by-type?<span class="built_in">type</span>=<span class="built_in">set</span></span><br><span class="line">// =&gt; [&#123;</span><br><span class="line">//  id: 1,</span><br><span class="line">//  <span class="built_in">type</span>: <span class="string">"Set"</span>,</span><br><span class="line">//  pathname: <span class="string">"/students/set-student-name"</span>,</span><br><span class="line">//  parameters: &#123; user: <span class="string">"gdccwxx1"</span> &#125;,</span><br><span class="line">//  results: &#123; name: <span class="string">"gdccwxx1"</span>, id: 3, updateDate: <span class="string">"2021-09-17T05:48:41.685Z"</span>, createDate: <span class="string">"2021-09-17T05:48:41.685Z"</span> &#125;,</span><br><span class="line">//  createDate: <span class="string">"2021-09-17T05:48:41.719Z"</span></span><br><span class="line">// &#125;]</span><br></pre></td></tr></table></figure><p></p><p>bingo！这样就达到了我们想要的目的！</p><p>在不影响原有业务逻辑的情况下，仅是在接口处做标识的简单调用。实现了 <code>AOP</code> 的调用方式。对老代码的改造和新业务的编写都十分有用。</p><h1 id="管道-Pipes"><a href="#管道-Pipes" class="headerlink" title="管道 Pipes"></a>管道 Pipes</h1><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-4/pipes.png" alt="pipes"><br>NestJs <code>Pipes</code> 的概念和 linux <code>shell</code> 的概念非常相似，都是通过前者的输出再做一些事情。</p><p>它的应用场景也非常广，例如：数据转化，数据校验等…</p><p>对数据输入时的操作非常有用。对复杂数据校验，例如表单数据等十分有用。</p><p>我们没有复杂输入，我们来使用简单的数据转化，实现在名字前加上🇨🇳</p><h2 id="新建-Pipes"><a href="#新建-Pipes" class="headerlink" title="新建 Pipes"></a>新建 Pipes</h2><p>新建 <code>src/common/pipes/name.pipes.ts</code>。<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/pipes/name.pipes.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; PipeTransform, Injectable, ArgumentMetadata &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TransformNamePipe <span class="keyword">implements</span> PipeTransform &#123;</span><br><span class="line">  transform(name: <span class="built_in">string</span>, metadata: ArgumentMetadata) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`🇨🇳 <span class="subst">$&#123;name.trim()&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>和其他 NestJs 一样，都需要重载一边内置对象。<code>Pipes</code> 也需要重载 <code>PipeTransform</code>。</p><h2 id="使用管道"><a href="#使用管道" class="headerlink" title="使用管道"></a>使用管道</h2><p>在 <code>controller</code> 中使用 <code>pipes</code>。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; TransformNamePipe &#125; <span class="keyword">from</span> <span class="string">'../common/pipes/name.pipes'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYou(<span class="meta">@Query</span>(<span class="string">'name'</span>, TransformNamePipe) name: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>query 的第二个参数是 pipes, 也可以使用多个 pipes 对数据连续处理</p><h2 id="调用接口"><a href="#调用接口" class="headerlink" title="调用接口"></a>调用接口</h2><p>再浏览器访问<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">http://localhost:3000/students/who-are-you?name=gdccwxx</span><br><span class="line">// =&gt; Im student 🇨🇳 gdccwxx</span><br></pre></td></tr></table></figure><p></p><p>这样就实现了简单版本的数据转换了！</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>至此，NestJs 的入门篇章就结束了。</p><p>简单回顾下教程内容：</p><ul><li>通过 <code>nest cli</code> 新建工程、新建模块</li><li>通过 <code>@Get</code> 和 <code>@Post</code> 实现 get、post 请求</li><li>通过 <code>dto</code> 限制对参数进行限制</li><li>自定义 <code>decorator</code> 实现参数获取、设置 <code>metadata</code></li><li>调用内置 <code>log</code> 实现日志规范化</li><li>使用 <code>typeorm</code> 对数据库连接和基础操作，并进行联表操作及查询</li><li>使用 <code>guard</code> 对参数进行校验（可扩展成登录态）</li><li>使用 <code>interceptor</code> 实现敏感数据落地</li><li>使用 <code>pipes</code> 实现数据格式化</li></ul><p>笔者也在 NestJs 逐渐探索中。它不仅包括简单的数据服务，还支持 <code>GraphQL</code>、<code>SSE</code>、<code>Microservice</code> 等等，是综合性非常强的框架。</p><p>btw：这是笔者用这么久以来最喜欢的 Node 框架了</p><p>感谢你的阅读～</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/nestJs/nest-js-tutorial-3/" itemprop="url">NestJs 入门教程之三：数据库</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-12T17:16:56+08:00">2021-09-12</time></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-3/nestjs.png" alt="nestjs"></p><p>这个系列的<a href="/nestJs/nest-js-tutorial-2/" title="上一篇">上一篇</a>文章，实现了 <code>Post</code> 接口和对接口的基础操作。</p><p>而真正的服务往往包括数据存储。</p><p>本篇将介绍如何建立 NestJs 的数据库连接、并使用数据库联表查询。这样就就是完整的后台服务了。</p><p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p><p>本篇使用 <code>mysql</code> 作为数据库连接。使用 <code>NestJs</code> 内置的<a href="https://docs.nestjs.com/techniques/database" target="_blank" rel="noopener">数据库连接</a> <code>typeorm</code>，可在 <a href="https://typeorm.io/" target="_blank" rel="noopener">这里</a> 查阅 typeorm 详细文档</p><h1 id="一、开发准备"><a href="#一、开发准备" class="headerlink" title="一、开发准备"></a>一、开发准备</h1><ol><li><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">下载</a>并安装 Mysql</li><li><p>创建 school 库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database school;</span><br></pre></td></tr></table></figure></li><li><p>安装 @nestjs/typeorm typeorm mysql2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @nestjs/typeorm typeorm mysql2</span><br></pre></td></tr></table></figure></li></ol><h1 id="二、数据库连接"><a href="#二、数据库连接" class="headerlink" title="二、数据库连接"></a>二、数据库连接</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">'./app.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">'./app.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsController &#125; <span class="keyword">from</span> <span class="string">'./students/students.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    StudentsModule,</span><br><span class="line">    TypeOrmModule.forRoot(&#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="string">'mysql'</span>,</span><br><span class="line">      host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">      port: <span class="number">3306</span>,</span><br><span class="line">      username: <span class="string">'root'</span>,</span><br><span class="line">      password: <span class="string">'1qaz2wsx'</span>,</span><br><span class="line">      database: <span class="string">'school'</span>,</span><br><span class="line">      autoLoadEntities: <span class="literal">true</span>,</span><br><span class="line">      synchronize: <span class="literal">true</span>, <span class="comment">// 数据库自动同步 entity 文件修改</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [AppController],</span><br><span class="line">  providers: [AppService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>初始化数据库连接。</p><p><code>autoLoadEntities</code> 自动化 load entity 文件, 所有在 Module 中引用的 Entity 文件会被自动加载。自动加载设置为 true 即可。</p><p><code>synchronize</code> 自动化同步表，本地可自动打开，线上数据库不建议打开。</p><h1 id="三、定义表结构"><a href="#三、定义表结构" class="headerlink" title="三、定义表结构"></a>三、定义表结构</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    Entity,</span><br><span class="line">    Column,</span><br><span class="line">    PrimaryGeneratedColumn,</span><br><span class="line">    UpdateDateColumn,</span><br><span class="line">    CreateDateColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Student &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UpdateDateColumn</span>()</span><br><span class="line">  updateDate: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CreateDateColumn</span>()</span><br><span class="line">  createDate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>@Entity</code> 注解代表是数据库入口文件；</li><li><code>@Column</code> 是基础列文件，使用 <code>type</code> 字段定义在数据库实际存储</li><li><code>@PrimaryGeneratedColumn</code> 代表单调递增的主键</li><li><code>@UpdateDateColumn</code> 当记录修改时会修改时间</li><li><code>@CreateDateColumn</code> 当记录新增时会写入时间</li></ul><h1 id="四、引用表"><a href="#四、引用表" class="headerlink" title="四、引用表"></a>四、引用表</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Student &#125; <span class="keyword">from</span> <span class="string">'./entities/students.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsController &#125; <span class="keyword">from</span> <span class="string">'./students.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsService &#125; <span class="keyword">from</span> <span class="string">'./students.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">    imports: [TypeOrmModule.forFeature([Student])],</span><br><span class="line">    providers: [StudentsService, Student],</span><br><span class="line">    controllers: [StudentsController],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsModule &#123;&#125;</span><br></pre></td></tr></table></figure><ul><li><code>imports</code> 引用 typeorm 模块， entity 才可以在 service 中使用</li><li><code>providers</code> service 的 constructor 需要引用哪些模块</li><li><code>controllers</code> 模块的 controller</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Student &#125; <span class="keyword">from</span> <span class="string">'./entities/students.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="meta">@InjectRepository</span>(Student)</span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> readonly studentRepository: Repository&lt;Student&gt;,</span></span><br><span class="line"><span class="params">    </span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样会在 db 中建立 students 新表。</p><p>使用 <code>show create table</code> 能看表的详细信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use school;</span><br><span class="line"></span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">// =&gt; | student | CREATE TABLE `student` (</span><br><span class="line">//  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">//  `updateDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),</span><br><span class="line">//  `createDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),</span><br><span class="line">//  `name` varchar(255) NOT NULL,</span><br><span class="line">//  PRIMARY KEY (`id`)</span><br><span class="line">// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |</span><br></pre></td></tr></table></figure><h1 id="五、与数据库交互"><a href="#五、与数据库交互" class="headerlink" title="五、与数据库交互"></a>五、与数据库交互</h1><p>到这一步，终于可以和数据库进行交互了。基本上和数据库交互的部分都会放在 service 层，因此 <code>新增</code> 和 <code>查询</code> 都放在 service 层。</p><p>其中包括了</p><ul><li><code>getStudentName</code> 的改造</li><li><code>setStudent</code> 函数的新增</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="comment">// import ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="comment">// logger, constructor ImStudent getStudentName ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> getStudentName(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.log(<span class="string">`get student id is <span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="keyword">this</span>.studentRepository.find(&#123; id &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results ?? <span class="string">'not found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> setStudent(name: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = <span class="keyword">this</span>.studentRepository.create(&#123; name &#125;);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过使用 <code>find</code> 和 <code>create</code> 对学生查询和创建。结果也是异步的。</p><p>下面对 <code>controller</code> 进行改造，使得函数调用串起来。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="comment">// import ...</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="comment">// constructor whoAreYou whoAreYouPost whoIsReq ..</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'get-name-by-id'</span>)</span><br><span class="line">    getNameById(<span class="meta">@Query</span>(<span class="string">'id'</span>, ParseIntPipe) id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.getStudentName(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'set-student-name'</span>)</span><br><span class="line">    setStudentName(<span class="meta">@User</span>() user: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.setStudent(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过对 <code>service</code> 的调用, 再经 <code>controller</code> 调用产生如下结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// ✅ 命令行访问</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/<span class="built_in">set</span>-student-name -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; &#123;<span class="string">"name"</span>:<span class="string">"gdccwxx"</span>,<span class="string">"id"</span>:1,<span class="string">"updateDate"</span>:<span class="string">"2021-09-12T15:57:14.599Z"</span>,<span class="string">"createDate"</span>:<span class="string">"2021-09-12T15:57:14.599Z"</span>&#125;%</span><br><span class="line"></span><br><span class="line">// ✅ 浏览器访问</span><br><span class="line">http://localhost:3000/students/get-name-by-id?id=1</span><br><span class="line"></span><br><span class="line">// =&gt; [&#123;</span><br><span class="line">//  id: 1,</span><br><span class="line">//  name: <span class="string">"gdccwxx"</span>,</span><br><span class="line">//  updateDate: <span class="string">"2021-09-12T15:57:14.599Z"</span>,</span><br><span class="line">//  createDate: <span class="string">"2021-09-12T15:57:14.599Z"</span></span><br><span class="line">// &#125;]</span><br></pre></td></tr></table></figure><p>通过对 <code>service</code> 的 save、find 调用，就能将数据完整存入数据库了。</p><h1 id="六、联表查询"><a href="#六、联表查询" class="headerlink" title="六、联表查询"></a>六、联表查询</h1><p>我们准备新建课程表<code>class</code>，每个班级可以有多个学生，一个学生隶属一个班级。</p><p>这样<code>学生</code>和<code>班级</code>就构成了 <code>n:1</code> 的关系。</p><p>为了方便展示，在学生模块下直接新增 <code>class.entity.ts</code> 文件。并通过 <code>@OneToMany</code> 关联 <code>students</code>。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// classes.entity.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Entity, Column, PrimaryGeneratedColumn, UpdateDateColumn, CreateDateColumn, OneToMany &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Student &#125; <span class="keyword">from</span> <span class="string">'./students.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Classes &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  className: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@OneToMany</span>(<span class="function"><span class="params">()</span> =&gt;</span> Student, <span class="function"><span class="params">student</span> =&gt;</span> student.class)</span><br><span class="line">  students: Student[]</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UpdateDateColumn</span>()</span><br><span class="line">  updateDate: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CreateDateColumn</span>()</span><br><span class="line">  createDate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时修改 <code>students.entity.ts</code>, 通过 <code>@ManyToOne</code> 引入 <code>Classes</code> 修改</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.entity.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    ManyToOne,</span><br><span class="line">    <span class="comment">// Entity...</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Classes &#125; <span class="keyword">from</span> <span class="string">'./classes.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Student &#123;</span><br><span class="line">  <span class="comment">// id name updateDate, createDate...</span></span><br><span class="line">  <span class="meta">@ManyToOne</span>(<span class="function"><span class="params">()</span> =&gt;</span> Classes, <span class="function"><span class="params">classes</span> =&gt;</span> classes.students)</span><br><span class="line">  <span class="keyword">class</span>: Classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：<code>classes</code> 表引用 <code>students</code> 是通过新建字段(<code>students\class</code>)进行关联。</p><p>引用会最终在数据库变成<code>外键</code>连接。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">show create table student;</span><br><span class="line">// =&gt;  CREATE TABLE `student` (</span><br><span class="line">//   `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">//   `name` varchar(255) NOT NULL,</span><br><span class="line">//   `updateDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),</span><br><span class="line">//   `createDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),</span><br><span class="line">//   `classId` int DEFAULT NULL,    // 👈 注意这里</span><br><span class="line">//   PRIMARY KEY (`id`),</span><br><span class="line">//   KEY `FK_bd5c8f2ef67394162384a484ba1` (`classId`), // 👈 注意这里</span><br><span class="line">//   CONSTRAINT `FK_bd5c8f2ef67394162384a484ba1` FOREIGN KEY (`classId`) REFERENCES `classes` (`id`) // 👈 注意这里</span><br><span class="line">// ) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 而 classes 表并无链接</span><br><span class="line">show create table classes;</span><br><span class="line">// CREATE TABLE `classes` (</span><br><span class="line">//   `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">//   `className` varchar(255) NOT NULL,</span><br><span class="line">//   `updateDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),</span><br><span class="line">//   `createDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),</span><br><span class="line">//   PRIMARY KEY (`id`)</span><br><span class="line">// ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure><p>再引入表，详细操作可看第四步。</p><p><code>students.module.ts</code> 引入表<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Classes &#125; <span class="keyword">from</span> <span class="string">'./entities/classes.entity'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">    imports: [TypeOrmModule.forFeature([Student, Classes])],</span><br><span class="line">    providers: [StudentsService, Student, Classes],</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsModule &#123;&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>students.service.ts</code> 引入表, 并实现 <code>setClass</code>, <code>getClass</code> 方法</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Classes &#125; <span class="keyword">from</span> <span class="string">'./entities/classes.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="meta">@InjectRepository</span>(Student)</span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> readonly studentRepository: Repository&lt;Student&gt;,</span></span><br><span class="line"><span class="params">        <span class="meta">@InjectRepository</span>(Classes)</span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> readonly classRepository: Repository&lt;Classes&gt;,</span></span><br><span class="line"><span class="params">    </span>) &#123;&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">     <span class="keyword">async</span> setClass(name: <span class="built_in">string</span>, studentIds: <span class="built_in">number</span>[]) &#123;</span><br><span class="line">        <span class="keyword">const</span> students = <span class="keyword">await</span> <span class="keyword">this</span>.studentRepository.find(&#123; where: studentIds &#125;);</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.classRepository.save(&#123;</span><br><span class="line">            className: name,</span><br><span class="line">            students: students, <span class="comment">// 此处直接保存students 的实例，即直接从数据库取出来的数据</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> findClass(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.classRepository.find(&#123;</span><br><span class="line">            where: &#123; id &#125;,</span><br><span class="line">            relations: [<span class="string">'students'</span>]</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新增 <code>ClassesDto</code><br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// classes.dto.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; IsNotEmpty, IsString &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ClassesDto &#123;</span><br><span class="line">    <span class="meta">@IsNotEmpty</span>()</span><br><span class="line">    <span class="meta">@IsString</span>()</span><br><span class="line">    className: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    students: <span class="built_in">number</span>[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>students.controller.ts</code> 修改<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="comment">// import ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="comment">// constructor ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'get-class'</span>)</span><br><span class="line">    getClass(<span class="meta">@Query</span>(<span class="string">'id'</span>, ParseIntPipe) id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.findClass(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'set-class'</span>)</span><br><span class="line">    setClass(<span class="meta">@Body</span>() classes: ClassesDto) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.setClass(classes.className, classes.students);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>调用接口</code>，先插入数据再查询数据。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 再新增一条数据</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/<span class="built_in">set</span>-student-name -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx1"&#125;'</span></span><br><span class="line"></span><br><span class="line">// 插入 classes 数据</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/<span class="built_in">set</span>-class -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"className": "blog", "students": [1,2]&#125;'</span></span><br><span class="line"></span><br><span class="line">// ✅ 通过浏览器，查询长啥样</span><br><span class="line">http://localhost:3000/students/get-class?id=1</span><br><span class="line">// =&gt; [&#123;</span><br><span class="line">//  id: 1,</span><br><span class="line">    className: <span class="string">"blog"</span>,</span><br><span class="line">    updateDate: <span class="string">"2021-09-15T01:05:38.055Z"</span>,</span><br><span class="line">    createDate: <span class="string">"2021-09-15T01:05:38.055Z"</span>,</span><br><span class="line">    students: [&#123;</span><br><span class="line">        id: 1,</span><br><span class="line">        name: <span class="string">"gdccwxx"</span>,</span><br><span class="line">        updateDate: <span class="string">"2021-09-15T01:05:38.000Z"</span>,</span><br><span class="line">        createDate: <span class="string">"2021-09-15T01:05:23.988Z"</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        id: 2,</span><br><span class="line">        name: <span class="string">"gdccwxx1"</span>,</span><br><span class="line">        updateDate: <span class="string">"2021-09-15T01:05:38.000Z"</span>,</span><br><span class="line">        createDate: <span class="string">"2021-09-15T01:05:28.084Z"</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><h1 id="七、简单回顾"><a href="#七、简单回顾" class="headerlink" title="七、简单回顾"></a>七、简单回顾</h1><p>再回顾下本章：</p><ul><li>使用 <code>typeorm</code> 和 <code>mysql</code> 建立连接</li><li>使用 <code>entity</code> 文件创建数据库表</li><li><code>service</code> 使用对数据库的简单调用，包括<code>写入</code>和<code>读取</code></li><li>使用关系查询，将 <code>student</code> 和 <code>classes</code> 连接写入和查询</li></ul><p>至此，我们使用 <code>typeorm</code> 和 <code>mysql</code> 连接数据库就完成了。</p><p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p><p><a href="/nestJs/nest-js-tutorial-4/" title="下章">下章</a>我们将主要讲 <code>NestJs</code> 的高级用法，包括 <code>管道</code>、<code>守卫</code>和<code>拦截器</code>。期待你的阅读。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-2/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/nestJs/nest-js-tutorial-2/" itemprop="url">NestJs 入门教程之二：处理请求</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-12T10:06:06+08:00">2021-09-12</time></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-2/nestjs.png" alt="nestjs"></p><p>这个系列的<a href="/nestJs/nest-js-tutorial-1/" title="上一篇">上一篇</a>文章，教大家写了 hello world 和 新建 students 模块。</p><p>但是，那只是很干的 Get 请求；即没有 Post 请求，也没有给参数做检查；更没有日志的使用。</p><p>本篇接着往下讲，通过 NestJs 的原生能力，来实现 Post 请求，并做参数检查，最后利用原生日志模块实现标准化日志。</p><p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p><h1 id="一、Post-请求"><a href="#一、Post-请求" class="headerlink" title="一、Post 请求"></a>一、Post 请求</h1><p>经过上篇的介绍，总体请求先会经过 students.controller.ts -&gt; 再到 students.service.ts。</p><p>在 students.service.ts 上新增 <code>Post</code> 方法<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// @Get('who-are-you') ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYouPost() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>通过 curl 访问地址<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">curl -X POST  http://127.0.0.1:3000/students/who-are-you</span><br><span class="line">// =&gt; Im student%</span><br></pre></td></tr></table></figure><p></p><p>通过替换装饰器，就可以快速实现 <code>Post</code> 请求。</p><h1 id="二、请求参数"><a href="#二、请求参数" class="headerlink" title="二、请求参数"></a>二、请求参数</h1><p>正常请求都会加上参数，<code>Get</code> 和 <code>Post</code> 方法加参数略有不同。</p><p>先看 Get 请求</p><h2 id="Get-请求参数"><a href="#Get-请求参数" class="headerlink" title="Get 请求参数"></a>Get 请求参数</h2><p>Get 请求的参数一般会放在 URL 上，这是 <code>@Query</code> 装饰器就派上用场了。</p><p>先改造 controller</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post, Query &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYou(<span class="meta">@Query</span>(<span class="string">'name'</span>) name: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再改造 service</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    ImStudent(name?: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student '</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过浏览器访问 url<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">http://localhost:3000/students/who-are-you?name=gdccwxx</span><br><span class="line">// =&gt; Im student gdccwxx</span><br></pre></td></tr></table></figure><p></p><p>这样 Get 请求就能获取到 name 参数了</p><h2 id="Post-参数"><a href="#Post-参数" class="headerlink" title="Post 参数"></a>Post 参数</h2><p>Post 参数有些不同，会用到 <a href="https://baike.baidu.com/item/DTO/16016821" target="_blank" rel="noopener">DTO</a> 的传输。因为数据通过 HTTP 传输是文本类型，因此需要将文本类型转化成代码可识别的变量。</p><p>新建 students.dto.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/students/dtos/students.dto.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentDto &#123;</span><br><span class="line">    name: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>编辑 students.controller.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentDto &#125; <span class="keyword">from</span> <span class="string">'./dtos/students.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsService &#125; <span class="keyword">from</span> <span class="string">'./students.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// @Get('who-are-you') ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYouPost(<span class="meta">@Body</span>() student: StudentDto) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(student.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>命令行访问<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">curl -X POST -d&quot;name=gdccwxx&quot;  http://127.0.0.1:3000/students/who-are-you</span><br><span class="line">// =&gt; Im student gdccwxx%</span><br></pre></td></tr></table></figure><p></p><p>post 方法传递的参数是通过请求 body 给到后台的。需要通过 <code>@Body</code> 装饰器解析 Body 中的数据。</p><h1 id="三、参数限制与转换"><a href="#三、参数限制与转换" class="headerlink" title="三、参数限制与转换"></a>三、参数限制与转换</h1><p>这部分其实用到了 <a href="https://docs.nestjs.com/pipes" target="_blank" rel="noopener">管道</a> 的概念，我们用基础管道来实现，更高阶用法将会放在<a href="/nestJs/nest-js-tutorial-4/" title="第四章">第四章</a>中</p><h2 id="Get-请求"><a href="#Get-请求" class="headerlink" title="Get 请求"></a>Get 请求</h2><p>get 请求需要用到 <code>ParseIntPipe</code>, 更多的内置管道列表可查看<a href="https://docs.nestjs.com/pipes#built-in-pipes" target="_blank" rel="noopener">这里</a></p><p>浏览器访问的 url 默认是 string 类型，<code>ParseIntPipe</code> 管道能将 string 类型转化成 number 类型</p><p>这次我们实现的是通过 id 查找学生姓名。</p><p>修改 students.service.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="comment">// ImStudent...</span></span><br><span class="line"></span><br><span class="line">    getStudentName(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> ID_NAME_MAP = &#123;</span><br><span class="line">            <span class="number">1</span>: <span class="string">'gdccwxx'</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ID_NAME_MAP[id] ?? <span class="string">'not found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>修改 students.controller.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query, ParseIntPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="comment">// ... </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// @Get('who-are-you') ..</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Post('who-are-you') ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'get-name-by-id'</span>)</span><br><span class="line">    getNameById(<span class="meta">@Query</span>(<span class="string">'id'</span>, ParseIntPipe) id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.getStudentName(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>浏览器使用参数访问<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// ❌</span><br><span class="line">http://localhost:3000/students/get-name-by-id?id=gdccwxx</span><br><span class="line">// =&gt; &#123;</span><br><span class="line">//     statusCode: 400,</span><br><span class="line">//     message: &quot;Validation failed (numeric string is expected)&quot;,</span><br><span class="line">//     error: &quot;Bad Request&quot;</span><br><span class="line">// &#125; </span><br><span class="line"></span><br><span class="line">// ✅</span><br><span class="line">http://localhost:3000/students/get-name-by-id?id=1</span><br><span class="line">// =&gt; gdccwxx</span><br></pre></td></tr></table></figure><p></p><p>当使用非法请求，导致无法转换时，NestJs 会将请求报错处理，而正确参数则会转换后调用调用相应函数。通过简单的装饰器引用， NestJs 框架就可以自动做了参数检查与转换了</p><h2 id="Post-请求"><a href="#Post-请求" class="headerlink" title="Post 请求"></a>Post 请求</h2><p>Post 请求略微有些不一样，要用到 class-validator</p><p>安装 class-validator<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save class-validator class-transformer</span><br></pre></td></tr></table></figure><p></p><p>修改 main.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ValidationPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">  app.useGlobalPipes(<span class="keyword">new</span> ValidationPipe());</span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure><p></p><p>修改 student.dto.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; IsNotEmpty, IsString &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentDto &#123;</span><br><span class="line">    <span class="meta">@IsNotEmpty</span>()</span><br><span class="line">    <span class="meta">@IsString</span>()</span><br><span class="line">    name: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>通过命令行访问<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// ❌</span><br><span class="line">curl -X POST  http://127.0.0.1:3000/students/who-are-you</span><br><span class="line">// =&gt; &#123;&quot;statusCode&quot;:400,&quot;message&quot;:[&quot;name must be a string&quot;,&quot;name should not be empty&quot;],&quot;error&quot;:&quot;Bad Request&quot;&#125;%</span><br><span class="line"></span><br><span class="line">// ❌</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;name&quot;: 1&#125;&apos;</span><br><span class="line">// =&gt; &#123;&quot;statusCode&quot;:400,&quot;message&quot;:[&quot;name must be a string&quot;],&quot;error&quot;:&quot;Bad Request&quot;&#125;% </span><br><span class="line"></span><br><span class="line">// ✅</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;name&quot;: &quot;gdccwxx&quot;&#125;&apos;</span><br><span class="line">// =&gt; Im student gdccwxx%</span><br></pre></td></tr></table></figure><p></p><p>到此，参数校验部分也就完成。</p><h1 id="四、自定义装饰器"><a href="#四、自定义装饰器" class="headerlink" title="四、自定义装饰器"></a>四、自定义装饰器</h1><p>在 post 请求用到了大量的装饰器，系统装饰器能满足大部分场景，但是有些特定需求时，需要自定义装饰器。</p><p>例如这样一个场景：每个请求都会带上 <code>user</code> 字段。代表是谁做的请求，每次在代码里 getUser 是非常难受的事情，这时自定义装饰器就派上了用场。</p><p>新建 src/common/decorators.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/decorators.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createParamDecorator, ExecutionContext &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> User = createParamDecorator(</span><br><span class="line">  (data: unknown, ctx: ExecutionContext) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = ctx.switchToHttp().getRequest(); <span class="comment">// 拿到请求</span></span><br><span class="line">    <span class="keyword">return</span> request.body.user;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p></p><p>修改 students.controller.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query, ParseIntPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsService &#125; <span class="keyword">from</span> <span class="string">'./students.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">'../common/decorators'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">    <span class="comment">// @Get('who-are-you') ...</span></span><br><span class="line">    <span class="comment">// @Post('who-are-you') ...</span></span><br><span class="line">    <span class="comment">// @Get('get-name-by-id')...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-is-request'</span>)</span><br><span class="line">    whoIsReq(<span class="meta">@User</span>() user: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>命令行访问<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-is-request -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; gdccwxx%</span><br></pre></td></tr></table></figure><p></p><p>通过自定义装饰器，并将其挂在函数上，代码就能优雅的获取是谁请求的借口。</p><h1 id="五、日志"><a href="#五、日志" class="headerlink" title="五、日志"></a>五、日志</h1><p>后台接口请求常伴随日志产生，日志对后台查问题至关重要。NestJs 框架也集成了日志，开箱即用。</p><p>使用日志分为三步:</p><ul><li>main.ts 引入 <code>Logger</code></li><li>模块引入日志组建: <code>private readonly logger = new Logger(StudentsService.name)</code>;</li><li>在需要打印的地方引入: this.logger.log(`student name is ${name}`);</li></ul><p>修改main.ts<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ValidationPipe, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule, &#123;</span><br><span class="line">    logger: <span class="keyword">new</span> Logger(),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p></p><p>引用 Logger 组建<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="keyword">private</span> readonly logger = <span class="keyword">new</span> Logger(StudentsService.name);</span><br><span class="line"></span><br><span class="line">    ImStudent(name?: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.log(<span class="string">`student name is <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student '</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getStudentName(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.log(<span class="string">`get student id is <span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> ID_NAME_MAP = &#123;</span><br><span class="line">            <span class="number">1</span>: <span class="string">'gdccwxx'</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ID_NAME_MAP[id] ?? <span class="string">'not found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>访问接口，控制台输出<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;name&quot;: &quot;gdccwxx&quot;&#125;&apos;</span><br></pre></td></tr></table></figure><p></p><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-2/log.png" alt="logger"></p><p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p><p>处理请求的基本方法就讲到这里，<a href="/nestJs/nest-js-tutorial-3/" title="下一篇">下一篇</a>会讲解如何连接数据库并使用</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/nestJs/nest-js-tutorial-1/" itemprop="url">NestJs 入门教程之一：初次上手</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-11T23:45:27+08:00">2021-09-11</time></span></div></header><div class="post-body" itemprop="articleBody"><p>自从 Node 出世以来，许多 Javascript 后端框架都曾处不穷，前端开发后台的需求也逐渐庞大。</p><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-1/nodejs.png" alt="nodejs"></p><p>Node 做后端已经成为前端的重要业务，随着前端业务的不断更迭，Node 也在前端领域也逐渐站稳脚跟，市场招聘需求逐渐旺盛，企业都抢着要。</p><p>尽管 Node 框架已经逐渐完善，但是纯 TS 的框架却十分稀缺，国外的 NestJs 填补了这一空白。</p><p>可国内使用 NestJs 的团队并不是很多，而且教程、文档都良莠不齐，对初次上手者十分不友好。恰好笔者有幸在工程中使用过 NestJs，踩过非常多的坑。本系列文章主要讲我在工作中遇到的问题与解决方案，并梳理成教程方式，希望对初学者有用。</p><p>教程目标是经过此个系列文章，能搭建一套 NestJs 在日常编码过程中会用到的功能。</p><p>考虑到 NestJs 功能比较多，本教程会选较为常用的功能，分为四次次连载。</p><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-1/nestjs.png" alt="nestjs"></p><h1 id="一、NestJs-是啥"><a href="#一、NestJs-是啥" class="headerlink" title="一、NestJs 是啥"></a>一、NestJs 是啥</h1><p>学习 NestJS 之前，先简单说一下，它到底是啥。</p><p>字面意思来讲，它是一个以 JS 代码的方式运行 JS 的框架。</p><p>从 <a href="https://nestjs.com/" target="_blank" rel="noopener">NestJs 官网</a> 来看，NestJS 是运行在服务端的一个 JS 框架。它运行时是 <code>JavaScript</code>，编程时使用<code>TypeScript</code>, 是结合灵活性、可扩展性的框架。并且结合了面向对象编程(OOP)、函数式编程(FP)和函数响应式编程(FRP)</p><p>它的特殊之处在于，以前使用 JS 方式写后台代码，现在通过写 TS, 再编译成 JS 运行。既包含了 JS 的灵活性，又有 TS 的约束。</p><h1 id="二、NestJS-的优势"><a href="#二、NestJS-的优势" class="headerlink" title="二、NestJS 的优势"></a>二、NestJS 的优势</h1><p>NestJS 最大的优势，是他基于 TypeScript。</p><p>后台接口需要清晰的入参和出参，需要对函数和接口强约束，维护时才能保证接口的可靠性。</p><p>而且，NestJs 的是基于 Express 的进行开发的，也就是说完美的复用成熟的生态，可以很方便的去市场找第三方包。</p><h1 id="三、知识准备"><a href="#三、知识准备" class="headerlink" title="三、知识准备"></a>三、知识准备</h1><p>由于 NestJs 是基于 Node 的环境，因此需要具备基础的知识。</p><ul><li>HTTP: 了解基本的 Get、Post 请求</li><li>Node：基本明白接口请求，知道服务与接口关系即可</li><li>Typescript：基本懂语法，能大致知道装饰器和 interface</li></ul><p>最好之前用过 Node 相关服务，使用 Node 搭建过后台服务，但这不是必要的。</p><h1 id="四、开发准备"><a href="#四、开发准备" class="headerlink" title="四、开发准备"></a>四、开发准备</h1><p>1、安装 Node 环境：访问 <a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">Node 下载地址</a>. 下载安装后，Node &gt;= 10.13.0 即可, 可通过命令行检查</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><p>2、安装 NestJS cli</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br></pre></td></tr></table></figure><h1 id="五、Hello-World"><a href="#五、Hello-World" class="headerlink" title="五、Hello World"></a>五、Hello World</h1><h2 id="创建-nest-test-项目"><a href="#创建-nest-test-项目" class="headerlink" title="创建 nest-test 项目"></a>创建 nest-test 项目</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// step1</span><br><span class="line">nest new nest-test</span><br><span class="line"></span><br><span class="line">// step2 Which package manager would you</span><br><span class="line">选择: npm</span><br></pre></td></tr></table></figure><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>这样就得到了 src/ 目录为这样的文件列表了<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">  |- app.controller.spec.ts // controller 的测试文件</span><br><span class="line">  |- app.controller.ts      // controller，路由和预处理</span><br><span class="line">  |- app.module.ts          // module，为模块注册用</span><br><span class="line">  |- app.service.ts         // service 真正的逻辑</span><br><span class="line">  |- main.ts                // 程序入口</span><br></pre></td></tr></table></figure><p></p><p>NestJS 也主张的是 <a href="https://zh.wikipedia.org/wiki/MVC" target="_blank" rel="noopener">MVC</a> 的格式。</p><h2 id="module"><a href="#module" class="headerlink" title="module"></a>module</h2><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-1/module.png" alt="module"></p><p>module 的作用是在程序运行时给模块处理依赖。好处是所有模块的依赖都可以在 module 中清晰明了的知道引用还是被引用</p><h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><p><img src="/img/loading.gif" data-original="/nestJs/nest-js-tutorial-1/controllers.png" alt="controller"></p><p>controller 的作用是处理请求，所有的请求会先到 controller，再经 controller 调用其他模块业务逻辑</p><h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><p>是真正处理业务逻辑的地方，所有的业务逻辑都会在这里处理。它可经过 module 引用其他模块的service，也可经过 module 暴露出去。</p><h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// step1: 进入目录</span><br><span class="line">cd nest-test</span><br><span class="line"></span><br><span class="line">// step2: 安装依赖或更新依赖</span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line">// step3: 运行程序</span><br><span class="line">npm run start</span><br></pre></td></tr></table></figure><p>最后浏览器访问url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">访问: http://localhost:3000/</span><br><span class="line">// =&gt; Hello World!</span><br></pre></td></tr></table></figure><p>说明程序已经成功访问了！</p><h1 id="六、生成新模块"><a href="#六、生成新模块" class="headerlink" title="六、生成新模块"></a>六、生成新模块</h1><h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><p>能访问新模块了，再进一步期望生成文件夹和文件夹的模块。NestJS cli 也支持用命令行形式来创建，这样就不需要做重复的创建文件的动作了。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nest g controller students</span><br><span class="line">nest g service students</span><br><span class="line">nest g module students</span><br></pre></td></tr></table></figure><p></p><h2 id="目录结构-1"><a href="#目录结构-1" class="headerlink" title="目录结构"></a>目录结构</h2><p>再命令行分别执行以上三条命令，src/ 目录变成了如下样子<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">  |- app.controller.spec.ts</span><br><span class="line">  |- app.controller.ts     </span><br><span class="line">  |- app.module.ts         </span><br><span class="line">  |- app.service.ts        </span><br><span class="line">  |- main.ts               </span><br><span class="line">  |- students/</span><br><span class="line">        |- students.controller.spec.ts</span><br><span class="line">        |- students.controller.ts     </span><br><span class="line">        |- students.module.ts         </span><br><span class="line">        |- students.service.spec.ts</span><br><span class="line">        |- students.service.ts</span><br></pre></td></tr></table></figure><p></p><h2 id="编辑文件"><a href="#编辑文件" class="headerlink" title="编辑文件"></a>编辑文件</h2><p>编辑如下文件:<br></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    ImStudent() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    ImStudent() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启服务, 加上 dev 就能监听文件修改了。<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start:dev</span><br></pre></td></tr></table></figure><p></p><p>最后浏览器访问url</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ✅</span><br><span class="line">http://localhost:3000/students/who-are-you</span><br><span class="line">// =&gt; Im student</span><br></pre></td></tr></table></figure><p>这样模块添加完成了</p><p>如果你看到了这里，说明你真的对 NestJS 很感兴趣。<a href="/nestJs/nest-js-tutorial-2/" title="下章">下章</a>将会对接口再深入细化。</p><p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/随笔/2021-middle-summary/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/随笔/2021-middle-summary/" itemprop="url">算是 2021 的年中总结</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-10T23:10:30+08:00">2021-09-10</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天是9月平常的周五，可是对我来说有一点点不一样，晚上10点终于把负责5个月的项目发出去了。那是我4月中到现在做的项目，虽然已经发了几版，但今天是我最后一次负责发布它。下周就要开始负责新的项目了。</p><p>我有些疲惫的到了家门口，下意识拿出了裤子口袋的钥匙，然后插进了钥匙孔，熟练的旋转了2圈。进门后看了看手表，已经22:25了，还有5分钟就要上外教课。然后有些急促的跑到阳台，收拾已经良好的衣服，再把衣服叠进衣柜。</p><p>看了看时间，还有3分钟。我立马冲进厕所洗了把脸，希望清醒一些，也希望给外教留个好印象。</p><p>课程开始了，又是熟悉的自我介绍环节，再嘘寒问暖了一番。从聊天中得知外教是南非人，比我们晚6个小时，而且在南半球，现在是冬天。我表示吃惊，她也看了看时间，夸我有毅力。在一顿欢声笑语中结束了。</p><p>我拿着洗好的衣服和毛巾，进入厕所的那一刻，一天的重担仿佛才卸下来，这段时间的重担仿佛才卸下来。</p><h2 id="项目咋样"><a href="#项目咋样" class="headerlink" title="项目咋样"></a>项目咋样</h2><p>这算是我在团队负责最久的项目之一，历时5个半月。这算是一次完整版的中台项目，完全由 Typescript 搭建。包括 React 做前端、Nest js 做后台、Nginx 做转发、Docker 做容的完整中台，几乎所有的架构代码都是我搭建的。它包括 数据库做存储、log4js 做日志、权限控制、配置发布、单元测试等等，几乎是完整的后台了。它的作用是负责运营配置相关，包括升级、增量升级、配置下发、邮件模版等功能。</p><p>搭建的再好，也都交给其他同学负责了。人总是要成长，作为前端工程师也得做点纯前端的事情。但是总有些舍不得。谁忍心把自己一手抚养长大的 baby 给其他人照顾？更何况是我带着好几个同学打造出来的“杰作”？（至少对我来说是杰作！）</p><p>不管咋样，好好休息一番，再加油搞事吧！</p><h2 id="生活呢"><a href="#生活呢" class="headerlink" title="生活呢"></a>生活呢</h2><p>生活是发生了翻天覆地的变化。和我健身的好友相继离开了腾讯，一个归蜀，一个拥抱羊城了。说实话，他们离开深圳时，我真的有些动摇了。要不要离开深圳，要不要离开公司，成了我前两个月问自己最多的问题。好在我留下来了，生活也给我了些惊喜。</p><p><strong>再次上镜！！</strong><br>(贴两张帅照嘻嘻. 视频号 腾讯CSIG “我在鹅厂做To B” 第5期)<br><img src="/img/loading.gif" data-original="/随笔/2021-middle-summary/me-with-my-girl.jpg" alt="withMyGirl"><br><img src="/img/loading.gif" data-original="/随笔/2021-middle-summary/me.jpg" alt="me"></p><p>看到很多人评论，其中有很多好兄弟好朋友们。好兄弟、我崇拜的学长、总监、高中老师等等都为我转发加油，内心也十分的自豪，被认可的感觉真好。</p><p>与此同时，我也开始写一些文章。虽然效果一般般，阅读的人不多，但是每当我探究多深入一次，我感觉自己的基础知识更加牢固。也让我有更多的动力写文章了。</p><h2 id="说说兴趣吧"><a href="#说说兴趣吧" class="headerlink" title="说说兴趣吧"></a>说说兴趣吧</h2><p>自拔牙前后，体重从 142 -&gt; 134 -&gt; 140。从瘦了一圈又回来。我的兴趣也经历了一次过山车。</p><p>很久没有打羽毛球的我，再次拿起了羽毛球拍；知道好友要离开时，疯狂约健身。然后就是一个多月没动弹。因为拔牙后，啥也不想干，啥也不能干。之后又疯狂反噬，着了魔一样健身。</p><p>最近的兴趣爱好是看源码和看书。我把node都拉下准备好好看看，顺便提提pr；也迷上了一本书叫《沉思录》。</p><p>第一次听说 斯多葛学派 是在得到上，每天早上都会听一节课。听完之后发现正是我一直追求的心态与品质，一边看书一边练习了起来。真别说，效果特别好，因为刚练股票就长起来了哈哈哈。内心窃喜之外，也告诉自己那就接着练习吧。</p><p>兴趣基本上就这些了</p><h2 id="说说接下来的规划吧"><a href="#说说接下来的规划吧" class="headerlink" title="说说接下来的规划吧"></a>说说接下来的规划吧</h2><p>首先是准备好好写文章。多沉淀沉淀自己，学习新技术，吸收好能力。希望年底前写完10篇文章吧</p><p>然后是英语，12月份马上就一年了。也结束了外教课，希望再总结总结</p><p>再是健身，晚饭前抽时间健身吧，保持保持身材，不然走形了嘻嘻</p><p>最后是生活，希望10月份去趟东北，八字的一撇先保住咯，略略略～</p><p>最后也祝阅读到这里的你，心想事成，万事如意！</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/typescript/best-practice-of-decorator/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/typescript/best-practice-of-decorator/" itemprop="url">Decorator 最佳实践</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-05T20:22:01+08:00">2021-09-05</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多语言和方法都有 AOP 编程。AOP 的好处是只需要写一次函数检查，在函数调用前只做引用即可。极大的减少了重复代码的编写。</p><p>试想一下：在函数入参检查类型时需要反复用 <code>typeof parameter === &#39;类型&#39;</code> 来做检查时一件非常痛苦的事情。虽然用了 <code>Typescript</code>，但只是解决了编码时候的类型校验，而运行时的校验依旧需要编码来做检查。</p><p>本篇介绍的 <code>Decorator</code> 用法，就是为了解决这一困扰而出现的。它不仅一行代码解决了运行时的入参类型检查；还能用一行代码做函数权限检查，只让有权限的人调用；更能一行代码解决入参和结果的日志打印。让代码更容易维护的同时，也更专注于业务的实现。</p><p>如果您对例子感兴趣，可以直接到<a href="#使用举例">使用举例</a></p><h3 id="啥是-Decorator"><a href="#啥是-Decorator" class="headerlink" title="啥是 Decorator?"></a>啥是 Decorator?</h3><p>Decorator 是 ES6 中的提案之一，它实际上是个 wrapper，可以为类、属性或函数提供额外功能。举个🌰：<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"evaluate: "</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"call: "</span>, key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@f</span>(<span class="string">"Class Decorator"</span>)</span><br><span class="line"><span class="keyword">class</span> A &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="meta">@f</span>(<span class="string">"Constructor Parameter"</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Method"</span>) <span class="comment">// 1</span></span><br><span class="line">  method(<span class="meta">@f</span>(<span class="string">"Instance Method Parameter"</span>) foo) &#123;&#125; <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Property"</span>)</span><br><span class="line">  prop?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本上，装饰器会的行为就是下面这样：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@f</span>()</span><br><span class="line"><span class="keyword">class</span> A</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line">A = f(A) || A</span><br></pre></td></tr></table></figure><p></p><h2 id="使用前的准备"><a href="#使用前的准备" class="headerlink" title="使用前的准备"></a>使用前的准备</h2><p>虽然 Decorator 只是一个提案，但可通过工具来使用它：</p><h3 id="Babel"><a href="#Babel" class="headerlink" title="Babel:"></a>Babel:</h3><blockquote><p>babel-plugin-syntax-decorators<br>babel-plugin-transform-decorators-legacy</p></blockquote><h3 id="Typescript"><a href="#Typescript" class="headerlink" title="Typescript:"></a>Typescript:</h3><p>命令行：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tsc --target ES5 --experimentalDecorators</span><br></pre></td></tr></table></figure><p></p><p>tsconfig.json:<br></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"ES5"</span>,</span><br><span class="line">    <span class="attr">"experimentalDecorators"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p><img src="/img/loading.gif" data-original="/typescript/best-practice-of-decorator/xmind.png" alt="decorators"></p><h3 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h3><p>📌 参数：</p><ul><li><code>target</code>: 类的 <code>构造器（constructor）</code></li></ul><p>⬅️ 返回值: undefined | 替代原有构造器</p><p>因此，类装饰器适合用于继承一个现有类并添加一些属性和方法。<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rewirteClassConstructor</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123; <span class="keyword">new</span> (...args: <span class="built_in">any</span>[]): &#123;&#125; &#125;&gt;(<span class="keyword">constructor</span>: T) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">class</span> <span class="keyword">extends</span> <span class="keyword">constructor</span> &#123;</span><br><span class="line">    words = <span class="string">"rewrite constructor"</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@rewirteClassConstructor</span></span><br><span class="line"><span class="keyword">class</span> Speak &#123;</span><br><span class="line">  words: <span class="built_in">string</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">t: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.words = t;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> say = <span class="keyword">new</span> Speak(<span class="string">"hello world"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(say.words) <span class="comment">// rewrite constructor</span></span><br></pre></td></tr></table></figure><p></p><h3 id="属性装饰器"><a href="#属性装饰器" class="headerlink" title="属性装饰器"></a>属性装饰器</h3><p>📌 参数:</p><ul><li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li><li><code>propertyKey</code>: 属性名称</li></ul><p>⬅️ 返回值: 返回的结果将被忽略</p><p>除了用于收集信息外，属性装饰器也可以用来给类添加额外的方法和属性。 例如我们可以写一个装饰器来给某些属性添加监听器。<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">capitalizeFirstLetter</span>(<span class="params">str: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.charAt(<span class="number">0</span>).toUpperCase() + str.slice(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// prop -&gt; onPropChange</span></span><br><span class="line">  <span class="keyword">const</span> targetKey = <span class="string">"on"</span> + capitalizeFirstLetter(key) + <span class="string">"Change"</span>;</span><br><span class="line"></span><br><span class="line">  target[targetKey] = <span class="function"><span class="keyword">function</span> (<span class="params">fn: (prev: <span class="built_in">any</span>, next: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> prev = <span class="keyword">this</span>[key];</span><br><span class="line">      <span class="comment">// tsconfig.json target to ES6</span></span><br><span class="line">      Reflect.defineProperty(<span class="keyword">this</span>, key, &#123;</span><br><span class="line">        <span class="keyword">set</span>(next) &#123;</span><br><span class="line">          fn(prev, next);</span><br><span class="line">          prev = next;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@observable</span></span><br><span class="line">  foo = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  onFooChange(arg0: <span class="function">(<span class="params">prev: <span class="built_in">any</span>, next: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">c.onFooChange(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`prev: <span class="subst">$&#123;prev&#125;</span>, next: <span class="subst">$&#123;next&#125;</span>`</span>))</span><br><span class="line"></span><br><span class="line">c.foo = <span class="number">100</span>; <span class="comment">// -&gt; prev: -1, next: 100</span></span><br><span class="line">c.foo = <span class="number">-3.14</span>; <span class="comment">// -&gt; prev: 100, next: -3.14</span></span><br></pre></td></tr></table></figure><p></p><h3 id="方法装饰器"><a href="#方法装饰器" class="headerlink" title="方法装饰器"></a>方法装饰器</h3><p>📌 参数：</p><ul><li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li><li><code>propertyKey</code>: 属性名称</li><li><code>descriptor</code>: 属性的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" target="_blank" rel="noopener">描述器</a></li></ul><p>⬅️ 返回值：undefined | 替代属性的描述器。</p><p>方法装饰器<code>descriptor</code>的key为：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value</span><br><span class="line">writable</span><br><span class="line">enumerable</span><br><span class="line">configurable</span><br></pre></td></tr></table></figure><p></p><p>通过这个参数我们可以修改方法原本的实现，添加一些共用逻辑。 例如我们可以给一些方法添加打印输入与输出的能力:<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">target: <span class="built_in">any</span>, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> original = descriptor.value;</span><br><span class="line"></span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'params: '</span>, ...args);</span><br><span class="line">    <span class="keyword">const</span> result = original.call(<span class="keyword">this</span>, ...args);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'result: '</span>, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  <span class="meta">@logger</span></span><br><span class="line">  add(x: <span class="built_in">number</span>, y:<span class="built_in">number</span> ) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> C();</span><br><span class="line">c.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// -&gt; params: 1, 2</span></span><br><span class="line"><span class="comment">// -&gt; result: 3</span></span><br></pre></td></tr></table></figure><p></p><h3 id="访问器装饰器"><a href="#访问器装饰器" class="headerlink" title="访问器装饰器"></a>访问器装饰器</h3><p>📌 参数：</p><ul><li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li><li><code>propertyKey</code>: 属性名称</li><li><code>descriptor</code>: 属性的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" target="_blank" rel="noopener">描述器</a></li></ul><p>⬅️ 返回值：undefined | 替代属性的描述器。</p><p>访问器装饰器<code>descriptor</code>的key为：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get</span><br><span class="line">set</span><br><span class="line">enumerable</span><br><span class="line">configurable</span><br></pre></td></tr></table></figure><p></p><p>访问器装饰器总体上讲和方法装饰器很接近，唯一的区别在于描述器中有的key不同例如，我们可以将某个属性设为不可变值：<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">immutable</span>(<span class="params">target: <span class="built_in">any</span>, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> original = descriptor.set;</span><br><span class="line"></span><br><span class="line">  descriptor.set = <span class="function"><span class="keyword">function</span> (<span class="params">value: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> original.call(<span class="keyword">this</span>, &#123; ...value &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  <span class="keyword">private</span> _point = &#123; x: <span class="number">0</span>, y: <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@immutable</span></span><br><span class="line">  <span class="keyword">set</span> point(value: &#123; x: <span class="built_in">number</span>, y: <span class="built_in">number</span> &#125;) &#123;</span><br><span class="line">    <span class="keyword">this</span>._point = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> point() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._point;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> C();</span><br><span class="line"><span class="keyword">const</span> point = &#123; x: <span class="number">1</span>, y: <span class="number">1</span> &#125;</span><br><span class="line">c.point = point;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(c.point === point)</span><br><span class="line"><span class="comment">// -&gt; false</span></span><br></pre></td></tr></table></figure><p></p><h3 id="参数装饰器"><a href="#参数装饰器" class="headerlink" title="参数装饰器"></a>参数装饰器</h3><p>📌 参数：</p><ul><li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li><li><code>propertyKey</code>: 属性的名称(注意是方法的名称，而不是参数的名称)</li><li><code>paramerterIndex</code>: 参数在方法中所处的位置的下标</li></ul><p>⬅️ 返回值：返回的值将会被忽略。</p><p>单独的参数装饰器能做的事情很有限，它一般都被用于记录可被其它装饰器使用的信息。<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parameter.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">required</span>(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, parameterIndex: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> existingRequiredParameters: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(<span class="string">'required'</span>, target, propertyKey) || [];</span><br><span class="line">    existingRequiredParameters.push(parameterIndex);</span><br><span class="line">    Reflect.defineMetadata(<span class="string">'required'</span>, existingRequiredParameters, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">target: <span class="built_in">any</span>, propertyName: <span class="built_in">string</span>, descriptor: TypedPropertyDescriptor&lt;<span class="built_in">Function</span>&gt;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> method = descriptor.value!;</span><br><span class="line">   </span><br><span class="line">    descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> requiredParameters: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(<span class="string">'required'</span>, target, propertyName);</span><br><span class="line">      <span class="keyword">if</span> (requiredParameters) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> parameterIndex of requiredParameters) &#123;</span><br><span class="line">          <span class="keyword">if</span> (parameterIndex &gt;= <span class="built_in">arguments</span>.length || <span class="built_in">arguments</span>[parameterIndex] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Missing required argument."</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> BugReport &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="string">"report"</span>;</span><br><span class="line">    title: <span class="built_in">string</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params">t: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.title = t;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@validate</span></span><br><span class="line">    print(<span class="meta">@required</span> verbose: <span class="built_in">boolean</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`type: <span class="subst">$&#123;<span class="keyword">this</span>.<span class="keyword">type</span>&#125;</span>\ntitle: <span class="subst">$&#123;<span class="keyword">this</span>.title&#125;</span>`</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.title; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> report = <span class="keyword">new</span> BugReport(<span class="string">'mode error'</span>);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; report &#125; = <span class="built_in">require</span>(<span class="string">'./paramerter.js'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(report.print()); <span class="comment">// Error: Missing required argument.</span></span><br></pre></td></tr></table></figure><h2 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h2><p>不同类型的装饰器执行顺序是明确的：<br>1、 实例成员：参数装饰器 -&gt; 方法/访问器/属性 装饰器<br>2、 静态成员：参数装饰器 -&gt; 方法/访问器/属性 装饰器<br>3、 构造函数：参数装饰器<br>4、 类装饰器<br>例如：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"evaluate: "</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"call: "</span>, key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@f</span>(<span class="string">"Class Decorator"</span>)</span><br><span class="line"><span class="keyword">class</span> A &#123;</span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Static Property"</span>)</span><br><span class="line">  <span class="keyword">static</span> prop?: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Static Method"</span>)</span><br><span class="line">  <span class="keyword">static</span> method(<span class="meta">@f</span>(<span class="string">"Static Method Parameter"</span>) foo) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="meta">@f</span>(<span class="string">"Constructor Parameter"</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Method"</span>)</span><br><span class="line">  method(<span class="meta">@f</span>(<span class="string">"Instance Method Parameter"</span>) foo) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Property"</span>)</span><br><span class="line">  prop?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行顺序</span></span><br><span class="line">evaluate:  Instance Method</span><br><span class="line">evaluate:  Instance Method Parameter</span><br><span class="line">call:  Instance Method Parameter</span><br><span class="line">call:  Instance Method</span><br><span class="line">evaluate:  Instance Property</span><br><span class="line">call:  Instance Property</span><br><span class="line">evaluate:  Static Property</span><br><span class="line">call:  Static Property</span><br><span class="line">evaluate:  Static Method</span><br><span class="line">evaluate:  Static Method Parameter</span><br><span class="line">call:  Static Method Parameter</span><br><span class="line">call:  Static Method</span><br><span class="line">evaluate:  Class Decorator</span><br><span class="line">evaluate:  Constructor Parameter</span><br><span class="line">call:  Constructor Parameter</span><br><span class="line">call:  Class Decorator</span><br></pre></td></tr></table></figure><p>然而，在同一方法中的不同参数构造器顺序是相反的，最后参数回的装饰器会先被执行：<br></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"evaluate: "</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"call: "</span>, key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> B &#123;</span><br><span class="line">  <span class="meta">@f</span>(<span class="string">'first'</span>)</span><br><span class="line">  <span class="meta">@f</span>(<span class="string">'second'</span>)</span><br><span class="line">  method() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行顺序</span></span><br><span class="line">evaluate:  first</span><br><span class="line">evaluate:  second</span><br><span class="line">call:  second</span><br><span class="line">call:  first</span><br></pre></td></tr></table></figure><p></p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul><li>Before/After钩子。</li><li>监听属性改变或者方法调用。</li><li>对方法的参数做转换。</li><li>添加额外的方法和属性。</li><li>运行时类型检查。</li><li>自动编解码。</li><li>依赖注入。</li></ul><h3 id="使用举例"><a href="#使用举例" class="headerlink" title="使用举例"></a>使用举例</h3><ul><li><p>日志打印</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, key, descriptor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> method = descriptor.value;</span><br><span class="line">    descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'param: '</span>, <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>));</span><br><span class="line">      <span class="keyword">const</span> value = method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'result: '</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> B &#123;</span><br><span class="line">  <span class="meta">@f</span>()</span><br><span class="line">  say(name: <span class="built_in">string</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`name is <span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>鉴权:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target, key, descriptor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> originalMethod = descriptor.value; <span class="comment">// 保留原有函数</span></span><br><span class="line">    <span class="keyword">if</span> (!user.isAuth) &#123;</span><br><span class="line">      descriptor.value = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 未登录将返回提示</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'当前未登录，请登录!'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123; <span class="comment">// 已登录将原有函数</span></span><br><span class="line">        originalMethod.apply(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth</span>(app.user)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleStar</span>(<span class="params"><span class="keyword">new</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span>.like++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>类型检查</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"><span class="keyword">const</span> stringMetaDataTag = <span class="string">"IsString"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsString</span>(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, parameterIndex: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> existingRequiredParameters: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(stringMetaDataTag, target, propertyKey) || [];</span><br><span class="line">  existingRequiredParameters.push(parameterIndex);</span><br><span class="line">  Reflect.defineMetadata( stringMetaDataTag, existingRequiredParameters, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">target: <span class="built_in">any</span>, propertyName: <span class="built_in">string</span>, descriptor: TypedPropertyDescriptor&lt;<span class="built_in">Function</span>&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> method = descriptor.value!;</span><br><span class="line"> </span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> stringMetaTags: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(stringMetaDataTag, target, propertyName);</span><br><span class="line">    <span class="keyword">if</span> (stringMetaTags) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> parameterIndex of stringMetaTags) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = <span class="built_in">arguments</span>[parameterIndex];</span><br><span class="line">        <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> <span class="built_in">String</span> || <span class="keyword">typeof</span> value === <span class="string">'string'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'not string'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> A &#123;</span><br><span class="line">    a: <span class="built_in">string</span> = <span class="string">'123'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@validate</span></span><br><span class="line">    value (<span class="meta">@IsString</span> value: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(value);</span><br><span class="line">        <span class="keyword">this</span>.a = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>笔者在 后台接口、Js Bridge、React 项目上都有实践过。不得不说，装饰器模式在面向切面编程(AOP)几乎是 “最佳实践”，极大的提升了编程效率。也希望这篇文章能帮助到你😊</p><h3 id="npm-包"><a href="#npm-包" class="headerlink" title="npm 包"></a>npm 包</h3><p><a href="https://github.com/typestack/class-validator" target="_blank" rel="noopener">class-validator</a><br><a href="https://github.com/jayphelps/core-decorators" target="_blank" rel="noopener">core-decorators</a><br><a href="https://github.com/nestjs/nest" target="_blank" rel="noopener">Nest 后台框架</a></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener">tc39-proposal</a><br><a href="https://www.typescriptlang.org/docs/handbook/decorators.html" target="_blank" rel="noopener">typescript</a><br><a href="https://saul-mirone.github.io/a-complete-guide-to-typescript-decorator/" target="_blank" rel="noopener">a-complete-guide-to-typescript-decorator</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/需求开发/the-skills-of-develop/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/需求开发/the-skills-of-develop/" itemprop="url">做需求搞明白这几点，和加班说再见</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-23T13:39:15+08:00">2021-08-23</time></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/img/loading.gif" data-original="/需求开发/the-skills-of-develop/xmind.png" alt="xmind"></p><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>你是不是接需求后手足无措？是不是天天忙碌，但又效率不高？是不是需求沟通前后不一致，导致重复修改？几年前刚踏入职场生活的我，对此深有体会。经过沉淀，终于搞明白怎么高效开发，高效会议，总结这几点经验：和产品做朋友、需求对齐和排期、需求方案设计与发布上线、事故与复盘。从此高效工作，早早下班。</p><h2 id="树立正确的观点"><a href="#树立正确的观点" class="headerlink" title="树立正确的观点"></a>树立正确的观点</h2><p>阅读之前，不妨问问自己，工作的目的是啥？<br>也许每个人有不同的观点。有人觉得事情永远都干不完，不如慢慢做，自己也更轻松。但有种高级的思维方式是：尽自己努力做好每件事情。因为只有好好对工作，升职加薪才会好好对你；只有对工作表现出热情，老板才会对你有信心，才更可能在职场激烈的竞争中脱颖而出。</p><h2 id="和产品做朋友"><a href="#和产品做朋友" class="headerlink" title="和产品做朋友"></a>和产品做朋友</h2><p>产品是一群有想象力，能把抽象的事情具体化的人。他们不仅有许多新颖的点子，还能迅速的 get 到你说的想法。和产品同学做朋友不仅能更加顺利的合作，还能开拓视野，增长见识。比如和产品一起坐电梯，他们可能会想为什么要装镜子，而你会想电梯系统是怎么实现的。在不同角度看同一件事情不仅十分有趣，还能扩展更多可能，不妨试试看。</p><h3 id="第一手需求"><a href="#第一手需求" class="headerlink" title="第一手需求"></a>第一手需求</h3><p>和产品做朋友，能比别人更快的拿到第一手需求。<br>产品的需求并不是凭空而来，它可能是从竞品、客户需或老板提出的，产品往往是把需求具体化的人。他们更多的关注是需求是怎么实现的。以及联动的功能和异常场景。而开发则会把具体的需求通过编码实现。<br>当然，正因为产品的角度更多的是怎么实现需求，也更容易过于关注需求实现，而把原本用户诉求无限放大，忽略了需求本身。<br>开发拿到第一手需求最好的方式是如何实现需求出发，可以通过哪些方式来解决。也许需求可以不用开发，只需换个角度看问题就能轻松解决。</p><p>核心思想: why</p><h2 id="需求对齐和排期"><a href="#需求对齐和排期" class="headerlink" title="需求对齐和排期"></a>需求对齐和排期</h2><h3 id="需求宣讲"><a href="#需求宣讲" class="headerlink" title="需求宣讲"></a>需求宣讲</h3><p><img src="/img/loading.gif" data-original="/需求开发/the-skills-of-develop/discuss.png" alt="discuss"><br>需求宣讲是产品与开发、测试把方案内容输出的主要途径。一份需求的宣讲过程，大致可分为需求宣讲前、需求宣讲中、需求宣讲后。遵循一套流程能有效避免踩坑和高效率会议。</p><h4 id="需求宣讲前："><a href="#需求宣讲前：" class="headerlink" title="需求宣讲前："></a>需求宣讲前：</h4><p>亚马逊的高管会议，会在开会前半小时阅读会议内容，再根据梳理的疑问进行讨论。<br>阅读需求文档是必不可少的过程。有效的阅读文档，能在需求宣讲时更能提出自己的疑问与观点，能避免前期因为准备不足，导致的会议效率低下。这样的高效工作方式更值得作为打工人的我们借鉴。需求宣讲前可以从：</p><ul><li>看需求：了解需求的背景，和类似场景其他产品怎么实现的</li><li>提疑问：融合 Why、How、What 去思考</li><li>给方案：对现有的技术给需求的方案</li><li>给排期：给出大概的排期，以 人/天 为单位进行估算</li></ul><h4 id="需求宣讲中："><a href="#需求宣讲中：" class="headerlink" title="需求宣讲中："></a>需求宣讲中：</h4><p>需求宣讲中主要是对齐方案，解决疑惑。作为开发者期望的是对所有异常场景与方案有大概的了解，且高效会议，一次通过。需求宣讲中围绕：</p><ul><li>提出疑问：提出会前准备的疑问，并发散出新的疑问</li><li>确认需求：和产品、测试方沟通对齐表现和异常场景，最好有录屏作为证据</li><li>一次通过：有不确定的点会中立马拉上相关同学对齐，争取一次性通过会议，不开第二次</li><li>确认 deadline: 与估算的 人/天 进行匹配，有疑问可向负责人提出</li></ul><h4 id="需求宣讲后："><a href="#需求宣讲后：" class="headerlink" title="需求宣讲后："></a>需求宣讲后：</h4><p>会议后通常需要结论的沉淀。这样的好处是在不记得需求细节时可以翻看存档来确认细节、防止产品甩锅等。宣讲内容沉淀的方式：</p><ul><li>录像回放：有问题可将录像回放，找到讨论的地方</li><li>会议纪要：将本次的结论、需要跟进的点写下来，发群里，并艾特相关同学</li></ul><p>会议纪要常用模版：<br>经过与产品方、xx方的沟通，有以下结论与跟进事项：<br>结论：<br>1、xxx<br>跟进事项：<br>1、 xxxx @xxxx 同学<br>辛苦 @xxxx 关注并确认</p><p>核心思想: How</p><h3 id="目标拆解与甘特图"><a href="#目标拆解与甘特图" class="headerlink" title="目标拆解与甘特图"></a>目标拆解与甘特图</h3><p>有了具体的需求后，就来到了排期缓解。产品同学希望越快越好，而 PM（Project Manager） 会根据版本的时间点排期。也正因为二者的目标不同，会存在 PM 的排期与产品期望时间并不是相同时间点。为了保证需求不因为自己 delay，合理的人力估算和目标拆解变得必不可少。</p><h4 id="目标拆解"><a href="#目标拆解" class="headerlink" title="目标拆解"></a>目标拆解</h4><p>好的目标拆解通常会以大目标和小目标来进行拆分。大目标包括需求评审时间、开发时间、联调时间、测试时间、code review 时间、发布时间，以时间节点为颗粒；小目标包括开发进度、联调进度，以每天的事件为颗粒。<br>评估做不完需求该怎么办？</p><ul><li>需求上：迭代处理，分成本期必保、本期冲刺、本期不做的几种类型</li><li>人力上：评估加人能否解决</li><li>时间上：deadline delay 还是需求 delay</li></ul><h4 id="需求拆分的小-tips"><a href="#需求拆分的小-tips" class="headerlink" title="需求拆分的小 tips"></a>需求拆分的小 tips</h4><p>将开发、联调事件拆解，细分到每周、每天的工作。让每天的进度可控，按时完成工作，按时回家。出现进度不可控则周末适当调整下。<br>对目标拆解到具体内容：</p><ul><li>需求 deadline 倒推出需求开发完成、提测、发布时间点</li><li>根据时间点定具体开发内容，每周目标、每日目标</li></ul><p>小目标拆解后，甘特图就更能显示工作内容和进度了。</p><h3 id="甘特图"><a href="#甘特图" class="headerlink" title="甘特图"></a>甘特图</h3><p><img src="/img/loading.gif" data-original="/需求开发/the-skills-of-develop/gantt-chart.png" alt="gantt-chart"></p><p>甘特图能清晰的知道工作进度。个人使用甘特图能清晰的定好每天的目标，高效工作；多人合作使用甘特图能划分每个人的工作内容以及进度同步。<br>使用甘特图的好处很多，它不仅能直观、定量的看到进度，还能知道预期目标和实际产出的差值，能有效知道进度快、慢的原因。更重要的是有沉淀，有利于需求完成后的回顾，及时几年后看到自己画的甘特图，也能很快的回忆起当时做需求的问题与困难，充当需求快照的作用。</p><p>核心思想: When</p><h2 id="从方案设计到发布上线"><a href="#从方案设计到发布上线" class="headerlink" title="从方案设计到发布上线"></a>从方案设计到发布上线</h2><p>从方案设计到发布上线，基本属于开发和测试的工作。方案设计能具体量化需求方案，也能有效保证开发进度，这一环节必不可少。开发和测试的有效沟通也能帮助开发找到代码漏洞，避免发布上线后带来的事故，这些环节十分重要。</p><h3 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h3><p>方案设计有多香，体验过的人都知道。它的好处在于全局的思考需求，比较容易给出全局最优，而不仅仅是局部最优。方案设计不仅在开发阶段起着举足轻重的作用，还对后续维护有很大的便利。方案设计可以围绕这几点写：</p><ul><li>时间人物：标注需求关键的时间节点和参与方</li><li>业内方案：例如业内实现和竞品分析等</li><li>方案设计：方案的具体逻辑，包括设计稿、流程图、库表字段等</li><li>其他：流程卡点、自我反思或结论留底等<h3 id="处理-bug-的规矩"><a href="#处理-bug-的规矩" class="headerlink" title="处理 bug 的规矩"></a>处理 bug 的规矩</h3>产品是开发的上游，测试是开发的下游。测试同学对产品形态的表现甚至比产品还更关心，多和测试同学沟通，也能让产品有更良好的发展。要和测试做朋友，从来一杯奶茶做起。当然立好规矩也能避免在需求测试过程中增加沟通成本。</li><li>提单前：先沟通到底是开发原因还是其他原因，定好责任方与优先级</li><li>提单时：必须包含复现路径及截图，最好包含账号信息和录屏</li><li>提单后：非必要场景沟通能否降低优先级，不好解决的问题能否转成需求单<h3 id="发布条例"><a href="#发布条例" class="headerlink" title="发布条例"></a>发布条例</h3>流程的建立很大程度上是对人的保护，遵循流程能有效程度上保护自己。</li><li>发布计划：列好发布计划，从 MR、代码到配置，使用发布标记记录每个发布时间点</li><li>发布透明：需要发的功能、bugfix和压测接口明确知会</li><li>做好灰度：发布的功能遵循一定规则灰度</li><li>立刻验证：发布后的第一时间线上验证，保证发布功能正常</li><li>留守保障：留守一定的时间，保证发布后无明显波动，方便有问题及时响应<br>核心思想: 规矩</li></ul><h2 id="事故与复盘"><a href="#事故与复盘" class="headerlink" title="事故与复盘"></a>事故与复盘</h2><p>在需求发布过程中，事故难免会发生。及时、正确的处理事故，在职场上是对自己的保护。同样能帮助自己更快的成长，减少相同错误的发生。</p><h3 id="透明原则"><a href="#透明原则" class="headerlink" title="透明原则"></a>透明原则</h3><p>事故发生后第一时间向上级汇报，并定时汇报进度，即便是自己闯出来的。遇到事故建议处理方式：</p><ul><li>事故发生时：<br>1、大群里艾特相关同学及上级，并同时电话上级，确认信息同步完全<br>2、能恢复立刻恢复<br>3、每隔几分钟向上汇报，即使没有进度<br>4、向上级寻求帮助，直到问题解决</li><li>事故发生后：反思与沉淀</li></ul><h3 id="处理事故的五要素"><a href="#处理事故的五要素" class="headerlink" title="处理事故的五要素"></a>处理事故的五要素</h3><ul><li>定义问题：能不能量化指标，比如出现路径、指标数据灯</li><li>发现问题：能不能有监控，及时和准确的告警</li><li>分析问题：能不能有工具辅助，提升分析问题的效率</li><li>解决问题：能不能第一时间修复，为用户解决问题</li><li>预防问题：能不能补充相关case，保证犯过的错误不再犯</li></ul><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>写到这里基本完成了，每个点笔者都亲身经历过也实践过。从“年轻”到“老”程序员，磨平了很多冲动与莽撞，沉淀了各个流程的“最佳实践”。如今带小朋友一起干活，对我而言，也是个全新的阶段。这篇文章也算为上阶段的思考做沉淀吧，也希望帮助到有需要的人。<br>感谢你阅读到这里。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/前端/font-end-optimize/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="gdccwxx"><meta itemprop="description" content><meta itemprop="image" content="/img/logo-gray.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="gdccwxx"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/前端/font-end-optimize/" itemprop="url">前端性能优化</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-11T23:46:04+08:00">2019-05-11</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="资源合并与压缩-http请求的过程及潜在的性能优化"><a href="#资源合并与压缩-http请求的过程及潜在的性能优化" class="headerlink" title="资源合并与压缩-http请求的过程及潜在的性能优化"></a>资源合并与压缩-http请求的过程及潜在的性能优化</h3><p>浏览器的一个请求从发送到返回都经历了什么</p><p><img src="/img/loading.gif" data-original="/前端/font-end-optimize/page-process.png" alt="http"></p><p>思考</p><ul><li>dns是否可以通过缓存减少dns查询时间？</li><li>网络请求的过程走最近的网络环境？</li><li>相同的静态资源是否可以缓存？</li><li>能否减少请求http请求大小？</li><li>减少http请求</li><li>服务端渲染<h2 id="重绘和回流"><a href="#重绘和回流" class="headerlink" title="重绘和回流"></a>重绘和回流</h2><h3 id="css会让JavaScript变慢吗"><a href="#css会让JavaScript变慢吗" class="headerlink" title="css会让JavaScript变慢吗"></a>css会让JavaScript变慢吗</h3>一个线程执行JavaScript<br>一个线程执行渲染<br>频繁触发重绘和回流，导致UI渲染频繁，最重导致js变慢<h3 id="啥是重绘和回流"><a href="#啥是重绘和回流" class="headerlink" title="啥是重绘和回流"></a>啥是重绘和回流</h3><h4 id="回流"><a href="#回流" class="headerlink" title="回流"></a>回流</h4></li><li>当render tree中的一部分或全部因为元素规模尺寸，布局，隐藏等改变需要重新构建，称作为回流（reflow）</li><li>当页面布局和几何属性变化时，就需要回流<h4 id="重绘"><a href="#重绘" class="headerlink" title="重绘"></a>重绘</h4>当render tree中的一些元素需要更新属性，而这些属性只是影响元素外观，风格，而不会影响布局的，比如background-color，则称之为重绘</li></ul><p>回流一定会重绘，重绘不一定会回流</p><h3 id="触发页面重布局的属性"><a href="#触发页面重布局的属性" class="headerlink" title="触发页面重布局的属性"></a>触发页面重布局的属性</h3><ul><li>盒子模型相关属性会触发重布局</li><li>定位属性及浮动会触发页面重布局</li><li>改变节点内部文字结构会触发重布局<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">width			top			text-align</span><br><span class="line">height			bottom		overflow-y</span><br><span class="line">padding			left		font-weight</span><br><span class="line">margin			right		overflow</span><br><span class="line">display			position	font-family</span><br><span class="line">border-width	float		line-height</span><br><span class="line">border			clear		vertical-align</span><br><span class="line">min-height					white-space</span><br><span class="line">							font-size</span><br></pre></td></tr></table></figure></li></ul><h3 id="触发页面重绘的属性"><a href="#触发页面重绘的属性" class="headerlink" title="触发页面重绘的属性"></a>触发页面重绘的属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">color				border-style</span><br><span class="line">border-radius		visibility</span><br><span class="line">text-decoration		background</span><br><span class="line">background-image	background-position</span><br><span class="line">background-repeat	background-size</span><br><span class="line">outline-color		outline</span><br><span class="line">outline-style		outline-width</span><br><span class="line">box-shadow</span><br></pre></td></tr></table></figure><h3 id="新建DOM过程"><a href="#新建DOM过程" class="headerlink" title="新建DOM过程"></a>新建DOM过程</h3><p>1、 获取DOM后分割为多个图层<br>2、 对每个图层的阶段计算样式结果(recalulate style — 样式重计算)<br>3、 为每个节点生成图形和位置(Layout— 回流和重布局)<br>4、 将每个节点绘制填充到图层位置中(Paint setup 和Paint — 重绘)<br>5、 图层作为纹理上传至gpu<br>6、 符合多个图层到页面上生成最终屏幕图像(composite layers — 图层重组)</p><h3 id="减少重绘和回流"><a href="#减少重绘和回流" class="headerlink" title="减少重绘和回流"></a>减少重绘和回流</h3><p>避免重绘回流的css<br>将频繁重绘和回流的dom元素单独作为独立图层，那么这个dom元素只会影响这个独立图层</p><h3 id="如何将DOM创建一个新的图层"><a href="#如何将DOM创建一个新的图层" class="headerlink" title="如何将DOM创建一个新的图层"></a>如何将DOM创建一个新的图层</h3><p>1、3D或者透视变化CSS属性(perspective transform)<br>2、 使用加速视屏解码的 video 节点<br>3、拥有3D(webGL)上下文或加速的2D上下文的 canvas 节点<br>4、混合插件(如flash)<br>5、对自己的opacity做css动画或使用一个动画webkit变换的元素<br>6、使用加速CSS过滤器的元素(translate3D..)<br>7、元素有一个包含复合层的后代节点(一个元素拥有一个子元素，该元素在自己的层里)<br>8、元素有一个z-index较低且包含一个符合层的兄弟元素(该元渲染在符合层上面渲染)</p><h3 id="避免重绘回流"><a href="#避免重绘回流" class="headerlink" title="避免重绘回流"></a>避免重绘回流</h3><p>1、用translate替代top：top会触发回流而translate不会<br>2、用opacity替代visibility：visibility会触发重绘而opacity不会<br>3、不要一条条修改DOM修改样式，可以放在一个class内，替换class<br>4、离线修改，使用display-none修改元素再显示<br>5、不要把DOM节点属性值放在一个循环里的变量里（offsetHight， offsetWidth）<br>6、不使用table布局，可能很小的修改导致整个table重新布局<br>7、动画实现的速度的选择<br>8、对于动画新建图层 (git图加上will-change, transform)<br>9、使用GPU硬件加速(trasform: translateZ, trasform: transform3d(0,0,0))</p><h2 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h2><ul><li>HTML5设计出来专门用于浏览器存储的</li><li>大小为5M左右</li><li>尽在客户端使用，不和服务端通信</li><li>接口封装比较好</li><li>浏览器本地缓存方案</li></ul><h2 id="SessionStorage"><a href="#SessionStorage" class="headerlink" title="SessionStorage"></a>SessionStorage</h2><ul><li>会话级别的浏览器存储</li><li>大小为5M左右</li><li>仅在客户端使用，不和服务器端通信</li><li>接口封装较好</li><li>对于表单信息的维护</li></ul><h2 id="indexDB"><a href="#indexDB" class="headerlink" title="indexDB"></a>indexDB</h2><ul><li>IndexedDB 是一种低级API，用于客户端存储大量结构化数据(包括, 文件/ blobs)。该API使用索引来实现对该数据的高性能搜索。虽然 Web Storage 对于存储较少量的数据很有用，但对于存储更大量的结构化数据来说，这种方法不太有用。IndexedDB提供了一个解决方案。</li><li>为应用创建离线版本</li></ul><h2 id="PWA"><a href="#PWA" class="headerlink" title="PWA"></a>PWA</h2><p>Progressive Web App, 简称 PWA，是提升 Web App 的体验的一种新方法，能给用户原生应用的体验。</p><p>PWA 能做到原生应用的体验不是靠特指某一项技术，而是经过应用一些新技术进行改进，在安全、性能和体验三个方面都有很大提升，PWA 本质上是 Web App，借助一些新技术也具备了 Native App 的一些特性，兼具 Web App 和 Native App 的优点。</p><p>PWA 的主要特点包括下面三点：</p><p>可靠 - 即使在不稳定的网络环境下，也能瞬间加载并展现<br>体验 - 快速响应，并且有平滑的动画响应用户的操作<br>粘性 - 像设备上的原生应用，具有沉浸式的用户体验，用户可以添加到桌面<br>PWA 本身强调渐进式，并不要求一次性达到安全、性能和体验上的所有要求，开发者可以通过 PWA Checklist 查看现有的特征。</p><h2 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h2><p>1、使用拦截和处理网络请求能力，实现离线应用<br>2、使用Service Worker在后台运行同时和页面通信的能力，趋势线大规模后台数据处理</p><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><h3 id="httpheader"><a href="#httpheader" class="headerlink" title="httpheader"></a>httpheader</h3><h4 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h4><ul><li>max-age=”seconds”<br>设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。与Expires相反，时间是相对于请求的时间。</li><li>s-maxage=”seconds”<br>覆盖max-age 或者 Expires 头，但是仅适用于共享缓存(比如各个代理)，并且私有缓存中它被忽略。</li><li>public<br>表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存。</li><li>private<br>表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）,可以缓存响应内容。</li><li>no-cache<br>在发布缓存副本之前，强制高速缓存将请求提交给原始服务器进行验证。</li><li>no-store<br>缓存不应存储有关客户端请求或服务器响应的任何内容。<h4 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h4></li><li>缓存过期时间，用来指定资源到期时间，是服务器端的具体的时间点</li><li>告诉浏览器在过期时间前浏览器可以直接从浏览器缓存去数据，无需再次请求<h4 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified/If-Modified-Since"></a>Last-Modified/If-Modified-Since</h4><h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5>The Last-Modified 是一个响应首部，其中包含源头服务器认定的资源做出修改的日期及时间。 它通常被用作一个验证器来判断接收到的或者存储的资源是否彼此一致<br>1、请求浏览器，给到缓存文件，response带有last-modified 给到浏览器存储为last-modified-since<br>2、浏览器再次请求文件，带有last-modiied-since, 服务器对比last-modified，若过期则给到新的文件，若不过期，则继续使用本地文件<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5>1、某些服务器不能获取精确的修改时间<br>2、文件修改时间改了，但文件内容却没有改变<h4 id="Etag-If-None-Match"><a href="#Etag-If-None-Match" class="headerlink" title="Etag/If-None-Match"></a>Etag/If-None-Match</h4></li><li>文件内容的hash值</li><li>etag——response header</li><li>if-none-match —— request header</li><li>需要和cache-control一起使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> ---------------------    </span><br><span class="line">					   当浏览器本地没有缓存或者下一层失效时，或者用户点击刷新</span><br><span class="line">\       200状态        /   浏览器直接去服务器下载最新数据</span><br><span class="line"></span><br><span class="line">  -------------------     </span><br><span class="line">					   这一层由 last-modified / Etag 控制,当下一层失效时，</span><br><span class="line">  \     304状态       /    或用户点击刷新，浏览器就会发送请求给服务器，如果文件无变</span><br><span class="line">					   化则返回304</span><br><span class="line">    ----------------      </span><br><span class="line">				       这层由expires/cache-control控制，expires(http 1.0     </span><br><span class="line">    \ 200(from disk) /    有效)是绝对时间，cache-control(http1.1版有效)相对</span><br><span class="line">					   时间，两者都存在，cache-control覆盖expires，没有失效</span><br><span class="line">      --------------      则直接访问自己缓存</span><br></pre></td></tr></table></figure></li></ul><p><img src="/img/loading.gif" data-original="/前端/font-end-optimize/font-end-cache.png" alt="Alt text"></p><h2 id="服务端性能优化"><a href="#服务端性能优化" class="headerlink" title="服务端性能优化"></a>服务端性能优化</h2><h3 id="多层次优化方案"><a href="#多层次优化方案" class="headerlink" title="多层次优化方案"></a>多层次优化方案</h3><ul><li>构建层模版编译</li><li>数据无关prerender方式</li><li>服务端渲染</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/img/logo-gray.jpg" alt="gdccwxx"><p class="site-author-name" itemprop="name">gdccwxx</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/gdccwxx" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:765553928@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">gdccwxx</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/exturl.js?v=5.1.4"></script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var e=r[a],t=e,n=function(){r=r.filter(function(t){return e!==t})},i=new Image,o=t.getAttribute("data-original");i.onload=function(){t.src=o,n()},t.src!==o&&(i.src=o)}()}o(),n.addEventListener("scroll",function(){var t=o,e=n;clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>